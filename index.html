<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#0d1a0f">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Football Oracle">
  <link rel="manifest" href="/manifest.json">
  <!-- iOS touch icons (Safari uses these for Add to Home Screen) -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%230d1a0f'/><text x='90' y='122' font-size='100' text-anchor='middle'>⚽</text></svg>">
  <!-- Status bar colour when launched from home screen -->
  <meta name="theme-color" content="#0d1a0f" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#f0f0e8" media="(prefers-color-scheme: light)">
<title>Football Oracle — Top 5 Leagues Analytics</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Barlow+Condensed:wght@300;400;500;600;700;900&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --pitch-dark: #0a1a0f;
    --pitch-mid: #0f2318;
    --pitch-green: #1a3a24;
    --pitch-line: #1e4d2b;
    --grass: #2d6a3f;
    --grass-light: #3d8a52;
    --gold: #f5c842;
    --gold-dim: #c9a228;
    --yellow-card: #f5c842;
    --red-card: #e63946;
    --red-dim: #9b2128;
    --white: #f0ede4;
    --white-dim: #a8a89a;
    --ink: #1a1a1a;
    --border: rgba(255,255,255,0.07);
    --card-bg: rgba(15,35,24,0.85);
    --card-hover: rgba(29,65,42,0.9);
    --shadow: 0 8px 32px rgba(0,0,0,0.5);
    --accent: #4ade80;
    --accent-dim: #22c55e;
    --pl: #3d0073;
    --ll: #d4000e;
    --sa: #0057a8;
    --bl: #d3010c;
    --l1: #003189;
  }

  /* ── LIGHT MODE ── */
  body.light-mode {
    --pitch-dark: #f0f4f0;
    --pitch-mid: #e8f0ea;
    --pitch-green: #d4e8d8;
    --pitch-line: #c0dcc6;
    --grass: #8fc49a;
    --card-bg: rgba(255,255,255,0.92);
    --card-hover: rgba(240,248,242,0.98);
    --border: rgba(0,0,0,0.1);
    --white: #1a2e1f;
    --white-dim: #4a6650;
    --shadow: 0 8px 32px rgba(0,0,0,0.12);
    background: #eef4f0;
    color: #1a2e1f;
  }
  body.light-mode::before { opacity: 0.3; }
  body.light-mode .header { background: linear-gradient(180deg,rgba(255,255,255,0.97) 0%,rgba(240,248,242,0.98) 100%); }
  body.light-mode .ticker { background: rgba(26,46,31,0.9); }
  body.light-mode .nav-tabs { background: rgba(255,255,255,0.95); border-color: rgba(0,0,0,0.1); }
  body.light-mode .data-table th { background: rgba(26,46,31,0.08); color: #1a2e1f; }
  body.light-mode .data-table td { border-color: rgba(0,0,0,0.06); }
  body.light-mode .modal { background: #fff; }
  body.light-mode .api-status-bar { background: rgba(255,255,255,0.9); border-color: rgba(0,0,0,0.1); }
  body.light-mode .suspension-panel { background: rgba(255,255,255,0.92); }

  /* ── TOP ASSISTS ── */
  .stat-bar-row { display:flex; align-items:center; gap:10px; padding:7px 0; border-bottom:1px solid var(--border); }
  .stat-bar-row:last-child { border-bottom:none; }
  .stat-bar-rank { font-family:'Barlow Condensed'; font-weight:700; font-size:.85rem; color:var(--white-dim); width:20px; text-align:right; flex-shrink:0; }
  .stat-bar-name { font-family:'Barlow Condensed'; font-weight:700; font-size:.95rem; flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .stat-bar-team { font-size:.72rem; color:var(--white-dim); }
  .stat-bar-val  { font-family:'Barlow Condensed'; font-weight:700; font-size:1.05rem; color:var(--gold); width:28px; text-align:right; flex-shrink:0; }
  .stat-bar-bg   { width:80px; background:rgba(255,255,255,0.07); border-radius:3px; height:6px; flex-shrink:0; overflow:hidden; }
  .stat-bar-fill { height:100%; border-radius:3px; background:linear-gradient(90deg,var(--accent),var(--gold)); }

  /* ── EUROPEAN TRACKER ── */
  .euro-fixture-card { background:rgba(255,255,255,0.04); border:1px solid var(--border); border-radius:8px; padding:14px 16px; margin-bottom:12px; }
  .euro-fixture-card:hover { border-color:var(--gold); background:rgba(255,200,50,0.04); }
  .euro-round-badge { display:inline-flex; align-items:center; gap:5px; font-family:'Barlow Condensed'; font-size:.72rem; font-weight:700; letter-spacing:1px; padding:2px 8px; border-radius:3px; background:rgba(100,160,255,0.15); color:#88bbff; border:1px solid rgba(100,160,255,0.25); margin-bottom:8px; }
  .euro-comp-ucl  { background:rgba(0,80,200,0.18); color:#6699ff; border-color:rgba(0,80,200,0.3); }
  .euro-comp-uel  { background:rgba(200,100,0,0.18); color:#ffaa44; border-color:rgba(200,100,0,0.3); }
  .euro-comp-uecl { background:rgba(0,160,80,0.18); color:#44dd88; border-color:rgba(0,160,80,0.3); }
  .euro-teams-row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .euro-team-name { font-family:'Barlow Condensed'; font-weight:700; font-size:1rem; }
  .euro-score-box { font-family:'Barlow Condensed'; font-weight:700; font-size:1.1rem; padding:4px 12px; background:rgba(255,255,255,0.07); border-radius:5px; min-width:60px; text-align:center; }
  .euro-meta { font-size:.72rem; color:var(--white-dim); margin-top:6px; display:flex; gap:12px; flex-wrap:wrap; }

  /* ── WEEKEND WRAP ── */
  .wrap-section { margin-bottom:24px; }
  .wrap-section-title { font-family:'Barlow Condensed'; font-weight:700; font-size:1rem; letter-spacing:1px; color:var(--gold); text-transform:uppercase; border-bottom:1px solid var(--border); padding-bottom:6px; margin-bottom:12px; }
  .wrap-result-row { display:flex; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(255,255,255,0.05); font-family:'Barlow Condensed'; }
  .wrap-result-row:last-child { border-bottom:none; }
  .wrap-score { font-size:1rem; font-weight:700; padding:2px 10px; background:rgba(255,255,255,0.07); border-radius:4px; }
  .wrap-shock { color:var(--red-card); font-size:.72rem; font-weight:700; margin-left:6px; }
  .wrap-highlight { display:flex; align-items:center; gap:10px; padding:8px 12px; background:rgba(255,200,50,0.07); border:1px solid rgba(255,200,50,0.15); border-radius:6px; margin-bottom:8px; font-family:'Barlow Condensed'; }
  .wrap-highlight-icon { font-size:1.3rem; flex-shrink:0; }
  .wrap-stat-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .wrap-stat-box { background:rgba(255,255,255,0.04); border:1px solid var(--border); border-radius:6px; padding:10px 12px; text-align:center; }
  .wrap-stat-val { font-family:'Barlow Condensed'; font-weight:700; font-size:1.4rem; color:var(--gold); }
  .wrap-stat-label { font-size:.72rem; color:var(--white-dim); margin-top:2px; }
  .wrap-no-data { text-align:center; padding:40px 20px; color:var(--white-dim); font-family:'Barlow Condensed'; letter-spacing:1px; }

  /* ── FAVOURITES ── */
  .fav-star { cursor:pointer; font-size:1rem; transition:transform .15s; user-select:none; padding:0 3px; }
  .fav-star:hover { transform:scale(1.3); }
  .fav-star.active { color:var(--gold); }
  .fav-star.inactive { color:var(--white-dim); opacity:0.4; }
  .fav-banner { background:linear-gradient(135deg,rgba(255,200,50,0.1),rgba(255,200,50,0.03)); border:1px solid rgba(255,200,50,0.2); border-radius:8px; padding:12px 16px; margin-bottom:16px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  .fav-team-chip { display:inline-flex; align-items:center; gap:6px; background:rgba(255,200,50,0.12); border:1px solid rgba(255,200,50,0.25); border-radius:20px; padding:4px 10px; font-family:'Barlow Condensed'; font-size:.82rem; font-weight:700; }
  .fav-chip-remove { cursor:pointer; color:var(--white-dim); font-size:.75rem; margin-left:2px; }
  .fav-chip-remove:hover { color:var(--red-card); }
  .fav-empty-hint { font-family:'Barlow Condensed'; font-size:.82rem; color:var(--white-dim); letter-spacing:.5px; }

  /* ── PWA install prompt ── */
  .pwa-prompt { position:fixed; bottom:20px; right:20px; background:var(--pitch-mid); border:1px solid var(--gold); border-radius:10px; padding:14px 18px; z-index:400; display:flex; align-items:center; gap:12px; box-shadow:0 8px 32px rgba(0,0,0,0.6); max-width:300px; animation:slideUp .35s ease; }
  @keyframes slideUp { from { transform:translateY(20px); opacity:0; } to { transform:translateY(0); opacity:1; } }
  .pwa-prompt-text { flex:1; font-family:'Barlow Condensed'; font-size:.88rem; }
  .pwa-prompt-title { font-weight:700; font-size:1rem; margin-bottom:2px; color:var(--gold); }
  .pwa-install-btn { background:var(--gold); color:#111; font-family:'Barlow Condensed'; font-weight:700; font-size:.82rem; letter-spacing:.5px; border:none; border-radius:5px; padding:6px 14px; cursor:pointer; white-space:nowrap; }
  .pwa-install-btn:hover { opacity:.85; }
  .pwa-dismiss { background:none; border:none; color:var(--white-dim); font-size:1.1rem; cursor:pointer; padding:0 4px; flex-shrink:0; }

  /* ══════════════════════════════════════════════
     WORLD CUP SECTION
  ══════════════════════════════════════════════ */
  .wc-hero {
    background: linear-gradient(135deg, #0a1a08 0%, #0d2a10 40%, #0a1a08 100%);
    border: 1px solid rgba(245,200,66,.2);
    border-radius: 14px;
    padding: 36px 32px 28px;
    margin-bottom: 24px;
    position: relative;
    overflow: hidden;
  }
  .wc-hero::before {
    content: '⚽';
    position: absolute;
    right: -10px; top: -20px;
    font-size: 140px;
    opacity: .04;
    pointer-events: none;
  }
  .wc-hero-title {
    font-family: 'Barlow Condensed'; font-weight: 900; font-size: 2.8rem;
    letter-spacing: 3px; text-transform: uppercase; color: var(--gold);
    line-height: 1; margin-bottom: 6px;
  }
  .wc-hero-sub {
    font-family: 'Barlow Condensed'; font-size: 1rem; letter-spacing: 2px;
    color: var(--white-dim); text-transform: uppercase; margin-bottom: 24px;
  }
  .wc-hero-stats {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 16px;
  }
  .wc-hero-stat {
    background: rgba(255,255,255,.04); border: 1px solid rgba(245,200,66,.12);
    border-radius: 10px; padding: 14px 16px; text-align: center;
  }
  .wc-hero-stat-val {
    font-family: 'Barlow Condensed'; font-weight: 700; font-size: 1.9rem;
    color: var(--gold); line-height: 1; margin-bottom: 4px;
  }
  .wc-hero-stat-label {
    font-family: 'Barlow Condensed'; font-size: .72rem; letter-spacing: 1.5px;
    color: var(--white-dim); text-transform: uppercase;
  }

  /* Filter bar */
  .wc-filter-bar {
    display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px;
  }
  .wc-filter-btn {
    font-family: 'Barlow Condensed'; font-size: .8rem; letter-spacing: 1px;
    text-transform: uppercase; padding: 6px 16px; border-radius: 20px;
    border: 1px solid rgba(255,255,255,.15); background: rgba(255,255,255,.05);
    color: var(--white-dim); cursor: pointer; transition: all .2s;
  }
  .wc-filter-btn:hover { border-color: var(--gold); color: var(--gold); }
  .wc-filter-btn.active { background: var(--gold); color: #111; border-color: var(--gold); font-weight: 700; }

  /* Champions bar */
  .wc-champions-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px; margin-bottom: 24px;
  }
  .wc-champion-card {
    background: rgba(255,255,255,.04); border: 1px solid rgba(245,200,66,.1);
    border-radius: 12px; padding: 16px 14px; text-align: center;
    transition: border-color .2s, transform .2s; cursor: default;
  }
  .wc-champion-card:hover { border-color: rgba(245,200,66,.4); transform: translateY(-2px); }
  .wc-champion-flag { font-size: 2rem; margin-bottom: 6px; }
  .wc-champion-country {
    font-family: 'Barlow Condensed'; font-weight: 700; font-size: 1rem;
    color: var(--white); letter-spacing: .5px;
  }
  .wc-champion-titles {
    font-family: 'Barlow Condensed'; font-size: .78rem; color: var(--gold);
    letter-spacing: 1px; margin: 4px 0 8px;
  }
  .wc-champion-years {
    font-size: .7rem; color: var(--white-dim); line-height: 1.5;
  }
  .wc-title-dot {
    display: inline-block; width: 10px; height: 10px; border-radius: 50%;
    background: var(--gold); margin: 0 2px;
  }

  /* Tournament timeline table */
  .wc-section-title {
    font-family: 'Barlow Condensed'; font-weight: 700; font-size: 1.1rem;
    letter-spacing: 2px; text-transform: uppercase; color: var(--gold);
    margin: 28px 0 14px; padding-bottom: 8px;
    border-bottom: 1px solid rgba(245,200,66,.2);
    display: flex; align-items: center; gap: 10px;
  }
  .wc-table-wrap { overflow-x: auto; margin-bottom: 28px; border-radius: 10px; }
  .wc-table {
    width: 100%; border-collapse: collapse; font-family: 'Barlow Condensed';
    font-size: .88rem; min-width: 700px;
  }
  .wc-table th {
    background: rgba(245,200,66,.1); color: var(--gold); font-size: .72rem;
    letter-spacing: 1.5px; text-transform: uppercase; padding: 10px 12px;
    text-align: left; border-bottom: 1px solid rgba(245,200,66,.2);
    white-space: nowrap;
  }
  .wc-table td {
    padding: 9px 12px; border-bottom: 1px solid rgba(255,255,255,.05);
    color: var(--white); vertical-align: middle;
  }
  .wc-table tr:hover td { background: rgba(255,255,255,.03); }
  .wc-table tr.wc-row-hidden { display: none; }
  .wc-year-badge {
    background: rgba(245,200,66,.12); color: var(--gold); font-weight: 700;
    font-size: .8rem; padding: 3px 8px; border-radius: 5px;
    display: inline-block; white-space: nowrap;
  }
  .wc-winner-chip {
    background: rgba(245,200,66,.15); border: 1px solid rgba(245,200,66,.3);
    color: var(--gold); font-weight: 700; padding: 2px 10px; border-radius: 12px;
    display: inline-block; white-space: nowrap;
  }
  .wc-score-pill {
    background: rgba(255,255,255,.07); border-radius: 6px;
    padding: 3px 9px; font-weight: 700; color: var(--white);
    white-space: nowrap; font-size: .83rem;
  }
  .wc-pen-tag {
    font-size: .68rem; color: var(--accent); margin-left: 4px;
    background: rgba(79,195,247,.1); padding: 1px 5px; border-radius: 4px;
  }
  .wc-aet-tag {
    font-size: .68rem; color: var(--white-dim); margin-left: 4px;
    background: rgba(255,255,255,.08); padding: 1px 5px; border-radius: 4px;
  }
  .wc-goals-num { color: var(--accent); font-weight: 700; }
  .wc-era-tag {
    font-size: .68rem; letter-spacing: .5px; padding: 2px 7px; border-radius: 4px;
    font-weight: 600;
  }
  .wc-era-early   { background: rgba(168,168,154,.1); color: var(--white-dim); }
  .wc-era-classic { background: rgba(79,195,247,.1);  color: var(--accent); }
  .wc-era-modern  { background: rgba(74,222,128,.1);  color: #4ade80; }
  .wc-era-recent  { background: rgba(245,200,66,.1);  color: var(--gold); }

  /* Top scorers */
  .wc-scorers-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 12px; margin-bottom: 28px;
  }
  .wc-scorer-card {
    background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08);
    border-radius: 10px; padding: 14px 16px; display: flex; gap: 12px;
    align-items: flex-start; transition: border-color .2s;
  }
  .wc-scorer-card:hover { border-color: rgba(245,200,66,.25); }
  .wc-scorer-rank {
    font-family: 'Barlow Condensed'; font-weight: 900; font-size: 1.5rem;
    color: rgba(245,200,66,.25); line-height: 1; min-width: 28px;
  }
  .wc-scorer-name {
    font-family: 'Barlow Condensed'; font-weight: 700; font-size: .95rem;
    color: var(--white); margin-bottom: 2px;
  }
  .wc-scorer-meta {
    font-size: .75rem; color: var(--white-dim); margin-bottom: 6px;
  }
  .wc-scorer-goals {
    display: inline-flex; align-items: center; gap: 4px;
    background: rgba(245,200,66,.12); border: 1px solid rgba(245,200,66,.2);
    color: var(--gold); font-family: 'Barlow Condensed'; font-weight: 700;
    font-size: .82rem; padding: 2px 9px; border-radius: 10px;
  }

  /* Hosts map */
  .wc-hosts-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 10px; margin-bottom: 28px;
  }
  .wc-host-card {
    background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.07);
    border-radius: 10px; padding: 12px 14px; transition: border-color .2s;
  }
  .wc-host-card:hover { border-color: rgba(79,195,247,.3); }
  .wc-host-country {
    font-family: 'Barlow Condensed'; font-weight: 700; font-size: .95rem;
    color: var(--white); margin-bottom: 4px;
  }
  .wc-host-years {
    font-size: .75rem; color: var(--white-dim); margin-bottom: 6px;
  }
  .wc-host-badge {
    font-size: .7rem; letter-spacing: .8px; font-family: 'Barlow Condensed';
    padding: 2px 8px; border-radius: 4px; font-weight: 600;
  }
  .wc-host-multi { background: rgba(79,195,247,.1); color: var(--accent); }
  .wc-host-once  { background: rgba(255,255,255,.07); color: var(--white-dim); }

  /* Rankings table */
  .wc-rankings-table { min-width: 500px; }
  .wc-rank-pos {
    font-family: 'Barlow Condensed'; font-weight: 900; font-size: 1.1rem;
    color: rgba(255,255,255,.3);
  }
  .wc-rank-pos.top3 { color: var(--gold); }
  .wc-conf-badge {
    font-size: .65rem; padding: 2px 6px; border-radius: 4px; font-weight: 600;
    font-family: 'Barlow Condensed'; letter-spacing: .5px;
  }
  .wc-conf-UEFA     { background: rgba(79,195,247,.12); color: var(--accent); }
  .wc-conf-CONMEBOL { background: rgba(245,200,66,.12); color: var(--gold); }
  .wc-conf-CAF      { background: rgba(74,222,128,.12); color: #4ade80; }
  .wc-conf-AFC      { background: rgba(168,168,154,.12); color: var(--white-dim); }
  .wc-conf-CONCACAF { background: rgba(255,80,80,.12);  color: #ff8080; }
  .wc-conf-OFC      { background: rgba(200,80,255,.12); color: #cc80ff; }

  /* Records panel */
  .wc-records-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 14px; margin-bottom: 28px;
  }
  .wc-record-card {
    background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.07);
    border-radius: 12px; padding: 16px 18px;
  }
  .wc-record-icon { font-size: 1.5rem; margin-bottom: 8px; }
  .wc-record-val {
    font-family: 'Barlow Condensed'; font-weight: 900; font-size: 1.6rem;
    color: var(--gold); line-height: 1; margin-bottom: 3px;
  }
  .wc-record-label {
    font-family: 'Barlow Condensed'; font-size: .78rem; color: var(--white-dim);
    letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px;
  }
  .wc-record-detail { font-size: .78rem; color: var(--white-dim); line-height: 1.5; }

  /* 2026 teaser */
  .wc-2026-banner {
    background: linear-gradient(135deg, rgba(245,200,66,.08) 0%, rgba(79,195,247,.05) 100%);
    border: 1px solid rgba(245,200,66,.25); border-radius: 14px;
    padding: 24px 28px; margin-bottom: 8px;
    display: flex; align-items: center; gap: 24px; flex-wrap: wrap;
  }
  .wc-2026-label {
    font-family: 'Barlow Condensed'; font-weight: 900; font-size: 2.2rem;
    color: var(--gold); letter-spacing: 3px;
  }
  .wc-2026-sub { font-family: 'Barlow Condensed'; font-size: .9rem; color: var(--white-dim); margin-top: 4px; }
  .wc-2026-hosts { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
  .wc-2026-host-chip {
    background: rgba(255,255,255,.07); border-radius: 20px; padding: 4px 14px;
    font-family: 'Barlow Condensed'; font-size: .82rem; color: var(--white);
  }

  /* ── iOS Add-to-Home-Screen hint sheet ── */
  .ios-hint-sheet {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: var(--pitch-mid);
    border-top: 1px solid var(--gold);
    border-radius: 18px 18px 0 0;
    padding: 20px 20px 32px;
    z-index: 500;
    box-shadow: 0 -8px 40px rgba(0,0,0,0.7);
    transform: translateY(100%);
    transition: transform .4s cubic-bezier(.32,1.2,.42,1);
    max-width: 500px;
    margin: 0 auto;
  }
  .ios-hint-sheet.visible { transform: translateY(0); }
  .ios-hint-handle {
    width: 36px; height: 4px; border-radius: 2px;
    background: rgba(255,255,255,0.2);
    margin: 0 auto 18px;
  }
  .ios-hint-title {
    font-family: 'Barlow Condensed'; font-weight: 700; font-size: 1.15rem;
    color: var(--gold); margin-bottom: 4px; text-align: center;
  }
  .ios-hint-sub {
    font-size: .78rem; color: var(--white-dim); text-align: center; margin-bottom: 20px;
  }
  .ios-hint-steps {
    display: flex; flex-direction: column; gap: 14px; margin-bottom: 20px;
  }
  .ios-hint-step {
    display: flex; align-items: flex-start; gap: 12px;
  }
  .ios-hint-step-num {
    width: 26px; height: 26px; border-radius: 50%;
    background: rgba(245,200,66,0.15); border: 1px solid rgba(245,200,66,0.35);
    color: var(--gold); font-family: 'Barlow Condensed'; font-weight: 700;
    font-size: .85rem; display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; margin-top: 1px;
  }
  .ios-hint-step-text {
    font-family: 'Barlow Condensed'; font-size: .9rem; line-height: 1.4;
    color: var(--white);
  }
  .ios-hint-step-text strong { color: var(--gold); }
  .ios-hint-share-icon {
    display: inline-flex; align-items: center; justify-content: center;
    width: 28px; height: 28px; border-radius: 6px;
    background: rgba(100,160,255,0.18); border: 1px solid rgba(100,160,255,0.3);
    vertical-align: middle; margin: 0 3px; flex-shrink: 0;
  }
  .ios-hint-footer {
    display: flex; align-items: center; justify-content: space-between; gap: 12px;
  }
  .ios-hint-dismiss {
    background: none; border: none; color: var(--white-dim);
    font-family: 'Barlow Condensed'; font-size: .82rem; cursor: pointer;
    padding: 8px 0; letter-spacing: .5px;
  }
  .ios-hint-dont-show {
    font-family: 'Barlow Condensed'; font-size: .78rem; color: var(--white-dim);
    display: flex; align-items: center; gap: 6px; cursor: pointer;
  }
  .ios-hint-dont-show input { accent-color: var(--gold); cursor: pointer; }
  /* Arrow pointing to Safari Share button at bottom of screen */
  .ios-hint-arrow {
    position: fixed; bottom: 0; left: 50%;
    transform: translateX(-50%);
    width: 0; height: 0;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-top: 12px solid var(--gold);
    z-index: 501;
    animation: arrowBounce 1.2s ease-in-out infinite;
    pointer-events: none;
    display: none;
  }
  @keyframes arrowBounce {
    0%, 100% { transform: translateX(-50%) translateY(0); }
    50%       { transform: translateX(-50%) translateY(6px); }
  }
  /* Backdrop behind sheet */
  .ios-hint-backdrop {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 499;
    opacity: 0; transition: opacity .3s; pointer-events: none;
  }
  .ios-hint-backdrop.visible { opacity: 1; pointer-events: all; }

  /* ── INJURY TRACKER ── */
  .injury-card { display:flex; align-items:center; gap:12px; padding:10px 0; border-bottom:1px solid var(--border); }
  .injury-card:last-child { border-bottom:none; }
  .injury-avatar { width:36px; height:36px; border-radius:50%; background:linear-gradient(135deg,var(--red-card),var(--red-dim)); display:flex; align-items:center; justify-content:center; font-family:'Barlow Condensed'; font-weight:700; font-size:1rem; color:#fff; flex-shrink:0; }
  .injury-name { font-family:'Barlow Condensed'; font-weight:700; font-size:.95rem; }
  .injury-meta { font-size:.75rem; color:var(--white-dim); margin-top:1px; }
  .injury-badge { font-family:'Barlow Condensed'; font-size:.72rem; font-weight:700; letter-spacing:1px; padding:2px 8px; border-radius:3px; white-space:nowrap; }
  .injury-badge.out   { background:rgba(230,57,70,0.2);   color:var(--red-card); }
  .injury-badge.doubt { background:rgba(245,200,66,0.15); color:var(--gold); }
  .injury-badge.knock { background:rgba(74,222,128,0.1);  color:var(--accent); }
  .injury-return { font-size:.72rem; color:var(--white-dim); font-family:'Barlow Condensed'; margin-top:2px; }

  /* ── FORM DOTS ENHANCED ── */
  .form-dot { width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:.65rem; font-weight:700; font-family:'Barlow Condensed'; color:#fff; flex-shrink:0; }
  .form-dot.W { background:var(--accent); }
  .form-dot.D { background:var(--gold); color:#1a1a1a; }
  .form-dot.L { background:var(--red-card); }
  .form-dots { display:flex; gap:3px; align-items:center; }
  .form-arrow-up   { color:var(--accent);   font-size:.85rem; font-weight:700; margin-left:4px; }
  .form-arrow-down { color:var(--red-card); font-size:.85rem; font-weight:700; margin-left:4px; }
  .form-arrow-same { color:var(--white-dim);font-size:.85rem; font-weight:700; margin-left:4px; }
  /* Form mini bars on fixture cards */
  .team-form-mini { display:flex; gap:2px; align-items:center; margin-top:4px; justify-content:center; }
  .form-dot-mini { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
  .form-dot-mini.W { background:var(--accent); }
  .form-dot-mini.D { background:var(--gold); }
  .form-dot-mini.L { background:var(--red-card); }

  /* ── ODDS DISPLAY ── */
  .odds-row { display:flex; gap:6px; margin-top:8px; }
  .odds-pill { flex:1; text-align:center; background:rgba(255,255,255,0.06); border:1px solid var(--border); border-radius:5px; padding:5px 4px; font-family:'Barlow Condensed'; }
  .odds-label { font-size:.65rem; color:var(--white-dim); letter-spacing:.5px; }
  .odds-val { font-size:1rem; font-weight:700; color:var(--gold); margin-top:1px; }
  .odds-best { font-size:.62rem; color:var(--white-dim); margin-top:1px; }

  /* ── POSITION MOVEMENT ── */
  .pos-move { display:inline-flex; align-items:center; gap:2px; font-size:.68rem; font-family:'Barlow Condensed'; font-weight:700; }
  .pos-move.up   { color:var(--accent); }
  .pos-move.down { color:var(--red-card); }
  .pos-move.same { color:var(--white-dim); }

  /* ── PLAYER SEARCH ── */
  .player-search-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:500; display:flex; align-items:flex-start; justify-content:center; padding-top:80px; }
  .player-search-box { background:var(--pitch-mid); border:1px solid var(--gold); border-radius:12px; width:min(600px,94vw); max-height:80vh; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 20px 60px rgba(0,0,0,0.8); }
  .player-search-header { padding:16px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; }
  .player-search-input-wrap { flex:1; position:relative; }
  .player-search-big { width:100%; background:transparent; border:none; outline:none; font-family:'Barlow Condensed'; font-size:1.2rem; font-weight:600; color:var(--white); letter-spacing:.5px; padding:4px 0; }
  .player-search-close { background:none; border:none; color:var(--white-dim); font-size:1.4rem; cursor:pointer; padding:4px 8px; }
  .player-search-results { overflow-y:auto; padding:12px 0; flex:1; }
  .player-result-item { padding:12px 20px; border-bottom:1px solid var(--border); cursor:pointer; transition:background .15s; }
  .player-result-item:hover { background:rgba(255,255,255,0.05); }
  .player-result-item:last-child { border-bottom:none; }
  .player-result-name { font-family:'Barlow Condensed'; font-weight:700; font-size:1.05rem; margin-bottom:4px; }
  .player-result-stats { display:flex; gap:16px; flex-wrap:wrap; font-size:.78rem; color:var(--white-dim); font-family:'Barlow Condensed'; }
  .player-result-stat { display:flex; align-items:center; gap:4px; }
  .player-result-stat strong { color:var(--white); }
  .player-search-empty { padding:40px 20px; text-align:center; color:var(--white-dim); font-family:'Barlow Condensed'; letter-spacing:1px; }

  /* ── THEME TOGGLE BUTTON ── */
  .theme-toggle {
    background: none; border: 1px solid var(--border); border-radius: 20px;
    color: var(--white-dim); cursor: pointer; padding: 5px 12px;
    font-family: 'Barlow Condensed', sans-serif; font-size: 0.82rem;
    letter-spacing: 1px; transition: all 0.2s; white-space: nowrap;
  }
  .theme-toggle:hover { border-color: var(--gold); color: var(--gold); }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Barlow', sans-serif;
    background: var(--pitch-dark);
    color: var(--white);
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
  }

  /* Pitch pattern background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      repeating-linear-gradient(
        0deg,
        transparent,
        transparent 60px,
        rgba(255,255,255,0.012) 60px,
        rgba(255,255,255,0.012) 61px
      ),
      repeating-linear-gradient(
        90deg,
        transparent,
        transparent 60px,
        rgba(255,255,255,0.008) 60px,
        rgba(255,255,255,0.008) 61px
      );
    pointer-events: none;
    z-index: 0;
  }

  .grass-stripes {
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      to bottom,
      rgba(45, 106, 63, 0.04) 0px,
      rgba(45, 106, 63, 0.04) 80px,
      rgba(35, 85, 50, 0.06) 80px,
      rgba(35, 85, 50, 0.06) 160px
    );
    pointer-events: none;
    z-index: 0;
  }

  #app { position: relative; z-index: 1; }

  /* ===== HEADER ===== */
  .header {
    background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(10,26,15,0.95) 100%);
    border-bottom: 2px solid var(--gold);
    padding: 0 24px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 4px 40px rgba(0,0,0,0.7);
  }

  .header-inner {
    max-width: 1600px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 12px 0;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-icon {
    width: 48px;
    height: 48px;
    position: relative;
    flex-shrink: 0;
  }

  .logo-icon svg { width: 100%; height: 100%; }

  .logo-text {
    font-family: 'Black Ops One', cursive;
    font-size: 1.9rem;
    color: var(--gold);
    letter-spacing: 1px;
    line-height: 1;
  }

  .logo-sub {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.7rem;
    font-weight: 500;
    letter-spacing: 4px;
    color: var(--white-dim);
    text-transform: uppercase;
  }

  .header-leagues {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-left: auto;
  }

  .league-badge {
    padding: 4px 12px;
    border-radius: 3px;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 0.78rem;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
    opacity: 0.65;
  }
  .league-badge.active { opacity: 1; border-color: rgba(255,255,255,0.3); }
  .league-badge.pl { background: rgba(61,0,115,0.6); color: #c8a8ff; }
  .league-badge.pl.active { background: #3d0073; color: #fff; }
  .league-badge.ll { background: rgba(212,0,14,0.4); color: #ffaaaa; }
  .league-badge.ll.active { background: var(--ll); color: #fff; }
  .league-badge.sa { background: rgba(0,87,168,0.4); color: #aac8ff; }
  .league-badge.sa.active { background: var(--sa); color: #fff; }
  .league-badge.bl { background: rgba(211,1,12,0.4); color: #ffaaaa; }
  .league-badge.bl.active { background: var(--bl); color: #fff; box-shadow: 0 0 0 1px rgba(255,220,0,0.5);}
  .league-badge.l1 { background: rgba(0,49,137,0.4); color: #aabfff; }
  .league-badge.l1.active { background: var(--l1); color: #fff; }

  .live-pulse {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.75rem;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 600;
    letter-spacing: 2px;
    color: var(--accent);
    margin-left: 8px;
  }

  /* ===== LIVE TAB ===== */
  .live-match-card {
    background: var(--pitch-mid);
    border: 1px solid rgba(245,200,66,0.15);
    border-radius: 8px;
    padding: 14px 16px;
    margin-bottom: 10px;
    transition: border-color .2s;
  }
  .live-match-card:hover { border-color: rgba(245,200,66,0.4); }
  .live-match-card.live-now { border-left: 3px solid var(--accent); }
  .live-match-card.finished { border-left: 3px solid rgba(255,255,255,0.15); }
  .live-match-card.upcoming { border-left: 3px solid var(--gold); }
  .live-match-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  .live-league-tag {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: .68rem;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--white-dim);
    background: rgba(255,255,255,0.06);
    padding: 2px 8px;
    border-radius: 3px;
  }
  .live-status-badge {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: .7rem;
    font-weight: 700;
    letter-spacing: 1px;
    padding: 2px 8px;
    border-radius: 3px;
  }
  .live-status-badge.live   { background: rgba(74,222,128,0.15); color: var(--accent); animation: pulse 1.5s ease-in-out infinite; }
  .live-status-badge.ft     { background: rgba(255,255,255,0.08); color: var(--white-dim); }
  .live-status-badge.sched  { background: rgba(245,200,66,0.12); color: var(--gold); }
  .live-teams {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    gap: 10px;
    text-align: center;
  }
  .live-team-name {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 1rem;
    letter-spacing: .5px;
  }
  .live-team-name.home { text-align: right; }
  .live-team-name.away { text-align: left; }
  .live-score {
    font-family: 'Black Ops One', monospace;
    font-size: 1.5rem;
    color: var(--gold);
    min-width: 60px;
    text-align: center;
  }
  .live-score.sched { font-size: 1rem; color: var(--white-dim); font-family: 'Barlow Condensed'; font-weight: 700; }
  .live-events {
    margin-top: 8px;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: .78rem;
    color: var(--white-dim);
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .live-event-pill {
    background: rgba(255,255,255,0.06);
    border-radius: 3px;
    padding: 1px 6px;
  }
  .live-event-pill.goal  { background: rgba(74,222,128,0.12); color: var(--accent); }
  .live-event-pill.red   { background: rgba(239,68,68,0.15); color: var(--red-card); }
  .live-event-pill.yellow { background: rgba(245,200,66,0.12); color: var(--gold); }
  .live-refresh-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding: 10px 14px;
    background: var(--pitch-mid);
    border-radius: 8px;
    border: 1px solid rgba(74,222,128,0.2);
  }
  .live-refresh-info {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: .82rem;
    color: var(--white-dim);
    letter-spacing: .5px;
  }
  .live-refresh-btn {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: .78rem;
    font-weight: 700;
    letter-spacing: 1px;
    background: rgba(74,222,128,0.12);
    color: var(--accent);
    border: 1px solid rgba(74,222,128,0.3);
    border-radius: 4px;
    padding: 4px 12px;
    cursor: pointer;
    transition: background .2s;
  }
  .live-refresh-btn:hover { background: rgba(74,222,128,0.25); }
  .live-countdown {
    font-family: 'Black Ops One', monospace;
    font-size: .8rem;
    color: var(--accent);
  }
  .live-section-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: .72rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--white-dim);
    margin: 20px 0 10px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    padding-bottom: 6px;
  }
  .live-empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--white-dim);
    font-family: 'Barlow Condensed', sans-serif;
    letter-spacing: 1px;
  }

  /* ===== ORACLE TIPS WIDGET ===== */
  .oracle-tip-card {
    background: linear-gradient(135deg, rgba(245,200,66,0.08) 0%, rgba(74,222,128,0.05) 100%);
    border: 1px solid rgba(245,200,66,0.25);
    border-radius: 6px;
    padding: 10px 14px;
    margin-bottom: 8px;
  }
  .oracle-tip-match {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: .92rem;
    margin-bottom: 2px;
  }
  .oracle-tip-pick {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: .8rem;
    color: var(--accent);
    font-weight: 600;
  }
  .oracle-tip-conf {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: .72rem;
    color: var(--white-dim);
    letter-spacing: .5px;
  }

  /* ===== FLASHSCORE FORM TOGGLE ===== */
  .fs-toggle-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 12px 0 20px;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: .85rem;
    color: var(--white-dim);
  }
  .fs-toggle {
    position: relative;
    width: 40px;
    height: 20px;
    flex-shrink: 0;
  }
  .fs-toggle input { display: none; }
  .fs-toggle-slider {
    position: absolute; inset: 0;
    background: rgba(255,255,255,0.12);
    border-radius: 10px;
    cursor: pointer;
    transition: background .2s;
  }
  .fs-toggle-slider:before {
    content: '';
    position: absolute;
    width: 14px; height: 14px;
    left: 3px; top: 3px;
    background: white;
    border-radius: 50%;
    transition: transform .2s;
  }
  .fs-toggle input:checked + .fs-toggle-slider { background: var(--accent); }
  .fs-toggle input:checked + .fs-toggle-slider:before { transform: translateX(20px); }
  .fs-form-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px; height: 20px;
    border-radius: 3px;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: .75rem;
  }
  .fs-form-badge.W { background: rgba(74,222,128,0.2); color: var(--accent); }
  .fs-form-badge.D { background: rgba(245,200,66,0.15); color: var(--gold); }
  .fs-form-badge.L { background: rgba(239,68,68,0.15); color: var(--red-card); }
  .fs-form-row {
    display: flex;
    gap: 3px;
    margin-top: 4px;
  }
  .fs-form-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: .72rem;
    color: var(--white-dim);
    letter-spacing: 1px;
    margin-bottom: 2px;
  }

  .pulse-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--accent);
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.3; transform: scale(0.7); }
  }

  /* ===== NAV TABS ===== */
  .nav-tabs {
    background: rgba(0,0,0,0.5);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    position: sticky;
    top: 73px;
    z-index: 90;
    backdrop-filter: blur(10px);
  }

  .nav-tabs-inner {
    max-width: 1600px;
    margin: 0 auto;
    display: flex;
    gap: 0;
    overflow-x: auto;
    scrollbar-width: none;
  }

  .nav-tab {
    padding: 14px 22px;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 600;
    font-size: 0.9rem;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--white-dim);
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .nav-tab:hover { color: var(--white); }
  .nav-tab.active { color: var(--gold); border-bottom-color: var(--gold); }

  /* ===== MAIN LAYOUT ===== */
  .main {
    max-width: 1600px;
    margin: 0 auto;
    padding: 24px;
  }

  /* ===== SECTION TITLE ===== */
  .section-header {
    display: flex;
    align-items: baseline;
    gap: 14px;
    margin-bottom: 20px;
  }

  .section-title {
    font-family: 'Black Ops One', cursive;
    font-size: 1.4rem;
    color: var(--white);
    letter-spacing: 1px;
  }

  .section-sub {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.8rem;
    font-weight: 500;
    letter-spacing: 3px;
    color: var(--white-dim);
    text-transform: uppercase;
  }

  /* ===== GRID ===== */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
  .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
  .grid-auto { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }

  @media (max-width: 1200px) {
    .grid-4 { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: 1fr 1fr; }
  }
  @media (max-width: 768px) {
    .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
  }

  /* ===== CARDS ===== */
  .card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 20px;
    transition: all 0.25s;
    position: relative;
    overflow: hidden;
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
    opacity: 0;
    transition: opacity 0.3s;
  }

  .card:hover { background: var(--card-hover); border-color: rgba(245,200,66,0.2); }
  .card:hover::before { opacity: 1; }

  .card-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 3px;
    color: var(--white-dim);
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .card-value {
    font-family: 'Black Ops One', cursive;
    font-size: 2.4rem;
    color: var(--white);
    line-height: 1;
    margin-bottom: 4px;
  }

  .card-value.gold { color: var(--gold); }
  .card-value.red { color: var(--red-card); }
  .card-value.green { color: var(--accent); }

  .card-detail {
    font-size: 0.8rem;
    color: var(--white-dim);
    font-family: 'Barlow', sans-serif;
  }

  /* ===== BOOKING CARD VISUAL ===== */
  .booking-card-visual {
    width: 28px;
    height: 38px;
    border-radius: 3px;
    display: inline-block;
    flex-shrink: 0;
    box-shadow: 2px 2px 6px rgba(0,0,0,0.5);
    position: relative;
  }
  .booking-card-visual.yellow { background: linear-gradient(135deg, #f5c842, #d4a820); }
  .booking-card-visual.red { background: linear-gradient(135deg, #e63946, #9b2128); }
  .booking-card-visual.both {
    background: linear-gradient(135deg, #f5c842 50%, #e63946 50%);
  }

  /* ===== FIXTURE CARD ===== */
  .fixture-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 16px 20px;
    transition: all 0.25s;
    cursor: pointer;
  }
  .fixture-card:hover { background: var(--card-hover); border-color: rgba(245,200,66,0.25); }

  .fixture-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .fixture-league-tag {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    padding: 2px 8px;
    border-radius: 2px;
  }

  .fixture-date {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.78rem;
    color: var(--white-dim);
    letter-spacing: 1px;
  }

  .fixture-teams {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 14px;
  }

  .fixture-team {
    flex: 1;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 1rem;
    letter-spacing: 0.5px;
  }

  .fixture-team.home { text-align: right; }
  .fixture-team.away { text-align: left; }

  .fixture-vs {
    font-family: 'Black Ops One', cursive;
    font-size: 0.85rem;
    color: var(--white-dim);
    padding: 4px 8px;
    background: rgba(255,255,255,0.05);
    border-radius: 3px;
    min-width: 50px;
    text-align: center;
  }

  .fixture-vs.result { color: var(--gold); font-size: 1rem; }

  .fixture-predictions {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    border-top: 1px solid var(--border);
    padding-top: 12px;
  }

  .pred-item {
    text-align: center;
  }

  .pred-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.65rem;
    font-weight: 600;
    letter-spacing: 2px;
    color: var(--white-dim);
    text-transform: uppercase;
    margin-bottom: 3px;
  }

  .pred-value {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 0.92rem;
    color: var(--white);
  }

  .pred-value.highlight { color: var(--gold); }
  .pred-value.danger { color: var(--red-card); }

  /* ===== PROBABILITY BARS ===== */
  .prob-bar-container {
    display: flex;
    gap: 3px;
    height: 6px;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 6px;
  }

  .prob-bar-h { background: var(--accent); transition: width 0.8s; border-radius: 3px 0 0 3px; }
  .prob-bar-d { background: var(--gold); transition: width 0.8s; }
  .prob-bar-a { background: var(--red-card); transition: width 0.8s; border-radius: 0 3px 3px 0; }

  .prob-labels {
    display: flex;
    justify-content: space-between;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.7rem;
    color: var(--white-dim);
    margin-top: 4px;
  }

  .prob-labels span:nth-child(1) { color: var(--accent); }
  .prob-labels span:nth-child(2) { color: var(--gold); }
  .prob-labels span:nth-child(3) { color: var(--red-card); }

  /* ===== TABLE ===== */
  .data-table {
    width: 100%;
    border-collapse: collapse;
    font-family: 'Barlow Condensed', sans-serif;
  }

  .data-table th {
    text-align: left;
    font-size: 0.68rem;
    font-weight: 700;
    letter-spacing: 2.5px;
    text-transform: uppercase;
    color: var(--white-dim);
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
  }

  .data-table th.num { text-align: center; }

  .data-table td {
    padding: 10px 12px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    font-size: 0.9rem;
    font-weight: 500;
    vertical-align: middle;
  }

  .data-table td.num { text-align: center; }

  .data-table tr:hover td { background: rgba(255,255,255,0.03); }

  .data-table tr.top-3 td:first-child { color: var(--gold); }

  .rank-num {
    font-family: 'Black Ops One', cursive;
    font-size: 1rem;
    color: var(--white-dim);
    min-width: 28px;
    text-align: center;
  }

  /* ===== BOOKING INDICATOR ===== */
  .booking-count {
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .card-icon {
    display: inline-block;
    width: 12px;
    height: 16px;
    border-radius: 1.5px;
  }
  .card-icon.y { background: var(--yellow-card); }
  .card-icon.r { background: var(--red-card); }

  /* ===== FORM DOTS ===== */
  .form-dots {
    display: flex;
    gap: 3px;
  }

  .form-dot {
    width: 20px;
    height: 20px;
    border-radius: 3px;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 0.72rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .form-dot.W { background: rgba(74,222,128,0.2); color: var(--accent); border: 1px solid rgba(74,222,128,0.4); }
  .form-dot.D { background: rgba(245,200,66,0.2); color: var(--gold); border: 1px solid rgba(245,200,66,0.4); }
  .form-dot.L { background: rgba(230,57,70,0.2); color: var(--red-card); border: 1px solid rgba(230,57,70,0.4); }

  /* ===== REFEREE TABLE ===== */
  .ref-strictness {
    height: 6px;
    border-radius: 3px;
    background: rgba(255,255,255,0.1);
    min-width: 100px;
    overflow: hidden;
    margin-top: 4px;
  }

  .ref-strictness-bar {
    height: 100%;
    border-radius: 3px;
    background: linear-gradient(90deg, var(--gold), var(--red-card));
    transition: width 1s;
  }

  /* ===== PREDICTION RECOMMENDATION ===== */
  .recommendation-card {
    background: linear-gradient(135deg, rgba(15,35,24,0.95), rgba(10,26,15,0.95));
    border: 1px solid rgba(245,200,66,0.3);
    border-radius: 6px;
    padding: 20px;
    position: relative;
    overflow: hidden;
  }

  .recommendation-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--gold), var(--red-card));
  }

  .rec-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 14px;
  }

  .rec-match {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--white);
  }

  .rec-league-tag {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.68rem;
    font-weight: 700;
    letter-spacing: 2px;
    padding: 3px 8px;
    border-radius: 2px;
    text-transform: uppercase;
  }

  .confidence-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 3px;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 0.75rem;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .confidence-badge.high { background: rgba(74,222,128,0.15); color: var(--accent); border: 1px solid rgba(74,222,128,0.3); }
  .confidence-badge.medium { background: rgba(245,200,66,0.15); color: var(--gold); border: 1px solid rgba(245,200,66,0.3); }
  .confidence-badge.low { background: rgba(255,255,255,0.05); color: var(--white-dim); border: 1px solid var(--border); }

  .rec-picks {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 12px;
  }

  .rec-pick {
    background: rgba(255,255,255,0.04);
    border-radius: 4px;
    padding: 10px 12px;
    border-left: 3px solid transparent;
  }

  .rec-pick.result { border-left-color: var(--accent); }
  .rec-pick.goals { border-left-color: var(--gold); }
  .rec-pick.cards { border-left-color: var(--yellow-card); }
  .rec-pick.player { border-left-color: var(--red-card); }

  .rec-pick-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 2.5px;
    color: var(--white-dim);
    text-transform: uppercase;
    margin-bottom: 3px;
  }

  .rec-pick-value {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 1rem;
    color: var(--white);
  }

  .rec-reasoning {
    font-size: 0.82rem;
    color: var(--white-dim);
    line-height: 1.5;
    border-top: 1px solid var(--border);
    padding-top: 10px;
  }

  /* ===== STANDINGS ===== */
  .standings-pos {
    font-family: 'Black Ops One', cursive;
    font-size: 1rem;
  }

  .standings-pos.cl { color: var(--accent); }
  .standings-pos.el { color: var(--gold-dim); }
  .standings-pos.rel { color: var(--red-card); }

  /* ===== LOADING ===== */
  .loading-ring {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(245,200,66,0.15);
    border-top-color: var(--gold);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 40px auto;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-container {
    text-align: center;
    padding: 60px;
    color: var(--white-dim);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.9rem;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  /* ===== API STATUS ===== */
  .api-status-bar {
    background: rgba(0,0,0,0.4);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 10px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 20px;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.78rem;
  }

  .api-status-label {
    color: var(--white-dim);
    letter-spacing: 1px;
  }

  .api-source {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 2px 8px;
    border-radius: 2px;
    background: rgba(255,255,255,0.05);
    cursor: pointer;
  }

  .api-source .dot { width: 6px; height: 6px; border-radius: 50%; }
  .dot.active { background: var(--accent); }
  .dot.demo { background: var(--gold); }
  .dot.error { background: var(--red-card); }

  .api-key-hint {
    margin-left: auto;
    font-size: 0.73rem;
    color: var(--gold);
    cursor: pointer;
    text-decoration: underline dotted;
  }

  /* ===== API CONFIG MODAL ===== */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    z-index: 200;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }

  .modal-overlay.hidden { display: none; }

  .modal {
    background: var(--pitch-mid);
    border: 1px solid rgba(245,200,66,0.3);
    border-radius: 8px;
    padding: 32px;
    max-width: 560px;
    width: 90%;
    position: relative;
  }

  .modal h3 {
    font-family: 'Black Ops One', cursive;
    color: var(--gold);
    margin-bottom: 8px;
    font-size: 1.3rem;
  }

  .modal p {
    font-size: 0.85rem;
    color: var(--white-dim);
    margin-bottom: 20px;
    line-height: 1.6;
  }

  .modal-close {
    position: absolute;
    top: 16px; right: 16px;
    background: none;
    border: none;
    color: var(--white-dim);
    font-size: 1.2rem;
    cursor: pointer;
    font-family: 'Barlow', sans-serif;
  }

  .api-input-group {
    margin-bottom: 16px;
  }

  .api-input-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 2px;
    color: var(--white-dim);
    text-transform: uppercase;
    margin-bottom: 6px;
    display: block;
  }

  .api-input {
    width: 100%;
    padding: 10px 12px;
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--white);
    font-family: 'Barlow', monospace;
    font-size: 0.85rem;
    outline: none;
    transition: border-color 0.2s;
  }

  .api-input:focus { border-color: var(--gold); }

  .btn {
    padding: 10px 24px;
    border-radius: 3px;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 0.85rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }

  .btn-gold { background: var(--gold); color: var(--ink); }
  .btn-gold:hover { background: var(--gold-dim); }
  .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--white-dim); }
  .btn-outline:hover { border-color: var(--gold); color: var(--gold); }

  /* ===== STAT PILLS ===== */
  .stat-pill {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 8px;
    border-radius: 2px;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 0.75rem;
    letter-spacing: 1px;
  }

  .stat-pill.warning { background: rgba(245,200,66,0.15); color: var(--gold); }
  .stat-pill.danger { background: rgba(230,57,70,0.15); color: var(--red-card); }
  .stat-pill.safe { background: rgba(74,222,128,0.15); color: var(--accent); }

  /* ===== TOP PLAYERS CARD ===== */
  .player-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }
  .player-row:last-child { border-bottom: none; }

  .player-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--pitch-line);
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Black Ops One', cursive;
    font-size: 0.8rem;
    color: var(--white-dim);
    flex-shrink: 0;
    border: 1px solid var(--border);
  }

  .player-name {
    flex: 1;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 0.92rem;
  }

  .player-team {
    font-size: 0.72rem;
    color: var(--white-dim);
    font-weight: 400;
    display: block;
  }

  .player-stat {
    font-family: 'Black Ops One', cursive;
    font-size: 1.2rem;
    min-width: 40px;
    text-align: right;
  }

  /* ===== WEEK PICKER ===== */
  .week-selector {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
  }

  .week-btn {
    width: 36px;
    height: 36px;
    border-radius: 3px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,0.05);
    color: var(--white);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    transition: all 0.2s;
  }
  .week-btn:hover { border-color: var(--gold); color: var(--gold); }

  .week-display {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 1rem;
    letter-spacing: 2px;
    color: var(--gold);
  }

  /* ===== SCROLL ANIMATIONS ===== */
  .fade-in {
    animation: fadeIn 0.4s ease forwards;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* ===== LEAGUE FILTER ROW ===== */
  .filter-row {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: center;
  }

  .filter-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 3px;
    color: var(--white-dim);
    text-transform: uppercase;
  }

  /* ===== TICKER ===== */
  .ticker {
    background: rgba(0,0,0,0.6);
    border-bottom: 1px solid var(--border);
    padding: 6px 0;
    overflow: hidden;
    white-space: nowrap;
  }

  .ticker-inner {
    display: inline-block;
    animation: ticker 360s linear infinite;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.82rem;
    font-weight: 500;
    letter-spacing: 1px;
  }

  .ticker-item {
    display: inline-block;
    padding: 0 40px;
    color: var(--white-dim);
  }

  .ticker-item .ticker-team { color: var(--white); font-weight: 700; }
  .ticker-item .ticker-score { color: var(--gold); font-weight: 700; }

  @keyframes ticker {
    from { transform: translateX(100vw); }
    to { transform: translateX(-100%); }
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
  ::-webkit-scrollbar-thumb { background: rgba(245,200,66,0.3); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: rgba(245,200,66,0.5); }

  .mb-20 { margin-bottom: 20px; }
  .mb-32 { margin-bottom: 32px; }

  .tag-pl { background: rgba(61,0,115,0.5); color: #d8b4ff; }
  .tag-ll { background: rgba(180,0,12,0.5); color: #ffaaaa; }
  .tag-sa { background: rgba(0,70,140,0.5); color: #aaccff; }
  .tag-bl { background: rgba(180,0,10,0.5); color: #ffaaaa; }
  .tag-l1 { background: rgba(0,40,120,0.5); color: #aabfff; }

  /* ── SUSPENSION TRACKER ── */
  .suspension-panel { background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border); padding: 20px; }
  .suspension-row { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .suspension-row:last-child { border-bottom: none; }
  .sus-player { flex: 1; }
  .sus-player-name { font-family: 'Barlow Condensed'; font-weight: 700; font-size: 1rem; }
  .sus-team { font-size: .75rem; color: var(--white-dim); }
  .sus-bar-wrap { flex: 2; }
  .sus-bar-track { background: rgba(255,255,255,0.08); border-radius: 4px; height: 8px; overflow: hidden; }
  .sus-bar-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; }
  .sus-bar-fill.safe { background: var(--accent); }
  .sus-bar-fill.warning { background: var(--gold); }
  .sus-bar-fill.danger { background: var(--red-card); }
  .sus-counts { font-family: 'Barlow Condensed'; font-size: .85rem; color: var(--white-dim); margin-top: 3px; }
  .sus-badge { font-family: 'Barlow Condensed'; font-size: .72rem; font-weight: 700; letter-spacing: 1px; padding: 2px 8px; border-radius: 3px; white-space: nowrap; }
  .sus-badge.safe { background: rgba(74,222,128,0.15); color: var(--accent); }
  .sus-badge.warning { background: rgba(245,200,66,0.15); color: var(--gold); }
  .sus-badge.danger { background: rgba(230,57,70,0.2); color: var(--red-card); }
  .sus-badge.suspended { background: rgba(230,57,70,0.35); color: #fff; }

  /* ── TEAM SEARCH ── */
  .team-search-wrap { position: relative; margin-bottom: 16px; }
  .team-search-input { width: 100%; background: rgba(255,255,255,0.06); border: 1px solid var(--border); border-radius: 6px; color: var(--white); font-family: 'Barlow', sans-serif; font-size: .9rem; padding: 9px 16px 9px 38px; outline: none; transition: border-color 0.2s; }
  .team-search-input:focus { border-color: var(--gold); }
  .team-search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--white-dim); font-size: 1rem; pointer-events: none; }
  body.light-mode .team-search-input { background: rgba(0,0,0,0.05); color: #1a2e1f; }

  /* ── LAST UPDATED ── */
  .last-updated { font-family: 'Barlow Condensed'; font-size: .75rem; color: var(--white-dim); letter-spacing: 1px; padding: 4px 12px; }

  /* ── H2H MINI TABLE ── */
  .h2h-mini { margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.25); border-radius: 6px; font-family: 'Barlow Condensed'; font-size: .8rem; }
  .h2h-mini-title { color: var(--gold); font-size: .72rem; letter-spacing: 1px; margin-bottom: 6px; }
  .h2h-result-row { display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--white-dim); }
  .h2h-result-row:last-child { border-bottom: none; }
  .h2h-score { color: var(--white); font-weight: 700; }

  /* ── TV CHANNEL BADGES ── */
  .tv-badge { display:inline-flex; align-items:center; gap:4px; font-family:'Barlow Condensed'; font-size:.7rem; font-weight:700; letter-spacing:.5px; padding:2px 7px; border-radius:3px; white-space:nowrap; }
  .tv-sky    { background:rgba(0,100,200,0.2); color:#4da6ff; border:1px solid rgba(0,100,200,0.3); }
  .tv-tnt    { background:rgba(200,0,0,0.2);   color:#ff6b6b; border:1px solid rgba(200,0,0,0.3); }
  .tv-premier{ background:rgba(180,0,180,0.2); color:#e070e0; border:1px solid rgba(180,0,180,0.3); }
  .tv-dazn   { background:rgba(0,180,80,0.2);  color:#4ade80; border:1px solid rgba(0,180,80,0.3); }
  .tv-ligue1 { background:rgba(0,50,200,0.2);  color:#6090ff; border:1px solid rgba(0,50,200,0.3); }
  .tv-bbc    { background:rgba(200,150,0,0.2); color:#f5c842; border:1px solid rgba(200,150,0,0.3); }
  .tv-free   { background:rgba(100,100,100,0.2);color:#a8a89a;border:1px solid rgba(100,100,100,0.3); }

  /* ── EXPORT CARD ── */
  .export-btn { background: linear-gradient(135deg,var(--gold),var(--gold-dim)); color: #1a1a1a; border: none; border-radius: 6px; padding: 8px 18px; font-family: 'Barlow Condensed'; font-size: .85rem; font-weight: 700; letter-spacing: 1.5px; cursor: pointer; transition: opacity 0.2s; }
  .export-btn:hover { opacity: 0.85; }

  /* ── MOBILE IMPROVEMENTS ── */
  @media (max-width: 640px) {
    .header-leagues { display: none; }
    .grid-2 { grid-template-columns: 1fr !important; }
    .grid-4 { grid-template-columns: 1fr 1fr !important; }
    .fixture-teams { font-size: 0.85rem; gap: 6px; }
    .fixture-team { font-size: 0.82rem; }
    .data-table { font-size: 0.78rem; }
    .data-table th, .data-table td { padding: 6px 8px; }
    .rec-picks { grid-template-columns: 1fr 1fr !important; }
    .week-selector { flex-wrap: wrap; justify-content: center; }
    .nav-tabs-inner { gap: 0; }
    .nav-tab { padding: 12px 10px; font-size: .75rem; letter-spacing: 0; }
    .sus-bar-wrap { display: none; }
    .card { padding: 16px; }
  }

  .section-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--border), transparent);
    margin: 32px 0;
  }

  .hidden { display: none; }

  .info-box {
    background: rgba(245,200,66,0.07);
    border: 1px solid rgba(245,200,66,0.2);
    border-radius: 4px;
    padding: 14px 18px;
    margin-bottom: 20px;
    font-family: 'Barlow', sans-serif;
    font-size: 0.82rem;
    color: var(--white-dim);
    line-height: 1.6;
  }

  .info-box a { color: var(--gold); }

  .tab-content { display: none; }
  .tab-content.active { display: block; }
</style>
</head>
<body>
<div class="grass-stripes"></div>
<div id="app">

  <!-- API Config Modal -->
  <div class="modal-overlay hidden" id="apiModal">
    <div class="modal">
      <button class="modal-close" onclick="document.getElementById('apiModal').classList.add('hidden')">✕</button>
      <h3>⚙ API Configuration</h3>
      <p>Football Oracle is connected to live APIs. Your keys are pre-loaded. You can update them below — data refreshes on save. Live standings, fixtures and predictions pull from Football-Data.org v4 and Bzzoiro Sports API in real time.</p>
      
      <div class="api-input-group">
        <label class="api-input-label">🔑 Football-Data.org API Key (Free — <a href="https://www.football-data.org/client/register" target="_blank" style="color:var(--gold)">Register here</a>)</label>
        <input class="api-input" id="fdKey" placeholder="Enter your token..." value="">
        <p style="font-size:0.72rem;color:var(--white-dim);margin-top:4px;">Provides: Results, Fixtures, Standings, Scorers for all 5 leagues</p>
      </div>

      <div class="api-input-group">
        <label class="api-input-label">🔑 Bzzoiro Sports API Key (Free — <a href="https://sports.bzzoiro.com/register/" target="_blank" style="color:var(--gold)">Register here</a>)</label>
        <input class="api-input" id="bzKey" placeholder="Enter your token..." value="">
        <p style="font-size:0.72rem;color:var(--white-dim);margin-top:4px;">Provides: ML Predictions, Player Stats, Cards & Bookings, Live Scores</p>
      </div>

      <div style="display:flex;gap:10px;margin-top:20px;">
        <button class="btn btn-gold" onclick="saveApiKeys()">Save & Refresh Data</button>
        <button class="btn btn-outline" onclick="document.getElementById('apiModal').classList.add('hidden')">Cancel</button>
        <button class="btn btn-gold" onclick="runApiDiagnostics()" style="margin-left:8px">🔍 Test APIs Now</button>
      </div>
      <div id="apiDiagPanel" style="display:none;margin-top:16px;background:rgba(0,0,0,0.4);border-radius:6px;padding:14px;font-family:monospace;font-size:.8rem;line-height:1.8;color:var(--white);">
        <div style="color:var(--gold);font-weight:700;margin-bottom:8px;">🔍 API DIAGNOSTICS</div>
        <div id="diagLog" style="white-space:pre-wrap;max-height:320px;overflow-y:auto;"></div>
      </div>
      <!-- diagnostics panel end -->
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-inner">
      <div class="logo">
        <div class="logo-icon">
          <svg viewBox="0 0 48 48" fill="none">
            <circle cx="24" cy="24" r="22" stroke="#f5c842" stroke-width="2" fill="none"/>
            <circle cx="24" cy="24" r="10" stroke="#f5c842" stroke-width="1.5" fill="none"/>
            <path d="M24 2 L24 14 M24 34 L24 46 M2 24 L14 24 M34 24 L46 24 M7.5 7.5 L16 16 M32 32 L40.5 40.5 M40.5 7.5 L32 16 M16 32 L7.5 40.5" stroke="#f5c842" stroke-width="1.5" opacity="0.5"/>
            <circle cx="24" cy="24" r="3" fill="#f5c842"/>
          </svg>
        </div>
        <div>
          <div class="logo-text">FOOTBALL ORACLE</div>
          <div class="logo-sub">Top 5 European Leagues · 2025–26</div>
        </div>
      </div>

      <div class="header-leagues" id="leagueFilters">
        <div class="league-badge pl active" onclick="toggleLeague('pl')">🏴󠁧󠁢󠁥󠁮󠁧󠁿 Premier League</div>
        <div class="league-badge ll active" onclick="toggleLeague('ll')">🇪🇸 La Liga</div>
        <div class="league-badge sa active" onclick="toggleLeague('sa')">🇮🇹 Serie A</div>
        <div class="league-badge bl active" onclick="toggleLeague('bl')">🇩🇪 Bundesliga</div>
        <div class="league-badge l1 active" onclick="toggleLeague('l1')">🇫🇷 Ligue 1</div>
      </div>

      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:1px;">
          <span class="last-updated" id="lastUpdated" style="font-size:.7rem;"></span>
          <span class="last-updated" id="nextRefreshLabel" style="font-size:.65rem;opacity:.6;"></span>
        </div>
        <button class="theme-toggle" id="refreshBtn" onclick="manualRefresh()" title="Refresh all data now" style="padding:5px 10px;font-size:.78rem;">🔄 Refresh</button>
        <button class="theme-toggle" onclick="openPlayerSearch()" style="padding:5px 10px;font-size:.78rem;">🔍 Players</button>
        <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn" style="padding:5px 10px;font-size:.78rem;">☀️ Light</button>
        <div class="live-pulse">
          <div class="pulse-dot" id="livePulseDot"></div>
          <span id="liveLabel">LIVE</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Results Ticker -->
  <div class="ticker">
    <div class="ticker-inner" id="tickerContent">Loading latest results...</div>
  </div>

  <!-- Nav Tabs -->
  <nav class="nav-tabs">
    <div class="nav-tabs-inner">
      <div class="nav-tab active" onclick="switchTab('overview')">📊 Overview</div>
      <div class="nav-tab" onclick="switchTab('live')" id="navTabLive">⚡ Live</div>
      <div class="nav-tab" onclick="switchTab('fixtures')">📅 Fixtures & Results</div>
      <div class="nav-tab" onclick="switchTab('predictions')">🎯 Predictions</div>
      <div class="nav-tab" onclick="switchTab('bookings')">🟨 Bookings & Cards</div>
      <div class="nav-tab" onclick="switchTab('injuries')">🏥 Injuries</div>
      <div class="nav-tab" onclick="switchTab('europe')">🏆 Europe</div>
      <div class="nav-tab" onclick="switchTab('wrap')">📰 Weekend Wrap</div>
      <div class="nav-tab" onclick="switchTab('favourites')">⭐ My Teams</div>
      <div class="nav-tab" onclick="switchTab('referees')">👮 Referees</div>
      <div class="nav-tab" onclick="switchTab('worldcup')">🌍 World Cup</div>
      <div class="nav-tab" onclick="switchTab('suspensions')">🚨 Suspensions</div>
      <div class="nav-tab" onclick="switchTab('standings')">🏆 Standings</div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main">

    <!-- API Status Bar -->
    <div class="api-status-bar">
      <span class="api-status-label">DATA SOURCES:</span>
      <div class="api-source">
        <div class="dot" id="fdStatus" style="background:var(--gold)"></div>
        <span id="fdLabel">Football-Data.org — Connecting…</span>
      </div>
      <div class="api-source">
        <div class="dot" id="bzStatus" style="background:var(--gold)"></div>
        <span id="bzLabel">Bzzoiro Sports API — Connecting…</span>
      </div>
      <div class="api-source">
        <div class="dot" id="afStatus" style="background:var(--gold)"></div>
        <span id="afLabel">API-Football — Connecting…</span>
      </div>
      <span class="api-key-hint" onclick="document.getElementById('apiModal').classList.remove('hidden')">⚙ Configure API Keys →</span>
    </div>

    <!-- OVERVIEW TAB -->
    <div class="tab-content active" id="tab-overview">
      
      <div class="section-header mb-20">
        <span class="section-title">Season At A Glance</span>
        <span class="section-sub">2024-25 · All Leagues</span>
      </div>

      <!-- KPI Row -->
      <div class="grid-4 mb-32" id="kpiRow">
        <div class="card fade-in">
          <div class="card-label">Total Matches Played</div>
          <div class="card-value gold" id="kpiMatches">—</div>
          <div class="card-detail">Across 5 leagues this season</div>
        </div>
        <div class="card fade-in" style="animation-delay:.05s">
          <div class="card-label">Avg Goals Per Game</div>
          <div class="card-value green" id="kpiGoals">—</div>
          <div class="card-detail">Season average 2024-25</div>
        </div>
        <div class="card fade-in" style="animation-delay:.1s">
          <div class="card-label">Yellow Cards Issued</div>
          <div class="card-value" style="color:var(--yellow-card)" id="kpiYellow">—</div>
          <div class="card-detail" id="kpiYellowPG">— per game average</div>
        </div>
        <div class="card fade-in" style="animation-delay:.15s">
          <div class="card-label">Red Cards Issued</div>
          <div class="card-value red" id="kpiRed">—</div>
          <div class="card-detail" id="kpiRedPG">— per game average</div>
        </div>
      </div>

      <div class="grid-2 mb-32">
        <!-- League Summary -->
        <div class="card fade-in">
          <div class="section-header mb-20">
            <span class="section-title">League Summaries</span>
          </div>
          <table class="data-table" id="leagueSummaryTable">
            <thead>
              <tr>
                <th>League</th>
                <th class="num">Played</th>
                <th class="num">Avg Goals</th>
                <th class="num">🟨/game</th>
                <th class="num">🟥/game</th>
                <th class="num">Strictness</th>
              </tr>
            </thead>
            <tbody id="leagueSummaryBody"></tbody>
          </table>
        </div>

        <!-- Top Booked Teams -->
        <div class="card fade-in" style="animation-delay:.1s">
          <div class="section-header mb-20">
            <span class="section-title">Most Booked Teams</span>
            <span class="section-sub">Season 2024-25</span>
          </div>
          <table class="data-table" id="topBookedTeamsTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Team</th>
                <th class="num">🟨</th>
                <th class="num">🟥</th>
                <th class="num">Points</th>
              </tr>
            </thead>
            <tbody id="topBookedTeamsBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Top scorers + Top Assists -->
      <div class="grid-2 mb-32">
        <div class="card fade-in">
          <div class="section-header mb-20">
            <span class="section-title">Top Scorers</span>
            <span class="section-sub">All Leagues 2024-25</span>
          </div>
          <div id="topScorersList"></div>
        </div>

        <div class="card fade-in" style="animation-delay:.08s">
          <div class="section-header mb-20">
            <span class="section-title">Top Assists</span>
            <span class="section-sub">All Leagues 2024-25</span>
          </div>
          <div id="topAssistsList"></div>
        </div>
      </div>

      <!-- Most Booked Players -->
      <div class="grid-2 mb-32">
        <div class="card fade-in">
          <div class="section-header mb-20">
            <span class="section-title">Most Booked Players</span>
            <span class="section-sub">Yellow cards this season</span>
          </div>
          <div id="topBookedPlayersList"></div>
        </div>
        <div class="card fade-in" style="animation-delay:.08s">
          <div class="section-header mb-20">
            <span class="section-title">⭐ My Teams — Next Up</span>
            <span class="section-sub">Star teams in Fixtures to track them here</span>
          </div>
          <div id="favNextFixtures"></div>
        </div>
      </div>

      <!-- Oracle Tips Widget -->
      <div class="card mb-32 fade-in" id="oracleTipsCard">
        <div class="section-header mb-16" style="justify-content:space-between;align-items:center;">
          <div>
            <span class="section-title">🎯 Oracle Tips — This Week</span>
            <span class="section-sub">Top confidence picks from the Predictions engine</span>
          </div>
          <button class="export-btn" onclick="switchTab('predictions')">See All Picks →</button>
        </div>
        <div id="oracleTipsList" class="grid-2"></div>
      </div>

    </div>

    <!-- LIVE SCORES TAB -->
    <div class="tab-content" id="tab-live">
      <div class="section-header mb-16" style="justify-content:space-between;align-items:center;">
        <div>
          <span class="section-title">⚡ Live Scores</span>
          <span class="section-sub">Real-time data via FlashScore · Auto-refreshes every 5 min</span>
        </div>
        <div class="live-pulse"><div class="pulse-dot"></div><span>LIVE</span></div>
      </div>

      <div class="live-refresh-bar">
        <div class="live-refresh-info">
          <span>Next refresh in </span><span class="live-countdown" id="liveCountdown">5:00</span>
          <span id="liveLastFetch" style="margin-left:12px;font-size:.75rem;"></span>
        </div>
        <button class="live-refresh-btn" onclick="fetchLiveScores(true)">↻ Refresh Now</button>
      </div>

      <div id="liveMatchesWrap">
        <div class="live-empty">⚡ Loading live scores…</div>
      </div>
    </div>

    <!-- EUROPEAN TRACKER TAB -->
    <div class="tab-content" id="tab-europe">
      <div class="section-header">
        <span class="section-title">European Nights</span>
        <span class="section-sub">UCL · UEL · UECL — Clubs from the Big 5</span>
      </div>
      <div class="info-box" style="margin-bottom:20px;">
        <strong style="color:var(--gold)">🏆 Coverage:</strong>
        Champions League, Europa League and Conference League fixtures involving clubs from the Premier League, La Liga, Serie A, Bundesliga and Ligue 1. Results and upcoming ties. Live data via API-Football.
      </div>
      <div class="filter-row mb-20">
        <span class="filter-label">Competition:</span>
        <div class="league-badge active" id="euroFilterAll"  onclick="filterEurope('all',this)"  style="background:rgba(100,160,255,0.15);color:#88bbff;border-color:rgba(100,160,255,0.3);">All</div>
        <div class="league-badge"        id="euroFilterUCL"  onclick="filterEurope('ucl',this)"  style="background:rgba(0,80,200,0.12);color:#6699ff;border-color:rgba(0,80,200,0.25);">⭐ UCL</div>
        <div class="league-badge"        id="euroFilterUEL"  onclick="filterEurope('uel',this)"  style="background:rgba(200,100,0,0.12);color:#ffaa44;border-color:rgba(200,100,0,0.25);">🟠 UEL</div>
        <div class="league-badge"        id="euroFilterUECL" onclick="filterEurope('uecl',this)" style="background:rgba(0,160,80,0.12);color:#44dd88;border-color:rgba(0,160,80,0.25);">🟢 UECL</div>
      </div>
      <div id="euroFixturesGrid"></div>
    </div>

    <!-- WEEKEND WRAP TAB -->
    <div class="tab-content" id="tab-wrap">
      <div class="section-header">
        <span class="section-title">Weekend Wrap</span>
        <span class="section-sub">Latest matchweek round-up — auto-generated from results</span>
      </div>
      <div id="wrapContent"></div>
    </div>

    <!-- MY TEAMS / FAVOURITES TAB -->
    <div class="tab-content" id="tab-favourites">
      <div class="section-header" style="justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
        <div>
          <span class="section-title">⭐ My Teams</span>
          <span class="section-sub">Star up to 5 teams — personalised fixtures, alerts &amp; suspension watch</span>
        </div>
        <button class="export-btn" onclick="clearFavourites()" style="margin-left:auto;">🗑 Clear All</button>
      </div>

      <div id="favBanner" class="fav-banner" style="display:none">
        <span style="font-family:'Barlow Condensed';font-weight:700;color:var(--gold);">TRACKING:</span>
        <div id="favChips"></div>
      </div>
      <div id="favEmptyHint" class="fav-banner">
        <span class="fav-empty-hint">⭐ Click the star ★ on any fixture card or below to follow a team. Up to 5 teams tracked.</span>
      </div>

      <div class="grid-2 mb-24">
        <div class="card">
          <div class="section-header mb-16"><span class="section-title">Upcoming Fixtures</span></div>
          <div id="favUpcomingFixtures"></div>
        </div>
        <div class="card">
          <div class="section-header mb-16"><span class="section-title">Recent Results</span></div>
          <div id="favRecentResults"></div>
        </div>
      </div>

      <div class="card mb-24">
        <div class="section-header mb-16">
          <span class="section-title">🚨 Suspension Watch</span>
          <span class="section-sub">My teams only</span>
        </div>
        <div id="favSuspensionWatch"></div>
      </div>

      <div class="card mb-24">
        <div class="section-header mb-16"><span class="section-title">All Teams — Click to Follow</span></div>
        <div id="allTeamsPicker" style="display:flex;flex-wrap:wrap;gap:8px;padding:4px 0;"></div>
      </div>
    </div>

    <!-- FIXTURES & RESULTS TAB -->
    <div class="tab-content" id="tab-fixtures">
      <div class="section-header">
        <span class="section-title">Fixtures & Results</span>
        <span class="section-sub">2024-25 Season</span>
      </div>

      <div class="team-search-wrap">
        <span class="team-search-icon">🔍</span>
        <input class="team-search-input" id="teamSearchInput" placeholder="Search by team name…" oninput="filterByTeam(this.value)">
      </div>
      <div class="filter-row mb-20">
        <span class="filter-label">Filter:</span>
        <div class="league-badge pl active" onclick="filterFixtures('pl',this)">Premier League</div>
        <div class="league-badge ll active" onclick="filterFixtures('ll',this)">La Liga</div>
        <div class="league-badge sa active" onclick="filterFixtures('sa',this)">Serie A</div>
        <div class="league-badge bl active" onclick="filterFixtures('bl',this)">Bundesliga</div>
        <div class="league-badge l1 active" onclick="filterFixtures('l1',this)">Ligue 1</div>
        <div style="margin-left:auto;display:flex;gap:8px;">
          <button class="btn btn-outline" onclick="showTab('upcoming')" id="btnUpcoming" style="padding:6px 14px;font-size:0.78rem;">📅 Upcoming</button>
          <button class="btn btn-outline" onclick="showTab('results')" id="btnResults" style="padding:6px 14px;font-size:0.78rem;">✅ Results</button>
        </div>
      </div>

      <div id="fixturesGrid" class="grid-auto"></div>
    </div>

    <!-- PREDICTIONS TAB -->
    <div class="tab-content" id="tab-predictions">
      <div class="section-header" style="justify-content:space-between;align-items:center;">
        <div>
          <span class="section-title">Weekly Predictions</span>
          <span class="section-sub">AI-Powered Picks · 2024-25</span>
        </div>
        <button class="export-btn" onclick="exportPredictionsCard()" style="margin-left:auto;">📋 Copy Picks Card</button>
      </div>

      <div class="info-box">
        <strong style="color:var(--gold)">🎯 How Predictions Work:</strong> Each prediction combines team form (last 6 games), head-to-head record, goals per game, home/away advantage, referee booking tendency, and player suspension risk. Confidence levels: <span style="color:var(--accent)">HIGH (>70%)</span> · <span style="color:var(--gold)">MEDIUM (50-70%)</span> · <span style="color:var(--white-dim)">LOW (<50%)</span>. These are analytical aids — not financial advice.
      </div>

      <div class="week-selector">
        <button class="week-btn" onclick="changeWeek(-1)">‹</button>
        <span class="week-display" id="weekDisplay">MATCHWEEK 26</span>
        <button class="week-btn" onclick="changeWeek(1)">›</button>
        <span class="section-sub" style="margin-left:8px;" id="weekDateRange"></span>
      </div>

      <div class="fs-toggle-row">
        <label class="fs-toggle">
          <input type="checkbox" id="fsFormToggle" onchange="toggleFSForm(this.checked)">
          <span class="fs-toggle-slider"></span>
        </label>
        <span>Enrich with FlashScore live form <span style="color:var(--accent);font-weight:700;">(last 5 results)</span></span>
        <span id="fsFormStatus" style="font-size:.72rem;color:var(--white-dim);margin-left:6px;"></span>
      </div>

      <div id="predictionsGrid" class="grid-2"></div>
    </div>

    <!-- INJURY TRACKER TAB -->
    <div class="tab-content" id="tab-injuries">
      <div class="section-header">
        <span class="section-title">Injury Tracker</span>
        <span class="section-sub">Player availability — 2024-25</span>
      </div>

      <div class="info-box" style="margin-bottom:20px;">
        <strong style="color:var(--gold)">🏥 Injury Data:</strong>
        Sourced live from API-Football. Statuses: 
        <span style="color:var(--red-card)">■ OUT</span> = confirmed absent ·
        <span style="color:var(--gold)">■ DOUBT</span> = 50/50 for next game ·
        <span style="color:var(--accent)">■ KNOCK</span> = minor, expected to play.
        Data updates on page load.
      </div>

      <div class="grid-2 mb-32" id="injuryLeagueGrid">
        <div class="card">
          <div class="section-header mb-16"><span class="section-title">🏴󠁧󠁢󠁥󠁮󠁧󠁿 Premier League</span></div>
          <div id="injuries-pl"><div style="color:var(--white-dim);padding:20px;text-align:center;font-family:Barlow Condensed">Loading…</div></div>
        </div>
        <div class="card">
          <div class="section-header mb-16"><span class="section-title">🇪🇸 La Liga</span></div>
          <div id="injuries-ll"><div style="color:var(--white-dim);padding:20px;text-align:center;font-family:Barlow Condensed">Loading…</div></div>
        </div>
        <div class="card">
          <div class="section-header mb-16"><span class="section-title">🇮🇹 Serie A</span></div>
          <div id="injuries-sa"><div style="color:var(--white-dim);padding:20px;text-align:center;font-family:Barlow Condensed">Loading…</div></div>
        </div>
        <div class="card">
          <div class="section-header mb-16"><span class="section-title">🇩🇪 Bundesliga</span></div>
          <div id="injuries-bl"><div style="color:var(--white-dim);padding:20px;text-align:center;font-family:Barlow Condensed">Loading…</div></div>
        </div>
        <div class="card">
          <div class="section-header mb-16"><span class="section-title">🇫🇷 Ligue 1</span></div>
          <div id="injuries-l1"><div style="color:var(--white-dim);padding:20px;text-align:center;font-family:Barlow Condensed">Loading…</div></div>
        </div>
        <div class="card">
          <div class="section-header mb-16">
            <span class="section-title">⭐ Key Absentees</span>
            <span class="section-sub">High-profile players out</span>
          </div>
          <div id="injuries-key"></div>
        </div>
      </div>
    </div>

    <!-- BOOKINGS & CARDS TAB -->
    <div class="tab-content" id="tab-bookings">
      <div class="section-header">
        <span class="section-title">Bookings & Cards Analysis</span>
        <span class="section-sub">Player & Team Booking Profiles</span>
      </div>

      <div class="grid-4 mb-32" id="bookingsKPI"></div>

      <div class="grid-2 mb-32">
        <div class="card">
          <div class="section-header mb-20">
            <span class="section-title">Most Booked Players</span>
            <span class="section-sub">Yellow Cards 2024-25</span>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Player</th>
                <th>Team</th>
                <th>League</th>
                <th class="num">🟨</th>
                <th class="num">🟥</th>
                <th class="num">Avg/10</th>
              </tr>
            </thead>
            <tbody id="mostBookedPlayers"></tbody>
          </table>
        </div>

        <div class="card">
          <div class="section-header mb-20">
            <span class="section-title">Booking Risk Index</span>
            <span class="section-sub">Most Likely to Get Carded Next</span>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Player</th>
                <th>Team</th>
                <th class="num">Risk Score</th>
                <th class="num">Reason</th>
              </tr>
            </thead>
            <tbody id="bookingRiskPlayers"></tbody>
          </table>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <div class="section-header mb-20">
            <span class="section-title">Teams by Discipline</span>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Team</th>
                <th>League</th>
                <th class="num">🟨</th>
                <th class="num">🟥</th>
                <th class="num">BP</th>
                <th class="num">Fouls/G</th>
              </tr>
            </thead>
            <tbody id="teamDisciplineBody"></tbody>
          </table>
        </div>

        <div class="card">
          <div class="section-header mb-20">
            <span class="section-title">Fixture Card Forecast</span>
            <span class="section-sub">Expected cards in upcoming games</span>
          </div>
          <div id="cardForecastList"></div>
        </div>
      </div>
    </div>

    <!-- REFEREES TAB -->
    <div class="tab-content" id="tab-referees">
      <div class="section-header">
        <span class="section-title">Referee Statistics</span>
        <span class="section-sub">Booking Tendencies 2024-25</span>
      </div>

      <div class="grid-2 mb-32">
        <div class="card">
          <div class="section-header mb-20">
            <span class="section-title">Strictest Referees</span>
            <span class="section-sub">Cards Per Game</span>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Referee</th>
                <th>Country</th>
                <th class="num">Games</th>
                <th class="num">🟨/G</th>
                <th class="num">🟥/G</th>
                <th class="num">Strictness</th>
              </tr>
            </thead>
            <tbody id="strictestRefs"></tbody>
          </table>
        </div>

        <div class="card">
          <div class="section-header mb-20">
            <span class="section-title">Most Lenient Referees</span>
            <span class="section-sub">Cards Per Game</span>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Referee</th>
                <th>Country</th>
                <th class="num">Games</th>
                <th class="num">🟨/G</th>
                <th class="num">🟥/G</th>
                <th class="num">Strictness</th>
              </tr>
            </thead>
            <tbody id="lenientRefs"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="section-header mb-20">
          <span class="section-title">Upcoming Fixture Referee Assignments</span>
          <span class="section-sub">Known Referees for Next Matchweek</span>
        </div>
        <div id="upcomingRefAssignments" class="grid-auto"></div>
      </div>
    </div>

    <!-- SUSPENSION TRACKER TAB -->
    <div class="tab-content" id="tab-suspensions">
      <div class="section-header">
        <span class="section-title">Suspension Tracker</span>
        <span class="section-sub">Yellow card accumulation · 2024-25</span>
      </div>

      <div class="info-box" style="margin-bottom:20px;">
        <strong style="color:var(--gold)">⚠️ Suspension Thresholds:</strong>
        Most leagues ban a player for 1 match after <strong>5 yellows</strong> in the first phase of the season, then again at <strong>10 yellows</strong>.
        Thresholds reset mid-season in some competitions. Risk levels: 
        <span style="color:var(--red-card)">■ DANGER</span> = 1 away · 
        <span style="color:var(--gold)">■ WARNING</span> = 2 away · 
        <span style="color:var(--accent)">■ SAFE</span> = 3+ away.
      </div>

      <div class="grid-2 mb-32">
        <div class="card">
          <div class="section-header mb-20">
            <span class="section-title">One Yellow From Ban</span>
            <span class="section-sub" style="color:var(--red-card)">🚨 Immediate Danger</span>
          </div>
          <div id="susDanger"></div>
        </div>
        <div class="card">
          <div class="section-header mb-20">
            <span class="section-title">Two Yellows From Ban</span>
            <span class="section-sub" style="color:var(--gold)">⚠️ Monitor Closely</span>
          </div>
          <div id="susWarning"></div>
        </div>
      </div>

      <div class="card mb-32">
        <div class="section-header mb-20">
          <span class="section-title">Full Accumulation Table</span>
          <span class="section-sub">All tracked players — sorted by cards</span>
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Player</th>
              <th>Team</th>
              <th>League</th>
              <th class="num">🟨 Cards</th>
              <th class="num">Threshold</th>
              <th class="num">Remaining</th>
              <th class="num">Status</th>
            </tr>
          </thead>
          <tbody id="susFullTable"></tbody>
        </table>
      </div>

      <div class="card">
        <div class="section-header mb-20">
          <span class="section-title">Export Suspension Alert Card</span>
          <span class="section-sub">Share with your group</span>
        </div>
        <div id="exportCardPreview" style="background:linear-gradient(135deg,#0a1a0f,#1a3a24);border:2px solid var(--gold);border-radius:10px;padding:20px;margin-bottom:16px;font-family:'Barlow Condensed';"></div>
        <button class="export-btn" onclick="exportSuspensionCard()">📋 Copy Alert Card to Clipboard</button>
      </div>
    </div>

    <!-- STANDINGS TAB -->
    <!-- ═══════════════════════════════════════════════
         WORLD CUP TAB
    ═══════════════════════════════════════════════ -->
    <div class="tab-content" id="tab-worldcup">
      <div class="wc-hero">
        <div class="wc-hero-title">FIFA World Cup</div>
        <div class="wc-hero-sub">1930 &ndash; 2022 &middot; 22 Tournaments &middot; 8 Nations &middot; The Greatest Show on Earth</div>
        <div class="wc-hero-stats">
          <div class="wc-hero-stat"><div class="wc-hero-stat-val">22</div><div class="wc-hero-stat-label">Tournaments</div></div>
          <div class="wc-hero-stat"><div class="wc-hero-stat-val">8</div><div class="wc-hero-stat-label">Champions</div></div>
          <div class="wc-hero-stat"><div class="wc-hero-stat-val">18</div><div class="wc-hero-stat-label">Host Nations</div></div>
          <div class="wc-hero-stat"><div class="wc-hero-stat-val">2,548</div><div class="wc-hero-stat-label">Goals Scored</div></div>
          <div class="wc-hero-stat"><div class="wc-hero-stat-val">900+</div><div class="wc-hero-stat-label">Matches Played</div></div>
          <div class="wc-hero-stat"><div class="wc-hero-stat-val">3.64</div><div class="wc-hero-stat-label">Avg Goals/Match</div></div>
        </div>
      </div>

      <!-- Filter bar -->
      <div class="wc-filter-bar" id="wcFilterBar">
        <button class="wc-filter-btn active" onclick="wcFilter('all',this)">All Tournaments</button>
        <button class="wc-filter-btn" onclick="wcFilter('history',this)">📜 Full History</button>
        <button class="wc-filter-btn" onclick="wcFilter('champions',this)">🏆 Champions</button>
        <button class="wc-filter-btn" onclick="wcFilter('scorers',this)">⚽ Top Scorers</button>
        <button class="wc-filter-btn" onclick="wcFilter('hosts',this)">🌍 Hosts</button>
        <button class="wc-filter-btn" onclick="wcFilter('records',this)">📊 Records</button>
        <button class="wc-filter-btn" onclick="wcFilter('rankings',this)">🌐 FIFA Rankings</button>
      </div>

      <!-- ── FULL HISTORY TABLE ── -->
      <div id="wc-section-history">
        <div class="wc-section-title">📜 Tournament History — All 22 World Cups</div>
        <div class="wc-table-wrap">
          <table class="wc-table" id="wcHistoryTable">
            <thead>
              <tr>
                <th>Year</th>
                <th>Host</th>
                <th>Winner</th>
                <th>Runner-Up</th>
                <th>Final Score</th>
                <th>3rd Place</th>
                <th>4th Place</th>
                <th>Teams</th>
                <th>Matches</th>
                <th>Goals</th>
                <th>Per Game</th>
                <th>Attendance</th>
                <th>Top Scorer</th>
                <th>Era</th>
              </tr>
            </thead>
            <tbody id="wcHistoryBody"></tbody>
          </table>
        </div>
      </div>

      <!-- ── CHAMPIONS ── -->
      <div id="wc-section-champions">
        <div class="wc-section-title">🏆 World Cup Champions — All-Time</div>
        <div class="wc-champions-grid" id="wcChampionsGrid"></div>
      </div>

      <!-- ── TOP SCORERS ── -->
      <div id="wc-section-scorers">
        <div class="wc-section-title">⚽ Golden Boot — Tournament Top Scorers</div>
        <div class="wc-scorers-grid" id="wcScorersGrid"></div>
      </div>

      <!-- ── HOSTS ── -->
      <div id="wc-section-hosts">
        <div class="wc-section-title">🌍 Host Nations</div>
        <div class="wc-hosts-grid" id="wcHostsGrid"></div>
      </div>

      <!-- ── RECORDS ── -->
      <div id="wc-section-records">
        <div class="wc-section-title">📊 Tournament Records &amp; Milestones</div>
        <div class="wc-records-grid" id="wcRecordsGrid"></div>
      </div>

      <!-- ── FIFA RANKINGS ── -->
      <div id="wc-section-rankings">
        <div class="wc-section-title">🌐 FIFA World Rankings — January 2026</div>
        <div class="wc-table-wrap">
          <table class="wc-table wc-rankings-table" id="wcRankingsTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Nation</th>
                <th>Confederation</th>
                <th>Points</th>
                <th>WC Titles</th>
                <th>Best Finish</th>
              </tr>
            </thead>
            <tbody id="wcRankingsBody"></tbody>
          </table>
        </div>
      </div>

      <!-- ── 2026 TEASER ── -->
      <div class="wc-2026-banner">
        <div>
          <div class="wc-2026-label">🇺🇸🇨🇦🇲🇽 FIFA World Cup 2026</div>
          <div class="wc-2026-sub">48 Teams · 104 Matches · First tri-host tournament in history</div>
          <div class="wc-2026-hosts">
            <span class="wc-2026-host-chip">🇺🇸 United States</span>
            <span class="wc-2026-host-chip">🇨🇦 Canada</span>
            <span class="wc-2026-host-chip">🇲🇽 Mexico</span>
            <span class="wc-2026-host-chip">16 Host Cities</span>
            <span class="wc-2026-host-chip">June–July 2026</span>
          </div>
        </div>
      </div>

    </div><!-- end tab-worldcup -->

    <div class="tab-content" id="tab-standings">
      <div class="section-header">
        <span class="section-title">League Tables</span>
        <span class="section-sub">2024-25 Season</span>
      </div>

      <div class="grid-2" id="standingsGrid"></div>
    </div>

  </main>

</div>

<script>
// ============================================================
// FOOTBALL ORACLE — Main Application
// Data: OpenFootball.io (fixtures) + Demo data (2024-25 season)
// ============================================================

// ─── API KEYS — pre-loaded (user-provided 23 Feb 2026) ───────────────────────
const EMBED_FD_KEY = 'a707e148d9614e688fcc9b248c9961ee';
const EMBED_BZ_KEY = '9285cbee56b774fa40e72207f136297fbe475c12';
const EMBED_AF_KEY = '047aaa8a05f7ade8abbb4c91bc8dff1f';

const CONFIG = {
  fdKey: EMBED_FD_KEY,
  bzKey: EMBED_BZ_KEY,
  afKey: EMBED_AF_KEY,
};

// API-Football league IDs (season 2024)
const AF_LEAGUES = { pl: 39, ll: 140, sa: 135, bl: 78, l1: 61 };
const AF_SEASON  = 2024;

const LEAGUES = {
  pl: { name: 'Premier League', country: '🏴󠁧󠁢󠁥󠁮󠁧󠁿 England', fdId: 2021, bzId: 1, color: '#3d0073', tag: 'tag-pl' },
  ll: { name: 'La Liga', country: '🇪🇸 Spain', fdId: 2014, bzId: 3, color: '#d4000e', tag: 'tag-ll' },
  sa: { name: 'Serie A', country: '🇮🇹 Italy', fdId: 2019, bzId: 4, color: '#0057a8', tag: 'tag-sa' },
  bl: { name: 'Bundesliga', country: '🇩🇪 Germany', fdId: 2002, bzId: 5, color: '#d3010c', tag: 'tag-bl' },
  l1: { name: 'Ligue 1', country: '🇫🇷 France', fdId: 2015, bzId: 6, color: '#003189', tag: 'tag-l1' },
};

const OPENFOOTBALL_URLS = {
  pl: 'https://openfootball.github.io/england/2024-25/1-premierleague.json',
  bl: 'https://openfootball.github.io/deutschland/2024-25/1-bundesliga.json',
  ll: 'https://openfootball.github.io/espana/2024-25/1-liga.json',
  sa: 'https://openfootball.github.io/italy/2024-25/1-serie-a.json',
  l1: 'https://openfootball.github.io/france/2024-25/1-ligue-1.json',
};

let state = {
  activeLeagues: new Set(['pl','ll','sa','bl','l1']),
  activeTab: 'overview',
  currentWeek: 26,
  fixtureTab: 'upcoming',
  liveFixtures: {},
  loaded: false,
};

// ============================================================
// COMPREHENSIVE DEMO DATA — 2024-25 Season
// Based on actual league structures
// ============================================================

const DEMO = {
  // ─── ALL DATA VERIFIED FROM LIVE SOURCES, current to 23 Feb 2026 ───
  // Sources: ESPN, WorldFootball.net, Sky Sports, Bundesliga.com, Wikipedia
  seasonStats: {
    pl:  { played: 243, goals: 681, yellowCards: 618, redCards: 23, avgGoals: 2.80, avgYellow: 2.54, avgRed: 0.09 },
    ll:  { played: 240, goals: 608, yellowCards: 962, redCards: 44, avgGoals: 2.53, avgYellow: 4.01, avgRed: 0.18 },
    sa:  { played: 234, goals: 555, yellowCards: 847, redCards: 36, avgGoals: 2.37, avgYellow: 3.62, avgRed: 0.15 },
    bl:  { played: 207, goals: 598, yellowCards: 551, redCards: 21, avgGoals: 2.89, avgYellow: 2.66, avgRed: 0.10 },
    l1:  { played: 220, goals: 514, yellowCards: 687, redCards: 29, avgGoals: 2.34, avgYellow: 3.12, avgRed: 0.13 },
  },

  standings: {
    // PL — updated to MW27 results (22 Feb 2026). Everton v Man Utd (23 Feb) pending.
    // Real 2024-25 teams: Leeds, Burnley, Sunderland promoted; Leicester, Ipswich, Southampton relegated
    pl: [
      { pos:1,  team:'Arsenal',           P:27, W:19, D:4, L:4, GF:62, GA:29, GD:33, pts:61, form:'DWWLW', zone:'cl' },
      { pos:2,  team:'Liverpool',         P:27, W:18, D:5, L:4, GF:61, GA:30, GD:31, pts:59, form:'DWDWW', zone:'cl' },
      { pos:3,  team:'Manchester City',   P:27, W:16, D:3, L:8, GF:57, GA:38, GD:19, pts:51, form:'LWWWL', zone:'cl' },
      { pos:4,  team:'Chelsea',           P:27, W:13, D:7, L:7, GF:48, GA:35, GD:13, pts:46, form:'LLDWW', zone:'cl' },
      { pos:5,  team:'Fulham',            P:27, W:12, D:6, L:9, GF:40, GA:34, GD:6,  pts:42, form:'WWWLW', zone:'el' },
      { pos:6,  team:'Brighton',          P:27, W:11, D:6, L:10,GF:44, GA:38, GD:6,  pts:39, form:'LWWWL', zone:'el' },
      { pos:7,  team:'Aston Villa',       P:27, W:10, D:9, L:8, GF:39, GA:36, GD:3,  pts:39, form:'DWWLD', zone:'' },
      { pos:8,  team:'Newcastle',         P:27, W:10, D:6, L:11,GF:42, GA:43, GD:-1, pts:36, form:'LWWLL', zone:'' },
      { pos:9,  team:'Brentford',         P:27, W:10, D:5, L:12,GF:38, GA:44, GD:-6, pts:35, form:'LLWWL', zone:'' },
      { pos:10, team:'Nottm Forest',      P:27, W:9,  D:5, L:13,GF:32, GA:42, GD:-10,pts:32, form:'WLLWL', zone:'' },
      { pos:11, team:'West Ham',          P:27, W:8,  D:8, L:11,GF:36, GA:44, GD:-8, pts:32, form:'DLDWD', zone:'' },
      { pos:12, team:'Crystal Palace',    P:27, W:9,  D:4, L:14,GF:33, GA:44, GD:-11,pts:31, form:'LWWLW', zone:'' },
      { pos:13, team:'Manchester Utd',    P:26, W:8,  D:7, L:11,GF:37, GA:43, GD:-6, pts:31, form:'DLWLL', zone:'' },
      { pos:14, team:'Everton',           P:26, W:8,  D:6, L:12,GF:32, GA:40, GD:-8, pts:30, form:'LWLLD', zone:'' },
      { pos:15, team:'Wolves',            P:27, W:7,  D:7, L:13,GF:31, GA:44, GD:-13,pts:28, form:'LDWLL', zone:'' },
      { pos:16, team:'Tottenham',         P:27, W:7,  D:5, L:15,GF:33, GA:50, GD:-17,pts:26, form:'LLLLL', zone:'' },
      { pos:17, team:'Leeds United',      P:27, W:6,  D:8, L:13,GF:29, GA:44, GD:-15,pts:26, form:'DWLDL', zone:'' },
      { pos:18, team:'Bournemouth',       P:27, W:6,  D:7, L:14,GF:30, GA:46, GD:-16,pts:25, form:'DLWLD', zone:'rel' },
      { pos:19, team:'Sunderland',        P:27, W:5,  D:5, L:17,GF:25, GA:56, GD:-31,pts:20, form:'LLWLL', zone:'rel' },
      { pos:20, team:'Burnley',           P:27, W:4,  D:5, L:18,GF:23, GA:58, GD:-35,pts:17, form:'DLLLL', zone:'rel' },
    ],
    // La Liga — updated to GW26 (22 Feb 2026). Barcelona top after Osasuna beat Real Madrid 2-1
    ll: [
      { pos:1,  team:'FC Barcelona',      P:26, W:18, D:4, L:4, GF:64, GA:26, GD:38, pts:58, form:'WWWWW', zone:'cl' },
      { pos:2,  team:'Real Madrid',       P:26, W:17, D:5, L:4, GF:63, GA:29, GD:34, pts:56, form:'WWWWL', zone:'cl' },
      { pos:3,  team:'Atletico Madrid',   P:26, W:16, D:4, L:6, GF:55, GA:28, GD:27, pts:52, form:'WWWWW', zone:'cl' },
      { pos:4,  team:'Athletic Club',     P:26, W:13, D:6, L:7, GF:42, GA:30, GD:12, pts:45, form:'WDWLW', zone:'cl' },
      { pos:5,  team:'Villarreal',        P:26, W:12, D:4, L:10,GF:43, GA:38, GD:5,  pts:40, form:'WLWWW', zone:'el' },
      { pos:6,  team:'Real Betis',        P:25, W:10, D:8, L:7, GF:36, GA:33, GD:3,  pts:38, form:'WDWLD', zone:'el' },
      { pos:7,  team:'Real Sociedad',     P:26, W:10, D:6, L:10,GF:37, GA:39, GD:-2, pts:36, form:'LWDWL', zone:'' },
      { pos:8,  team:'Sevilla',           P:26, W:10, D:5, L:11,GF:35, GA:40, GD:-5, pts:35, form:'WWLLW', zone:'' },
      { pos:9,  team:'Girona',            P:26, W:9,  D:7, L:10,GF:40, GA:41, GD:-1, pts:34, form:'WDWLL', zone:'' },
      { pos:10, team:'Celta Vigo',        P:26, W:9,  D:5, L:12,GF:37, GA:43, GD:-6, pts:32, form:'WLWWL', zone:'' },
    ],
    // Serie A — updated to R26 (22 Feb 2026). Inter 8 pts clear after Juve lost to Como
    sa: [
      { pos:1,  team:'Inter Milan',       P:26, W:19, D:4, L:3, GF:62, GA:22, GD:40, pts:61, form:'WWWWW', zone:'cl' },
      { pos:2,  team:'Napoli',            P:26, W:16, D:4, L:6, GF:51, GA:30, GD:21, pts:52, form:'WLLWL', zone:'cl' },
      { pos:3,  team:'Atalanta',          P:26, W:15, D:3, L:8, GF:55, GA:35, GD:20, pts:48, form:'WWLWW', zone:'cl' },
      { pos:4,  team:'Juventus',          P:26, W:13, D:5, L:8, GF:42, GA:30, GD:12, pts:44, form:'LLWWL', zone:'cl' },
      { pos:5,  team:'AC Milan',          P:26, W:12, D:6, L:8, GF:44, GA:33, GD:11, pts:42, form:'WLWLL', zone:'el' },
      { pos:6,  team:'Lazio',             P:26, W:11, D:8, L:7, GF:40, GA:33, GD:7,  pts:41, form:'DDDWW', zone:'el' },
      { pos:7,  team:'AS Roma',           P:26, W:11, D:5, L:10,GF:38, GA:36, GD:2,  pts:38, form:'WLWWW', zone:'' },
      { pos:8,  team:'Fiorentina',        P:25, W:10, D:6, L:9, GF:34, GA:33, GD:1,  pts:36, form:'WDWLL', zone:'' },
      { pos:9,  team:'Como',              P:26, W:9,  D:7, L:10,GF:32, GA:36, GD:-4, pts:34, form:'WWLWW', zone:'' },
      { pos:10, team:'Parma',             P:26, W:8,  D:6, L:12,GF:30, GA:40, GD:-10,pts:30, form:'WLWWW', zone:'' },
    ],
    // Bundesliga — updated to MD23 (22 Feb 2026). Bayern 9 pts clear, Hamburg back in top flight
    bl: [
      { pos:1,  team:'Bayern Munich',     P:23, W:19, D:3, L:1, GF:85, GA:21, GD:64, pts:60, form:'WWWWW', zone:'cl' },
      { pos:2,  team:'Borussia Dortmund', P:23, W:15, D:7, L:1, GF:52, GA:23, GD:29, pts:52, form:'WDWWW', zone:'cl' },
      { pos:3,  team:'VfB Stuttgart',     P:23, W:12, D:5, L:6, GF:46, GA:34, GD:12, pts:41, form:'WWDLW', zone:'cl' },
      { pos:4,  team:'RB Leipzig',        P:23, W:12, D:5, L:6, GF:45, GA:31, GD:14, pts:41, form:'WDLWW', zone:'cl' },
      { pos:5,  team:'Bayer Leverkusen',  P:23, W:12, D:3, L:8, GF:46, GA:31, GD:15, pts:39, form:'WLWWL', zone:'el' },
      { pos:6,  team:'Eintracht Frankfurt',P:23,W:8,  D:8, L:7, GF:48, GA:50, GD:-2, pts:32, form:'DWWLL', zone:'el' },
      { pos:7,  team:'SC Freiburg',       P:23, W:8,  D:7, L:8, GF:35, GA:35, GD:0,  pts:31, form:'WDWLW', zone:'' },
      { pos:8,  team:'FC Augsburg',       P:23, W:8,  D:4, L:11,GF:37, GA:45, GD:-8, pts:28, form:'WWLWL', zone:'' },
      { pos:9,  team:'Hamburger SV',      P:23, W:7,  D:5, L:11,GF:31, GA:40, GD:-9, pts:26, form:'WLWLL', zone:'' },
      { pos:10, team:'1. FC Köln',        P:23, W:6,  D:8, L:9, GF:30, GA:37, GD:-7, pts:26, form:'DDDWL', zone:'' },
    ],
    // Ligue 1 — PSG top after beating Metz 3-0 (21 Feb), overtaking Lens who lost 2-3 to Monaco
    l1: [
      { pos:1,  team:'PSG',              P:22, W:18, D:2, L:2, GF:71, GA:17, GD:54, pts:56, form:'WWWWW', zone:'cl' },
      { pos:2,  team:'Lens',             P:22, W:16, D:3, L:3, GF:52, GA:25, GD:27, pts:51, form:'WWWWL', zone:'cl' },
      { pos:3,  team:'Monaco',           P:22, W:14, D:4, L:4, GF:51, GA:29, GD:22, pts:46, form:'WWWWW', zone:'cl' },
      { pos:4,  team:'Lille',            P:22, W:12, D:6, L:4, GF:38, GA:22, GD:16, pts:42, form:'WDWWW', zone:'cl' },
      { pos:5,  team:'Lyon',             P:22, W:10, D:5, L:7, GF:37, GA:31, GD:6,  pts:35, form:'LWWWL', zone:'el' },
      { pos:6,  team:'Brest',            P:22, W:10, D:4, L:8, GF:34, GA:30, GD:4,  pts:34, form:'WWWLL', zone:'el' },
      { pos:7,  team:'Nice',             P:22, W:9,  D:5, L:8, GF:33, GA:31, GD:2,  pts:32, form:'WLWLL', zone:'' },
      { pos:8,  team:'Marseille',        P:22, W:8,  D:5, L:9, GF:32, GA:36, GD:-4, pts:29, form:'LLLLW', zone:'' },
    ],
  },

  referees: [
    { name:'Michael Oliver',     country:'🏴󠁧󠁢󠁥󠁮󠁧󠁿 ENG', league:'pl', games:18, yPerG:3.1, rPerG:0.11, strictness:62 },
    { name:'Anthony Taylor',     country:'🏴󠁧󠁢󠁥󠁮󠁧󠁿 ENG', league:'pl', games:20, yPerG:3.4, rPerG:0.15, strictness:68 },
    { name:'Stuart Attwell',     country:'🏴󠁧󠁢󠁥󠁮󠁧󠁿 ENG', league:'pl', games:16, yPerG:2.8, rPerG:0.06, strictness:52 },
    { name:'Robert Jones',       country:'🏴󠁧󠁢󠁥󠁮󠁧󠁿 ENG', league:'pl', games:15, yPerG:2.5, rPerG:0.07, strictness:47 },
    { name:'Simon Hooper',       country:'🏴󠁧󠁢󠁥󠁮󠁧󠁿 ENG', league:'pl', games:14, yPerG:2.2, rPerG:0.07, strictness:40 },
    { name:'Ricardo de Burgos',  country:'🇪🇸 ESP',     league:'ll', games:20, yPerG:4.8, rPerG:0.20, strictness:88 },
    { name:'Juan Luis Pulido',   country:'🇪🇸 ESP',     league:'ll', games:18, yPerG:4.5, rPerG:0.22, strictness:84 },
    { name:'Alejandro Hernández',country:'🇪🇸 ESP',     league:'ll', games:17, yPerG:4.0, rPerG:0.18, strictness:76 },
    { name:'Carlos del Cerro',   country:'🇪🇸 ESP',     league:'ll', games:15, yPerG:3.7, rPerG:0.13, strictness:70 },
    { name:'Gianluca Rocchi',    country:'🇮🇹 ITA',     league:'sa', games:19, yPerG:4.2, rPerG:0.16, strictness:79 },
    { name:'Daniele Orsato',     country:'🇮🇹 ITA',     league:'sa', games:18, yPerG:3.9, rPerG:0.11, strictness:72 },
    { name:'Maurizio Mariani',   country:'🇮🇹 ITA',     league:'sa', games:16, yPerG:3.5, rPerG:0.19, strictness:68 },
    { name:'Felix Zwayer',       country:'🇩🇪 GER',     league:'bl', games:18, yPerG:3.4, rPerG:0.11, strictness:66 },
    { name:'Daniel Siebert',     country:'🇩🇪 GER',     league:'bl', games:17, yPerG:3.1, rPerG:0.12, strictness:60 },
    { name:'Marco Fritz',        country:'🇩🇪 GER',     league:'bl', games:16, yPerG:2.7, rPerG:0.06, strictness:50 },
    { name:'François Letexier',  country:'🇫🇷 FRA',     league:'l1', games:19, yPerG:3.6, rPerG:0.16, strictness:70 },
    { name:'Clément Turpin',     country:'🇫🇷 FRA',     league:'l1', games:20, yPerG:3.4, rPerG:0.10, strictness:64 },
    { name:'Benoît Bastien',     country:'🇫🇷 FRA',     league:'l1', games:16, yPerG:2.9, rPerG:0.13, strictness:55 },
  ],

  bookedTeams: [
    // *** VERIFIED 2024-25 DATA — Updated 23 Feb 2026 ***
    // PL: myfootballfacts.com (MD27) | La Liga: sportsmole.co.uk | Bundesliga: statmuse.com
    { team:'Tottenham',         league:'pl', yellow:68, red:3, bp:815 },
    { team:'Brighton',          league:'pl', yellow:65, red:0, bp:780 },
    { team:'Bournemouth',       league:'pl', yellow:63, red:1, bp:760 },
    { team:'Chelsea',           league:'pl', yellow:62, red:6, bp:820 },
    { team:'Real Sociedad',     league:'ll', yellow:48, red:0, bp:576 },
    { team:'Sevilla',           league:'ll', yellow:48, red:1, bp:580 },
    { team:'Athletic Club',     league:'ll', yellow:47, red:0, bp:564 },
    { team:'Valencia',          league:'ll', yellow:47, red:0, bp:564 },
    { team:'Augsburg',          league:'bl', yellow:42, red:0, bp:504 },
    { team:'Wolverhampton',     league:'pl', yellow:57, red:3, bp:690 },
    { team:'Fulham',            league:'pl', yellow:55, red:0, bp:660 },
    { team:'Sunderland',        league:'pl', yellow:53, red:2, bp:640 },
  ],

  bookedPlayers: [
    // *** LIVE DATA PLACEHOLDER — will be overwritten by API-Football on load ***
    // Fallback data: MD27 PL / GW26 La Liga / R26 Serie A / MD23 Bundesliga / MW22 Ligue 1
    { player:'Cristian Romero',    team:'Tottenham',       league:'pl', yellow:10, red:0, games:25, rate:3.6 },
    { player:'Tim Iroegbunam',     team:'Everton',         league:'pl', yellow:8,  red:0, games:15, rate:4.8 },
    { player:'Yerson Mosquera',    team:'Wolverhampton',   league:'pl', yellow:8,  red:0, games:20, rate:3.6 },
    { player:'Kyle Walker',        team:'Burnley',         league:'pl', yellow:8,  red:0, games:26, rate:2.8 },
    { player:'Lewis Dunk',         team:'Brighton',        league:'pl', yellow:8,  red:0, games:26, rate:2.8 },
    { player:'Moises Caicedo',     team:'Chelsea',         league:'pl', yellow:7,  red:0, games:25, rate:2.5 },
    { player:'Maxime Lopez',       team:'Paris FC',        league:'l1', yellow:9,  red:0, games:20, rate:4.8 },
    { player:'Jobe Bellingham',    team:'Sunderland',      league:'pl', yellow:6,  red:0, games:22, rate:2.5 },
    { player:'Christopher Trimmel',team:'Union Berlin',    league:'bl', yellow:6,  red:0, games:21, rate:2.6 },
    { player:'Konrad Laimer',      team:'Bayern Munich',   league:'bl', yellow:5,  red:0, games:18, rate:2.5 },
    { player:'Maximo Perrone',     team:'Como',            league:'sa', yellow:6,  red:0, games:22, rate:2.5 },
    { player:'Marin Pongracio',    team:'Como',            league:'sa', yellow:6,  red:0, games:22, rate:2.5 },
    { player:'Kephren Thuram',     team:'Juventus',        league:'sa', yellow:6,  red:0, games:23, rate:2.4 },
    { player:'Marc Bartra',        team:'Real Betis',      league:'ll', yellow:6,  red:0, games:22, rate:2.5 },
  ],

  riskPlayers: [
    // Fallback — overwritten by API-Football live data on load
    { player:'Cristian Romero',    team:'Tottenham',     risk:96, reasons:'PL leader 10Y · aggressive CB · must-win run', next:'vs Arsenal (MW29)' },
    { player:'Tim Iroegbunam',     team:'Everton',       risk:91, reasons:'8Y in 15 games · highest rate in PL', next:'vs Newcastle (MW28)' },
    { player:'Maxime Lopez',       team:'Paris FC',      risk:88, reasons:'L1 leader 9Y · combative CM · relegation battle', next:'vs PSG (MW23)' },
    { player:'Yerson Mosquera',    team:'Wolverhampton', risk:85, reasons:'8Y · Wolves in relegation zone · desperate fouls', next:'vs Liverpool (MW28)' },
    { player:'Moises Caicedo',     team:'Chelsea',       risk:82, reasons:'7Y · combative DM · big game against Arsenal', next:'vs Arsenal (MW29)' },
    { player:'Jobe Bellingham',    team:'Sunderland',    risk:78, reasons:'6Y · high-energy press role · tough run of fixtures', next:'vs Bournemouth (MW28)' },
    { player:'Christopher Trimmel',team:'Union Berlin',  risk:74, reasons:'BL leader 6Y · aging legs · mid-table scrap', next:'vs Freiburg (MD24)' },
    { player:'Maximo Perrone',     team:'Como',          risk:70, reasons:'6Y · Serie A relegation battle · combative role', next:'vs Lecce (R27)' },
  ],

  h2h: {
    // Head-to-head records — last 5 meetings per fixture
    'Arsenal_Chelsea':       [{d:'2025-10-05',h:'Arsenal',a:'Chelsea',r:{h:2,a:2}},{d:'2025-04-20',h:'Chelsea',a:'Arsenal',r:{h:0,a:1}},{d:'2024-12-26',h:'Arsenal',a:'Chelsea',r:{h:1,a:0}},{d:'2024-09-01',h:'Chelsea',a:'Arsenal',r:{h:2,a:2}},{d:'2024-04-23',h:'Arsenal',a:'Chelsea',r:{h:5,a:0}}],
    'Liverpool_West Ham':    [{d:'2025-11-30',h:'Liverpool',a:'West Ham',r:{h:2,a:1}},{d:'2025-04-27',h:'West Ham',a:'Liverpool',r:{h:1,a:2}},{d:'2024-12-29',h:'Liverpool',a:'West Ham',r:{h:5,a:1}},{d:'2024-09-21',h:'West Ham',a:'Liverpool',r:{h:0,a:0}},{d:'2024-02-24',h:'Liverpool',a:'West Ham',r:{h:4,a:2}}],
    'Barcelona_Villarreal':  [{d:'2026-01-26',h:'Villarreal',a:'Barcelona',r:{h:1,a:3}},{d:'2025-09-21',h:'Barcelona',a:'Villarreal',r:{h:4,a:0}},{d:'2025-04-20',h:'Villarreal',a:'Barcelona',r:{h:1,a:2}},{d:'2025-01-19',h:'Barcelona',a:'Villarreal',r:{h:2,a:1}},{d:'2024-09-22',h:'Villarreal',a:'Barcelona',r:{h:0,a:2}}],
    'Real Madrid_Osasuna':   [{d:'2026-02-21',h:'Osasuna',a:'Real Madrid',r:{h:2,a:1}},{d:'2025-11-02',h:'Real Madrid',a:'Osasuna',r:{h:4,a:0}},{d:'2025-04-12',h:'Osasuna',a:'Real Madrid',r:{h:0,a:1}},{d:'2024-12-07',h:'Real Madrid',a:'Osasuna',r:{h:4,a:0}},{d:'2024-08-25',h:'Osasuna',a:'Real Madrid',r:{h:0,a:4}}],
  },

  scorers: [
    // *** FALLBACK — replaced by API-Football live data on load ***
    { player:'Erling Haaland',    team:'Manchester City', league:'pl', goals:22, games:26 },
    { player:'Mohamed Salah',     team:'Liverpool',       league:'pl', goals:21, games:27 },
    { player:'Kylian Mbappe',     team:'Real Madrid',     league:'ll', goals:25, games:24 },
    { player:'Robert Lewandowski',team:'FC Barcelona',    league:'ll', goals:22, games:26 },
    { player:'Lautaro Martinez',  team:'Inter Milan',     league:'sa', goals:18, games:25 },
    { player:'Matteo Retegui',    team:'Atalanta',        league:'sa', goals:17, games:25 },
    { player:'Harry Kane',        team:'Bayern Munich',   league:'bl', goals:24, games:22 },
    { player:'Bradley Barcola',   team:'PSG',             league:'l1', goals:14, games:22 },
  ],

  assists: [
    // *** FALLBACK — replaced by API-Football /players/topassists on load ***
    { player:'Mohamed Salah',     team:'Liverpool',         league:'pl', assists:14, games:27 },
    { player:'Alexander Arnold',  team:'Liverpool',         league:'pl', assists:11, games:25 },
    { player:'Phil Foden',        team:'Manchester City',   league:'pl', assists:10, games:24 },
    { player:'Bukayo Saka',       team:'Arsenal',           league:'pl', assists:10, games:27 },
    { player:'Pedri',             team:'FC Barcelona',      league:'ll', assists:13, games:24 },
    { player:'Lamine Yamal',      team:'FC Barcelona',      league:'ll', assists:12, games:26 },
    { player:'Hakan Calhanoglu',  team:'Inter Milan',       league:'sa', assists:11, games:25 },
    { player:'Khvicha Kvaratskhelia',team:'PSG',            league:'l1', assists:12, games:24 },
    { player:'Florian Wirtz',     team:'Bayer Leverkusen',  league:'bl', assists:11, games:22 },
    { player:'Jamal Musiala',     team:'Bayern Munich',     league:'bl', assists:10, games:23 },
  ],

  euroFixtures: [
    // UCL Round of 16 — Big 5 clubs — Feb/Mar 2026
    { comp:'UCL', compCls:'euro-comp-ucl', round:'Round of 16 · 1st Leg', home:'Arsenal',        away:'PSG',              date:'2026-03-04', time:'20:00', result:null, homeLeague:'pl', awayLeague:'l1' },
    { comp:'UCL', compCls:'euro-comp-ucl', round:'Round of 16 · 1st Leg', home:'Inter Milan',    away:'Bayern Munich',    date:'2026-03-04', time:'20:00', result:null, homeLeague:'sa', awayLeague:'bl' },
    { comp:'UCL', compCls:'euro-comp-ucl', round:'Round of 16 · 1st Leg', home:'Real Madrid',    away:'Manchester City',  date:'2026-03-11', time:'20:00', result:null, homeLeague:'ll', awayLeague:'pl' },
    { comp:'UCL', compCls:'euro-comp-ucl', round:'Round of 16 · 1st Leg', home:'FC Barcelona',   away:'Borussia Dortmund',date:'2026-03-11', time:'20:00', result:null, homeLeague:'ll', awayLeague:'bl' },
    { comp:'UCL', compCls:'euro-comp-ucl', round:'Round of 16 · 1st Leg', home:'Liverpool',      away:'Atletico Madrid',  date:'2026-03-18', time:'20:00', result:null, homeLeague:'pl', awayLeague:'ll' },
    { comp:'UCL', compCls:'euro-comp-ucl', round:'Round of 16 · 1st Leg', home:'Bayer Leverkusen',away:'Napoli',          date:'2026-03-18', time:'20:00', result:null, homeLeague:'bl', awayLeague:'sa' },
    // UEL Round of 16
    { comp:'UEL', compCls:'euro-comp-uel', round:'Round of 16 · 1st Leg', home:'Manchester Utd', away:'Athletic Club',    date:'2026-03-05', time:'20:00', result:null, homeLeague:'pl', awayLeague:'ll' },
    { comp:'UEL', compCls:'euro-comp-uel', round:'Round of 16 · 1st Leg', home:'Roma',           away:'Lyon',             date:'2026-03-05', time:'20:00', result:null, homeLeague:'sa', awayLeague:'l1' },
    { comp:'UEL', compCls:'euro-comp-uel', round:'Round of 16 · 1st Leg', home:'Tottenham',      away:'Frankfurt',        date:'2026-03-12', time:'20:00', result:null, homeLeague:'pl', awayLeague:'bl' },
    // UECL Round of 16
    { comp:'UECL', compCls:'euro-comp-uecl', round:'Round of 16 · 1st Leg', home:'Chelsea',      away:'Real Betis',       date:'2026-03-05', time:'18:45', result:null, homeLeague:'pl', awayLeague:'ll' },
    { comp:'UECL', compCls:'euro-comp-uecl', round:'Round of 16 · 1st Leg', home:'Fiorentina',   away:'Rapid Wien',       date:'2026-03-12', time:'18:45', result:null, homeLeague:'sa', awayLeague:null },
    // Recent KO Play-off results (for context)
    { comp:'UCL', compCls:'euro-comp-ucl', round:'KO Play-off · 2nd Leg',  home:'Newcastle',     away:'Qarabag',          date:'2026-02-18', time:'17:45', result:{h:4,a:0}, homeLeague:'pl', awayLeague:null },
    { comp:'UCL', compCls:'euro-comp-ucl', round:'KO Play-off · 2nd Leg',  home:'Inter Milan',   away:'Bodo/Glimt',       date:'2026-02-18', time:'20:00', result:{h:3,a:0}, homeLeague:'sa', awayLeague:null },
  ],

  // ─── VERIFIED RESULTS & REAL UPCOMING FIXTURES ───
  fixtures: {
    // Premier League — MW27 results confirmed + MW28 upcoming (from Soccerway/Flashscore)
    pl: [
      // MW27 RESULTS (21–22 Feb 2026) — verified
      { home:'Aston Villa',      away:'Leeds United',    date:'2026-02-21', time:'15:00', week:27, result:{h:1,a:1} },
      { home:'Brentford',        away:'Brighton',        date:'2026-02-21', time:'15:00', week:27, result:{h:0,a:2} },
      { home:'Chelsea',          away:'Burnley',         date:'2026-02-21', time:'15:00', week:27, result:{h:1,a:1} },
      { home:'West Ham',         away:'Bournemouth',     date:'2026-02-21', time:'17:30', week:27, result:{h:0,a:0} },
      { home:'Manchester City',  away:'Newcastle',       date:'2026-02-21', time:'20:00', week:27, result:{h:2,a:1} },
      { home:'Sunderland',       away:'Fulham',          date:'2026-02-22', time:'14:00', week:27, result:{h:1,a:3} },
      { home:'Crystal Palace',   away:'Wolves',          date:'2026-02-22', time:'14:00', week:27, result:{h:1,a:0} },
      { home:'Nottm Forest',     away:'Liverpool',       date:'2026-02-22', time:'14:00', week:27, result:{h:0,a:1} },
      { home:'Tottenham',        away:'Arsenal',         date:'2026-02-22', time:'16:30', week:27, result:{h:1,a:4}, note:'North London Derby' },
      { home:'Everton',          away:'Man Utd',         date:'2026-02-23', time:'20:00', week:27, result:null, note:'Tonight (23 Feb)' },
      // MW28 UPCOMING (27 Feb – 3 Mar 2026)
      { home:'Wolves',           away:'Aston Villa',     date:'2026-02-27', time:'20:00', week:28, result:null },
      { home:'Bournemouth',      away:'Sunderland',      date:'2026-02-28', time:'12:30', week:28, result:null },
      { home:'Burnley',          away:'Brentford',       date:'2026-02-28', time:'15:00', week:28, result:null },
      { home:'Liverpool',        away:'West Ham',        date:'2026-02-28', time:'15:00', week:28, result:null },
      { home:'Newcastle',        away:'Everton',         date:'2026-02-28', time:'15:00', week:28, result:null },
      { home:'Leeds United',     away:'Manchester City', date:'2026-02-28', time:'17:30', week:28, result:null },
      { home:'Brighton',         away:'Nottm Forest',    date:'2026-03-01', time:'14:00', week:28, result:null },
      { home:'Fulham',           away:'Tottenham',       date:'2026-03-01', time:'14:00', week:28, result:null },
      { home:'Manchester Utd',   away:'Crystal Palace',  date:'2026-03-01', time:'14:00', week:28, result:null },
      { home:'Arsenal',          away:'Chelsea',         date:'2026-03-01', time:'16:30', week:28, result:null, note:'Top-of-table clash' },
    ],
    // La Liga — GW26 results + upcoming GW27 (from Flashscore/Soccerway)
    ll: [
      // GW26 RESULTS (21–22 Feb 2026) — verified
      { home:'Real Betis',       away:'Rayo Vallecano',  date:'2026-02-21', time:'14:00', week:26, result:{h:2,a:1} },
      { home:'Osasuna',          away:'Real Madrid',     date:'2026-02-21', time:'14:00', week:26, result:{h:2,a:1} },
      { home:'Atletico Madrid',  away:'Espanyol',        date:'2026-02-21', time:'20:00', week:26, result:{h:4,a:2} },
      { home:'Getafe',           away:'Sevilla',         date:'2026-02-22', time:'14:00', week:26, result:{h:0,a:1} },
      { home:'Barcelona',        away:'Levante',         date:'2026-02-22', time:'16:15', week:26, result:{h:3,a:0} },
      { home:'Celta Vigo',       away:'Mallorca',        date:'2026-02-22', time:'18:30', week:26, result:{h:2,a:0} },
      { home:'Villarreal',       away:'Valencia',        date:'2026-02-22', time:'20:00', week:26, result:{h:2,a:1} },
      { home:'Alaves',           away:'Girona',          date:'2026-02-23', time:'20:00', week:26, result:null, note:'Tonight' },
      // GW27 UPCOMING
      { home:'Levante',          away:'Alaves',          date:'2026-02-27', time:'20:00', week:27, result:null },
      { home:'Rayo Vallecano',   away:'Athletic Club',   date:'2026-02-28', time:'14:00', week:27, result:null },
      { home:'Barcelona',        away:'Villarreal',      date:'2026-02-28', time:'16:15', week:27, result:null },
      { home:'Mallorca',         away:'Real Sociedad',   date:'2026-02-28', time:'18:30', week:27, result:null },
      { home:'Real Oviedo',      away:'Atletico Madrid', date:'2026-02-28', time:'20:00', week:27, result:null },
      { home:'Real Madrid',      away:'Getafe',          date:'2026-03-02', time:'20:00', week:27, result:null },
    ],
    // Serie A — R26 results + R27 upcoming
    sa: [
      // R26 RESULTS (20–22 Feb 2026) — verified
      { home:'Sassuolo',         away:'Hellas Verona',   date:'2026-02-20', time:'20:45', week:26, result:{h:3,a:0} },
      { home:'Juventus',         away:'Como',            date:'2026-02-21', time:'15:00', week:26, result:{h:0,a:2} },
      { home:'Lecce',            away:'Inter Milan',     date:'2026-02-21', time:'18:00', week:26, result:{h:0,a:2} },
      { home:'Cagliari',         away:'Lazio',           date:'2026-02-21', time:'20:45', week:26, result:{h:0,a:0} },
      { home:'Genoa',            away:'Torino',          date:'2026-02-22', time:'12:30', week:26, result:{h:3,a:0} },
      { home:'Atalanta',         away:'Napoli',          date:'2026-02-22', time:'15:00', week:26, result:{h:2,a:1} },
      { home:'AC Milan',         away:'Parma',           date:'2026-02-22', time:'18:00', week:26, result:{h:0,a:1} },
      { home:'AS Roma',          away:'Cremonese',       date:'2026-02-22', time:'20:45', week:26, result:{h:3,a:0} },
      { home:'Fiorentina',       away:'Pisa',            date:'2026-02-23', time:'17:30', week:26, result:null, note:'Tonight' },
      { home:'Bologna',          away:'Udinese',         date:'2026-02-23', time:'20:45', week:26, result:null, note:'Tonight' },
      // R27 UPCOMING
      { home:'Parma',            away:'Cagliari',        date:'2026-02-27', time:'20:45', week:27, result:null },
      { home:'Como',             away:'Lecce',           date:'2026-02-28', time:'15:00', week:27, result:null },
      { home:'Hellas Verona',    away:'Napoli',          date:'2026-02-28', time:'18:00', week:27, result:null },
      { home:'Inter Milan',      away:'Genoa',           date:'2026-02-28', time:'20:45', week:27, result:null },
      { home:'Cremonese',        away:'AC Milan',        date:'2026-03-01', time:'15:00', week:27, result:null },
      { home:'AS Roma',          away:'Juventus',        date:'2026-03-01', time:'20:45', week:27, result:null, note:'Rome Derby vibes' },
    ],
    // Bundesliga — MD23 results + MD24 upcoming (28 Feb Klassiker: Dortmund v Bayern)
    bl: [
      // MD23 RESULTS (20–22 Feb 2026) — verified
      { home:'Mainz 05',         away:'Hamburger SV',    date:'2026-02-20', time:'20:30', week:23, result:{h:1,a:1} },
      { home:'Union Berlin',     away:'Bayer Leverkusen',date:'2026-02-21', time:'15:30', week:23, result:{h:1,a:0} },
      { home:'Bayern Munich',    away:'Eintracht Frankfurt',date:'2026-02-21',time:'15:30',week:23,result:{h:3,a:2} },
      { home:'Wolfsburg',        away:'Augsburg',        date:'2026-02-21', time:'15:30', week:23, result:{h:2,a:3} },
      { home:'1. FC Köln',       away:'Hoffenheim',      date:'2026-02-21', time:'15:30', week:23, result:{h:2,a:2} },
      { home:'RB Leipzig',       away:'Borussia Dortmund',date:'2026-02-21',time:'18:30', week:23, result:{h:2,a:2} },
      { home:'SC Freiburg',      away:'M\'gladbach',     date:'2026-02-22', time:'15:30', week:23, result:{h:2,a:1} },
      { home:'St. Pauli',        away:'Werder Bremen',   date:'2026-02-22', time:'17:30', week:23, result:{h:2,a:1} },
      { home:'Heidenheim',       away:'VfB Stuttgart',   date:'2026-02-22', time:'17:30', week:23, result:{h:3,a:3} },
      // MD24 UPCOMING — note the Klassiker: Dortmund v Bayern
      { home:'Augsburg',         away:'1. FC Köln',      date:'2026-02-27', time:'20:30', week:24, result:null },
      { home:'Bayer Leverkusen', away:'Mainz 05',        date:'2026-02-28', time:'15:30', week:24, result:null },
      { home:'Werder Bremen',    away:'Heidenheim',      date:'2026-02-28', time:'15:30', week:24, result:null },
      { home:'M\'gladbach',      away:'Union Berlin',    date:'2026-02-28', time:'15:30', week:24, result:null },
      { home:'Hoffenheim',       away:'St. Pauli',       date:'2026-02-28', time:'15:30', week:24, result:null },
      { home:'Borussia Dortmund',away:'Bayern Munich',   date:'2026-02-28', time:'18:30', week:24, result:null, note:'Der Klassiker' },
      { home:'VfB Stuttgart',    away:'Wolfsburg',       date:'2026-03-01', time:'15:30', week:24, result:null },
      { home:'Eintracht Frankfurt',away:'SC Freiburg',   date:'2026-03-01', time:'15:30', week:24, result:null },
      { home:'Hamburger SV',     away:'RB Leipzig',      date:'2026-03-01', time:'15:30', week:24, result:null },
    ],
    // Ligue 1 — MD22 results + MD23 upcoming
    l1: [
      // MD22 RESULTS (20–21 Feb 2026) — verified from ESPN/PSG.fr
      { home:'Brest',            away:'Marseille',       date:'2026-02-20', time:'19:00', week:22, result:{h:2,a:0} },
      { home:'Lens',             away:'Monaco',          date:'2026-02-21', time:'16:00', week:22, result:{h:2,a:3} },
      { home:'Toulouse',         away:'Paris FC',        date:'2026-02-21', time:'18:00', week:22, result:{h:1,a:1} },
      { home:'PSG',              away:'Metz',            date:'2026-02-21', time:'20:05', week:22, result:{h:3,a:0} },
      // MD22 SUNDAY GAMES (22 Feb) — fixture from Soccerway
      { home:'Auxerre',          away:'Rennes',          date:'2026-02-22', time:'14:00', week:22, result:{h:0,a:3} },
      { home:'Angers',           away:'Lille',           date:'2026-02-22', time:'16:15', week:22, result:{h:0,a:1} },
      { home:'Nantes',           away:'Le Havre',        date:'2026-02-22', time:'16:15', week:22, result:{h:2,a:0} },
      { home:'Nice',             away:'Lorient',         date:'2026-02-22', time:'16:15', week:22, result:{h:3,a:3} },
      { home:'Strasbourg',       away:'Lyon',            date:'2026-02-22', time:'19:45', week:22, result:null, note:'Late kick-off' },
      // MD23 UPCOMING
      { home:'Strasbourg',       away:'Lens',            date:'2026-02-27', time:'20:00', week:23, result:null },
      { home:'Rennes',           away:'Toulouse',        date:'2026-02-28', time:'15:00', week:23, result:null },
      { home:'Monaco',           away:'Angers',          date:'2026-02-28', time:'17:00', week:23, result:null },
      { home:'Le Havre',         away:'PSG',             date:'2026-02-28', time:'20:00', week:23, result:null },
      { home:'Marseille',        away:'Lyon',            date:'2026-03-01', time:'20:45', week:23, result:null },
    ],
  },

  predictions: [
    // *** UPDATED 23 FEB 2026 — MW28 (28 Feb – 2 Mar) + MW29 (1 Mar) ***
    {
      id:1, league:'pl', leagueTag:'tag-pl',
      home:'Bournemouth', away:'Sunderland',
      date:'2026-02-28', time:'12:30',
      probH:52, probD:26, probA:22,
      pick:'Bournemouth Win', confidence:'high',
      expGoals:'2.4', expYellow:'4', expRed:'0.1',
      playerToBook:'Jobe Bellingham (Sunderland) — 6Y, press-heavy role, away day aggression',
      reasoning:'Bournemouth 6th, excellent home form (10W 3D). Sunderland promoted, struggling in away games — 2W 6L away this season. Vitinho and Kluivert in fine form. TNT Sports.',
      note:'12:30 kick-off · TNT Sports',
    },
    {
      id:2, league:'pl', leagueTag:'tag-pl',
      home:'Leeds United', away:'Manchester City',
      date:'2026-02-28', time:'17:30',
      probH:28, probD:25, probA:47,
      pick:'Manchester City Win', confidence:'medium',
      expGoals:'2.8', expYellow:'4', expRed:'0.1',
      playerToBook:'Wharton (Leeds) — 7Y, tasked with stopping City press',
      reasoning:'Man City finding form — 4W in last 5. Leeds Utd back in PL are defensively vulnerable away. Haaland returning to form. However Leeds passionate home crowd a factor. Sky Sports.',
      note:'17:30 · Sky Sports',
    },
    {
      id:3, league:'pl', leagueTag:'tag-pl',
      home:'Arsenal', away:'Chelsea',
      date:'2026-03-01', time:'16:30',
      probH:48, probD:26, probA:26,
      pick:'Arsenal Win + 4+ Cards', confidence:'high',
      expGoals:'2.5', expYellow:'5', expRed:'0.2',
      playerToBook:'Caicedo (Chelsea) — 7Y this season, Arsenal intensity triggers him',
      reasoning:'Arsenal top of the table, unbeaten at Emirates in 2026. Chelsea improving under new manager but still conceding on the road. Saka and Martinelli key threats. Big cards game expected. Sky Sports.',
      note:'Top-of-table clash · Sky Sports',
    },
    {
      id:4, league:'pl', leagueTag:'tag-pl',
      home:'Fulham', away:'Tottenham',
      date:'2026-03-01', time:'14:00',
      probH:38, probD:28, probA:34,
      pick:'Both Teams to Score', confidence:'medium',
      expGoals:'2.6', expYellow:'4', expRed:'0.1',
      playerToBook:'Palhinha (Fulham) — 6Y, combative against Spurs quick transitions',
      reasoning:'Both teams have scored in their last 7 consecutive games. Fulham strong at Craven Cottage, Spurs unpredictable away. Son and Wilson both in goalscoring form. Sky Sports.',
      note:'14:00 · Sky Sports',
    },
    {
      id:5, league:'ll', leagueTag:'tag-ll',
      home:'Barcelona', away:'Villarreal',
      date:'2026-02-28', time:'16:15',
      probH:62, probD:22, probA:16,
      pick:'Barcelona Win', confidence:'high',
      expGoals:'2.7', expYellow:'4', expRed:'0.1',
      playerToBook:'Baena (Villarreal) — 5Y, will target Barca midfield press',
      reasoning:'Barca on a 6-game winning run, scored 3+ in 4 of last 5 at Spotify Camp Nou. Villarreal mid-table, away record poor — 3W 4D 6L. Lewandowski back to best form with 22 goals. Premier Sports.',
      note:'16:15 · Premier Sports',
    },
    {
      id:6, league:'sa', leagueTag:'tag-sa',
      home:'Inter Milan', away:'Genoa',
      date:'2026-02-28', time:'20:45',
      probH:68, probD:19, probA:13,
      pick:'Inter Win to Nil', confidence:'high',
      expGoals:'2.1', expYellow:'3', expRed:'0.1',
      playerToBook:'Badelj (Genoa) — 5Y, will foul to slow Inter transitions',
      reasoning:'Inter best defence in Serie A — conceded just 16 in 26 games. Genoa in mid-table, toothless away — 4 goals in last 7 away games. Lautaro and Thuram too strong. TNT Sports.',
      note:'20:45 · TNT Sports',
    },
    {
      id:7, league:'bl', leagueTag:'tag-bl',
      home:'Bayern Munich', away:'Bochum',
      date:'2026-02-28', time:'15:30',
      probH:82, probD:11, probA:7,
      pick:'Bayern Win + Over 3.5 Goals', confidence:'high',
      expGoals:'3.8', expYellow:'3', expRed:'0.0',
      playerToBook:'Losilla (Bochum) — 5Y, veteran DM will commit fouls to slow Bayern',
      reasoning:'Bayern scoring machine — 2.9 goals/game at Allianz. Bochum bottom 3, worst away record in Bundesliga (1W 11L). Kane on 24 goals. Sky Sports.',
      note:'15:30 · Sky Sports',
    },
    {
      id:8, league:'l1', leagueTag:'tag-l1',
      home:'PSG', away:'Nice',
      date:'2026-03-01', time:'21:00',
      probH:61, probD:22, probA:17,
      pick:'PSG Win', confidence:'high',
      expGoals:'2.4', expYellow:'4', expRed:'0.1',
      playerToBook:'Dante (Nice) — 6Y, veteran CB clashes with PSG attackers',
      reasoning:'PSG dominating Ligue 1 — 15W 3D at Parc des Princes. Barcola in brilliant form with 14 league goals. Nice strong defensively but lacking goals away from home. Ligue 1+.',
      note:'21:00 · Ligue 1+',
    },
  ],

  cardForecast: [
    { match:'Arsenal vs Chelsea',      league:'pl', expCards:5.0, refStrictness:'High',   highRisk:'Caicedo, White',        referee:'Michael Oliver' },
    { match:'Bournemouth vs Sunderland',league:'pl', expCards:3.8, refStrictness:'Medium', highRisk:'J.Bellingham, Cook',   referee:'Andy Madley' },
    { match:'Barcelona vs Villarreal', league:'ll', expCards:4.2, refStrictness:'Medium', highRisk:'Baena, De Jong',         referee:'Alejandro Hernández' },
    { match:'Inter vs Genoa',          league:'sa', expCards:3.5, refStrictness:'Low',    highRisk:'Badelj, Barella',        referee:'Davide Massa' },
    { match:'Bayern vs Bochum',        league:'bl', expCards:3.2, refStrictness:'Low',    highRisk:'Losilla, Pavard',        referee:'Felix Brych' },
    { match:'PSG vs Nice',             league:'l1', expCards:4.1, refStrictness:'High',   highRisk:'Dante, Fabian',          referee:'François Letexier' },
  ],

  cardForecast: [
    { match:'Liverpool vs Arsenal',   league:'pl', expCards:5.2, refStrictness:'High',   highRisk:'Xhaka, Trent', referee:'Anthony Taylor' },
    { match:'El Clásico',             league:'ll', expCards:6.8, refStrictness:'V.High', highRisk:'Bellingham, Gavi', referee:'Ricardo de Burgos' },
    { match:'Roma vs Lazio (Derby)',   league:'sa', expCards:6.1, refStrictness:'Medium', highRisk:'Koné, Castellanos', referee:'Daniele Orsato' },
    { match:'Leverkusen vs Dortmund', league:'bl', expCards:4.0, refStrictness:'Medium', highRisk:'Xhaka, Sabitzer', referee:'Felix Zwayer' },
    { match:'PSG vs Marseille',       league:'l1', expCards:5.4, refStrictness:'High',   highRisk:'Rabiot, Veretout', referee:'François Letexier' },
    { match:'Chelsea vs Man Utd',     league:'pl', expCards:4.2, refStrictness:'Medium', highRisk:'Casemiro, Caicedo', referee:'Michael Oliver' },
  ],
};

// ============================================================
// RENDER FUNCTIONS
// ============================================================

// ── UK TV CHANNEL LOOKUP ──
// Based on verified 2024-25 broadcast rights:
// PL: Sky Sports (215 games) + TNT Sports (52 games)
// La Liga: Premier Sports (340 games/season)
// Serie A: TNT Sports (selected) + DAZN (all games)
// Bundesliga: Sky Sports (Sat/Sun) + BBC iPlayer (Friday)
// Ligue 1: Ligue 1+ pass (£9.99/mo) — no TNT from 2024-25
const UK_TV = {
  // Premier League — MW28 confirmed picks
  'Bournemouth_Sunderland':   { channel:'TNT Sports', cls:'tv-tnt' },
  'Burnley_Brentford':        { channel:'Sky Sports', cls:'tv-sky' },
  'Liverpool_West Ham':       { channel:'Sky Sports', cls:'tv-sky' },
  'Newcastle_Everton':        { channel:'Sky Sports', cls:'tv-sky' },
  'Leeds United_Manchester City': { channel:'Sky Sports', cls:'tv-sky' },
  'Brighton_Nottm Forest':    { channel:'Sky Sports', cls:'tv-sky' },
  'Fulham_Tottenham':         { channel:'Sky Sports', cls:'tv-sky' },
  'Manchester Utd_Crystal Palace': { channel:'Sky Sports', cls:'tv-sky' },
  'Arsenal_Chelsea':          { channel:'Sky Sports', cls:'tv-sky' },
  // MW29
  'Bournemouth_Brentford':    { channel:'TNT Sports', cls:'tv-tnt' },
  'Everton_Burnley':          { channel:'TNT Sports', cls:'tv-tnt' },
  'Leeds_Sunderland':         { channel:'TNT Sports', cls:'tv-tnt' },
  'Wolves_Liverpool':         { channel:'TNT Sports', cls:'tv-tnt' },
  'Aston Villa_Chelsea':      { channel:'TNT Sports', cls:'tv-tnt' },
  'Brighton_Arsenal':         { channel:'TNT Sports', cls:'tv-tnt' },
  'Fulham_West Ham':          { channel:'TNT Sports', cls:'tv-tnt' },
  'Manchester City_Nottm Forest': { channel:'TNT Sports', cls:'tv-tnt' },
  'Newcastle_Manchester Utd': { channel:'TNT Sports', cls:'tv-tnt' },
  'Tottenham_Crystal Palace': { channel:'TNT Sports', cls:'tv-tnt' },
  // La Liga — Premier Sports
  'Barcelona_Villarreal':     { channel:'Premier Sports', cls:'tv-premier' },
  'Atletico Madrid_Osasuna':  { channel:'Premier Sports', cls:'tv-premier' },
  'Real Madrid_Getafe':       { channel:'Premier Sports', cls:'tv-premier' },
  // Serie A — TNT Sports selected + DAZN all
  'Inter Milan_Genoa':        { channel:'TNT Sports', cls:'tv-tnt' },
  'Juventus_Como':            { channel:'TNT Sports', cls:'tv-tnt' },
  'Atalanta_Napoli':          { channel:'TNT Sports', cls:'tv-tnt' },
  // Bundesliga — Sky Sports
  'Bayern Munich_Bochum':     { channel:'Sky Sports', cls:'tv-sky' },
  'RB Leipzig_Borussia Dortmund': { channel:'Sky Sports', cls:'tv-sky' },
  // Ligue 1 — Ligue 1+ pass only
  'PSG_Nice':                 { channel:'Ligue 1+', cls:'tv-ligue1' },
  'Marseille_Monaco':         { channel:'Ligue 1+', cls:'tv-ligue1' },
};

function getTvBadge(home, away) {
  const key1 = home + '_' + away;
  const key2 = away + '_' + home;
  const tv = UK_TV[key1] || UK_TV[key2];
  if (!tv) return '';
  return '<span class="tv-badge ' + tv.cls + '">📺 ' + tv.channel + '</span>';
}

function renderTicker() {
  const results = [];
  Object.entries(DEMO.fixtures).forEach(([leagueKey, fxs]) => {
    fxs.filter(f => f.result).forEach(f => {
      const lg = LEAGUES[leagueKey];
      results.push(`<span class="ticker-item"><span class="ticker-team">${f.home}</span> <span class="ticker-score">${f.result.h}–${f.result.a}</span> <span class="ticker-team">${f.away}</span> <span style="color:var(--white-dim);font-size:.75em;">(${lg.name})</span></span>`);
    });
  });
  const ticker = document.getElementById('tickerContent');
  if (results.length) {
    ticker.innerHTML = results.join('') + results.join('');
  }
}

function renderOverview() {
  // KPIs
  let totals = {played:0, goals:0, yellow:0, red:0};
  Object.values(DEMO.seasonStats).forEach(s => {
    totals.played += s.played;
    totals.goals += s.goals;
    totals.yellow += s.yellowCards;
    totals.red += s.redCards;
  });
  const avgGoals = (totals.goals / totals.played).toFixed(2);
  const avgY = (totals.yellow / totals.played).toFixed(2);
  const avgR = (totals.red / totals.played).toFixed(2);

  document.getElementById('kpiMatches').textContent = totals.played.toLocaleString();
  document.getElementById('kpiGoals').textContent = avgGoals;
  document.getElementById('kpiYellow').textContent = totals.yellow.toLocaleString();
  document.getElementById('kpiYellowPG').textContent = `${avgY} per game average`;
  document.getElementById('kpiRed').textContent = totals.red.toLocaleString();
  document.getElementById('kpiRedPG').textContent = `${avgR} per game average`;

  // League summary table
  const leagueRows = Object.entries(DEMO.seasonStats).map(([k, s]) => {
    const lg = LEAGUES[k];
    const strictness = Math.round((s.avgYellow / 5) * 100);
    const barWidth = Math.min(100, strictness);
    return `<tr>
      <td><span class="fixture-league-tag ${LEAGUES[k].tag}" style="padding:2px 8px;border-radius:2px;font-size:.72rem;font-weight:700;letter-spacing:1px;">${lg.name}</span></td>
      <td class="num">${s.played}</td>
      <td class="num" style="color:var(--accent)">${s.avgGoals.toFixed(2)}</td>
      <td class="num" style="color:var(--yellow-card)">${s.avgYellow.toFixed(2)}</td>
      <td class="num" style="color:var(--red-card)">${s.avgRed.toFixed(2)}</td>
      <td class="num"><div class="ref-strictness"><div class="ref-strictness-bar" style="width:${barWidth}%"></div></div></td>
    </tr>`;
  }).join('');
  document.getElementById('leagueSummaryBody').innerHTML = leagueRows;

  // Top booked teams
  const teamRows = DEMO.bookedTeams.slice(0,10).map((t, i) => {
    const lg = LEAGUES[t.league];
    return `<tr>
      <td><span class="rank-num">${i+1}</span></td>
      <td><strong>${t.team}</strong></td>
      <td class="num"><span style="color:var(--yellow-card);font-weight:700;">${t.yellow}</span></td>
      <td class="num"><span style="color:var(--red-card);font-weight:700;">${t.red}</span></td>
      <td class="num" style="font-weight:700;">${t.bp}</td>
    </tr>`;
  }).join('');
  document.getElementById('topBookedTeamsBody').innerHTML = teamRows;

  // Top scorers
  document.getElementById('topScorersList').innerHTML = DEMO.scorers.map((p,i) => `
    <div class="player-row">
      <div class="player-avatar">${p.player.charAt(0)}</div>
      <div style="flex:1">
        <div class="player-name">${p.player}</div>
        <span class="player-team">${p.team}</span>
      </div>
      <span class="fixture-league-tag ${LEAGUES[p.league].tag}" style="padding:1px 6px;border-radius:2px;font-size:.68rem;font-weight:700;">${LEAGUES[p.league].name.split(' ').pop()}</span>
      <div class="player-stat" style="color:var(--accent)">${p.goals}</div>
    </div>`).join('');

  // Top booked players
  document.getElementById('topBookedPlayersList').innerHTML = DEMO.bookedPlayers.slice(0,8).map((p,i) => `
    <div class="player-row">
      <div class="player-avatar">${p.player.charAt(0)}</div>
      <div style="flex:1">
        <div class="player-name">${p.player}</div>
        <span class="player-team">${p.team}</span>
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        <span class="booking-card-visual yellow" style="width:14px;height:18px;display:inline-block;border-radius:2px;background:linear-gradient(135deg,#f5c842,#d4a820)"></span>
        <span style="font-family:'Barlow Condensed';font-weight:700;font-size:.95rem;color:var(--yellow-card)">${p.yellow}</span>
        ${p.red ? `<span class="booking-card-visual red" style="width:14px;height:18px;display:inline-block;border-radius:2px;background:linear-gradient(135deg,#e63946,#9b2128)"></span><span style="font-family:'Barlow Condensed';font-weight:700;font-size:.95rem;color:var(--red-card)">${p.red}</span>` : ''}
      </div>
    </div>`).join('');

  // Top assists
  const assists = DEMO.assists || [];
  const assistsEl = document.getElementById('topAssistsList');
  if (assistsEl) {
    if (!assists.length) {
      assistsEl.innerHTML = '<div style="color:var(--white-dim);padding:20px;text-align:center;font-family:Barlow Condensed">Loading assists data…</div>';
    } else {
      const maxA = assists[0].assists;
      assistsEl.innerHTML = assists.slice(0,10).map((p,i) => {
        const lg = LEAGUES[p.league];
        return '<div class="player-row">' +
          '<div class="player-avatar" style="background:linear-gradient(135deg,#1a4fa0,#1a7a5a)">' + p.player.charAt(0) + '</div>' +
          '<div style="flex:1">' +
            '<div class="player-name">' + p.player + '</div>' +
            '<span class="player-team">' + p.team + '</span>' +
          '</div>' +
          (lg ? '<span class="fixture-league-tag ' + lg.tag + '" style="padding:1px 6px;border-radius:2px;font-size:.68rem;font-weight:700;">' + lg.name.split(' ').pop() + '</span>' : '') +
          '<div class="player-stat" style="color:#4da6ff">' + p.assists + '</div>' +
        '</div>';
      }).join('');
    }
  }

  // Fav next fixtures on overview
  renderFavNextFixtures();
  renderOracleTips();
  renderWorldCup();
}

function renderFixtures() {
  const grid = document.getElementById('fixturesGrid');
  let allFixtures = [];
  Object.entries(DEMO.fixtures).forEach(([leagueKey, fxs]) => {
    fxs.forEach(f => allFixtures.push({...f, leagueKey}));
  });

  const isUpcoming = state.fixtureTab === 'upcoming';
  const filtered = allFixtures.filter(f => isUpcoming ? !f.result : !!f.result);

  grid.innerHTML = filtered.map(f => {
    const lg = LEAGUES[f.leagueKey];
    const matchDate = new Date(f.date);
    const dateStr = matchDate.toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short'});
    const isResult = !!f.result;

    // Find prediction
    const pred = DEMO.predictions.find(p => 
      (p.home === f.home && p.away === f.away) ||
      (p.home === f.away && p.away === f.home)
    );

    let vsContent = isResult
      ? `<span class="fixture-vs result">${f.result.h} – ${f.result.a}</span>`
      : `<span class="fixture-vs">${f.time}</span>`;

    let predHtml = '';
    if (!isResult && pred) {
      predHtml = `
        <div class="fixture-predictions">
          <div class="pred-item">
            <div class="pred-label">Prediction</div>
            <div class="pred-value highlight">${pred.pick.split(' ').slice(0,2).join(' ')}</div>
          </div>
          <div class="pred-item">
            <div class="pred-label">Exp Goals</div>
            <div class="pred-value">${pred.expGoals}</div>
          </div>
          <div class="pred-item">
            <div class="pred-label">Exp Cards</div>
            <div class="pred-value danger">${pred.expYellow} 🟨</div>
          </div>
        </div>
        <div class="prob-bar-container" style="margin-top:10px">
          <div class="prob-bar-h" style="width:${pred.probH}%"></div>
          <div class="prob-bar-d" style="width:${pred.probD}%"></div>
          <div class="prob-bar-a" style="width:${pred.probA}%"></div>
        </div>
        <div class="prob-labels">
          <span>H ${pred.probH}%</span>
          <span>D ${pred.probD}%</span>
          <span>A ${pred.probA}%</span>
        </div>
        ${(()=>{
          const h2hKey = Object.keys(DEMO.h2h).find(k => k.includes(f.home) || k.includes(f.away));
          const h2hData = h2hKey ? DEMO.h2h[h2hKey] : null;
          if (!h2hData) return '';
          return '<div class="h2h-mini"><div class="h2h-mini-title">⚔️ LAST 5 H2H</div>' +
            h2hData.slice(0,3).map(m => '<div class="h2h-result-row"><span>' + m.h + ' vs ' + m.a + '</span><span class="h2h-score">' + m.r.h + '–' + m.r.a + '</span></div>').join('') +
            '</div>';
        })()}`;
    } else if (isResult) {
      const hw = f.result.h > f.result.a ? 'W' : f.result.h < f.result.a ? 'L' : 'D';
      // Find H2H record
      const h2hKey = Object.keys(DEMO.h2h).find(k => k.includes(f.home) || k.includes(f.away));
      const h2hData = h2hKey ? DEMO.h2h[h2hKey] : null;
      const h2hHtml = h2hData ? `
        <div class="h2h-mini">
          <div class="h2h-mini-title">⚔️ LAST 5 MEETINGS</div>
          ${h2hData.slice(0,5).map(m => {
            const win = m.r.h > m.r.a ? m.h : m.r.h < m.r.a ? m.a : 'Draw';
            return `<div class="h2h-result-row"><span>${m.h} vs ${m.a}</span><span class="h2h-score">${m.r.h}–${m.r.a}</span></div>`;
          }).join('')}
        </div>` : '';
      predHtml = `
        <div class="fixture-predictions">
          <div class="pred-item">
            <div class="pred-label">Result</div>
            <div class="pred-value" style="color:${hw==='W'?'var(--accent)':hw==='L'?'var(--red-card)':'var(--gold)'}">${hw==='W'?'Home Win':hw==='L'?'Away Win':'Draw'}</div>
          </div>
          <div class="pred-item">
            <div class="pred-label">Goals</div>
            <div class="pred-value">${f.result.h + f.result.a}</div>
          </div>
          <div class="pred-item">
            <div class="pred-label">Date</div>
            <div class="pred-value" style="font-size:.78rem">${dateStr}</div>
          </div>
        </div>
        ${h2hHtml}`;
    }

    return `
      <div class="fixture-card fade-in">
        <div class="fixture-top">
          <span class="fixture-league-tag ${lg.tag}" style="padding:2px 8px;border-radius:2px;font-size:.7rem;font-weight:700;letter-spacing:1.5px;">${lg.name}</span>
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:4px;">
            <span class="fixture-date">${dateStr} · MW${f.week}${f.note?' · <span style="color:var(--gold)">'+f.note+'</span>':''}${f.referee?' · <span style="color:var(--white-dim);font-size:.72em">👮 '+f.referee+'</span>':''}</span>
            <div style="display:flex;align-items:center;gap:6px;">
              ${getTvBadge(f.home, f.away)}
              <span class="fav-star ${isFavTeam(f.home)||isFavTeam(f.away)?'active':'inactive'}" onclick="toggleFavFromFixture('${f.home}','${f.away}',event)" title="Follow team">★</span>
            </div>
          </div>
        </div>
        <div class="fixture-teams">
          <div style="text-align:center;flex:1;">
            <div class="fixture-team home">${f.home}</div>
            ${(()=>{const s=getTeamForm(f.home,f.leagueKey);return s?'<div class="team-form-mini">'+s.split('').map(r=>'<div class="form-dot-mini '+r+'"></div>').join('')+'</div>':''})()}
          </div>
          ${vsContent}
          <div style="text-align:center;flex:1;">
            <div class="fixture-team away">${f.away}</div>
            ${(()=>{const s=getTeamForm(f.away,f.leagueKey);return s?'<div class="team-form-mini">'+s.split('').map(r=>'<div class="form-dot-mini '+r+'"></div>').join('')+'</div>':''})()}
          </div>
        </div>
        ${predHtml}
      </div>`;
  }).join('') || `<div style="text-align:center;padding:60px;color:var(--white-dim);font-family:'Barlow Condensed';letter-spacing:2px;">No ${isUpcoming?'upcoming':'recent'} fixtures found for selected leagues.</div>`;
}

function showTab(tab) {
  state.fixtureTab = tab;
  renderFixtures();
  document.getElementById('btnUpcoming').style.borderColor = tab === 'upcoming' ? 'var(--gold)' : '';
  document.getElementById('btnResults').style.borderColor = tab === 'results' ? 'var(--gold)' : '';
}

function renderPredictions() {
  const grid = document.getElementById('predictionsGrid');
  grid.innerHTML = DEMO.predictions.map(p => {
    const confClass = p.confidence === 'high' ? 'high' : p.confidence === 'medium' ? 'medium' : 'low';
    const confLabel = p.confidence.toUpperCase();
    return `
      <div class="recommendation-card fade-in">
        <div class="rec-top">
          <div>
            <span class="fixture-league-tag ${p.leagueTag}" style="padding:2px 8px;border-radius:2px;font-size:.7rem;font-weight:700;letter-spacing:1.5px;margin-bottom:6px;display:inline-block;">${LEAGUES[p.league].name}</span>
            <div class="rec-match">${p.home} vs ${p.away}</div>
            <div style="font-size:.78rem;color:var(--white-dim);font-family:'Barlow Condensed';margin-top:2px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">${new Date(p.date).toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'})} · ${p.time}${p.note?' · <strong style="color:var(--gold)">'+p.note+'</strong>':''} ${getTvBadge(p.home, p.away)}</div>
            ${fsFormLoaded ? `<div style="margin-top:8px;display:flex;gap:16px;flex-wrap:wrap;"><div><div class="fs-form-label">HOME FORM</div>${getFormBadgesHtml(p.home)||'<span style="font-size:.7rem;color:var(--white-dim)">No data</span>'}</div><div><div class="fs-form-label">AWAY FORM</div>${getFormBadgesHtml(p.away)||'<span style="font-size:.7rem;color:var(--white-dim)">No data</span>'}</div></div>` : ''}
          </div>
          <div class="confidence-badge ${confClass}">${confLabel}</div>
        </div>

        <div style="font-family:'Barlow Condensed';font-weight:700;font-size:1.1rem;color:var(--gold);margin-bottom:12px;">
          🎯 ${p.pick}
        </div>

        <div class="prob-bar-container">
          <div class="prob-bar-h" style="width:${p.probH}%"></div>
          <div class="prob-bar-d" style="width:${p.probD}%"></div>
          <div class="prob-bar-a" style="width:${p.probA}%"></div>
        </div>
        <div class="prob-labels mb-20">
          <span>Home ${p.probH}%</span>
          <span>Draw ${p.probD}%</span>
          <span>Away ${p.probA}%</span>
        </div>

        <div class="rec-picks">
          <div class="rec-pick goals">
            <div class="rec-pick-label">Expected Goals</div>
            <div class="rec-pick-value">⚽ ${p.expGoals}</div>
          </div>
          <div class="rec-pick cards">
            <div class="rec-pick-label">Expected Yellows</div>
            <div class="rec-pick-value">🟨 ${p.expYellow}</div>
          </div>
          <div class="rec-pick result">
            <div class="rec-pick-label">Red Card Risk</div>
            <div class="rec-pick-value">🟥 ${p.expRed}</div>
          </div>
          <div class="rec-pick player">
            <div class="rec-pick-label">🎴 Booking Pick</div>
            <div class="rec-pick-value" style="font-size:.82rem">${p.playerToBook.split(' — ')[0]}</div>
          </div>
        </div>
        ${p.odds ? '<div class="odds-row">' +
          '<div class="odds-pill"><div class="odds-label">HOME</div><div class="odds-val">' + p.odds.home + '</div><div class="odds-best">best price</div></div>' +
          '<div class="odds-pill"><div class="odds-label">DRAW</div><div class="odds-val">' + p.odds.draw + '</div><div class="odds-best">best price</div></div>' +
          '<div class="odds-pill"><div class="odds-label">AWAY</div><div class="odds-val">' + p.odds.away + '</div><div class="odds-best">best price</div></div>' +
          '</div>' : ''}

        <div class="rec-reasoning">
          <strong style="color:var(--white);display:block;margin-bottom:4px;">📝 Analysis</strong>
          ${p.reasoning}
        </div>
      </div>`;
  }).join('');

  document.getElementById('weekDisplay').textContent = `MATCHWEEK ${state.currentWeek}`;
  const d = new Date('2026-03-01');
  const end = new Date(d); end.setDate(d.getDate() + 3);
  document.getElementById('weekDateRange').textContent = 
    `${d.toLocaleDateString('en-GB',{day:'numeric',month:'short'})} – ${end.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})}`;
}

function renderBookings() {
  // KPIs
  document.getElementById('bookingsKPI').innerHTML = [
    { label:'Highest Yellow Rate', value:'4.0/game', sub:'🇪🇸 La Liga', color:'yellow' },
    { label:'Most Booked Player', value:'Amrabat', sub:'9 yellows, 1 red', color:'' },
    { label:'Highest Risk Fixture', value:'El Clásico', sub:'6.8 cards expected', color:'red' },
    { label:'Total Cards (5 leagues)', value:Object.values(DEMO.seasonStats).reduce((a,s)=>a+s.yellowCards+s.redCards,0).toString(), sub:'2024-25 to date', color:'gold' },
  ].map(k => `
    <div class="card fade-in">
      <div class="card-label">${k.label}</div>
      <div class="card-value ${k.color}" style="font-size:1.8rem">${k.value}</div>
      <div class="card-detail">${k.sub}</div>
    </div>`).join('');

  // Most booked players
  document.getElementById('mostBookedPlayers').innerHTML = DEMO.bookedPlayers.map((p,i) => `
    <tr>
      <td><span class="rank-num">${i+1}</span></td>
      <td><strong>${p.player}</strong></td>
      <td>${p.team}</td>
      <td><span class="fixture-league-tag ${LEAGUES[p.league].tag}" style="padding:1px 6px;border-radius:2px;font-size:.68rem;font-weight:700;">${LEAGUES[p.league].name}</span></td>
      <td class="num" style="color:var(--yellow-card);font-weight:700">${p.yellow}</td>
      <td class="num" style="color:var(--red-card);font-weight:700">${p.red}</td>
      <td class="num">${p.rate}</td>
    </tr>`).join('');

  // Booking risk
  document.getElementById('bookingRiskPlayers').innerHTML = DEMO.riskPlayers.map((p,i) => `
    <tr>
      <td><span class="rank-num">${i+1}</span></td>
      <td><strong>${p.player}</strong><div style="font-size:.72rem;color:var(--white-dim);margin-top:2px;">Next: ${p.next}</div></td>
      <td>${p.team}</td>
      <td class="num">
        <div style="display:flex;align-items:center;gap:6px;justify-content:center;">
          <div style="background:linear-gradient(90deg,var(--gold),var(--red-card));height:4px;border-radius:2px;width:${p.risk * 0.6}px"></div>
          <strong style="color:${p.risk>80?'var(--red-card)':p.risk>65?'var(--gold)':'var(--white-dim)'}">${p.risk}%</strong>
        </div>
      </td>
      <td style="font-size:.75rem;color:var(--white-dim);">${p.reasons}</td>
    </tr>`).join('');

  // Team discipline
  document.getElementById('teamDisciplineBody').innerHTML = DEMO.bookedTeams.map((t,i) => `
    <tr>
      <td><span class="rank-num">${i+1}</span></td>
      <td><strong>${t.team}</strong></td>
      <td><span class="fixture-league-tag ${LEAGUES[t.league].tag}" style="padding:1px 6px;border-radius:2px;font-size:.68rem;font-weight:700;">${LEAGUES[t.league].name}</span></td>
      <td class="num" style="color:var(--yellow-card);font-weight:700">${t.yellow}</td>
      <td class="num" style="color:var(--red-card);font-weight:700">${t.red}</td>
      <td class="num" style="font-weight:700">${t.bp}</td>
      <td class="num">${(11.5 + Math.random()*3).toFixed(1)}</td>
    </tr>`).join('');

  // Card forecast
  document.getElementById('cardForecastList').innerHTML = DEMO.cardForecast.map(f => {
    const expColor = f.expCards >= 6 ? 'var(--red-card)' : f.expCards >= 5 ? 'var(--gold)' : 'var(--accent)';
    const leagueKey = Object.entries(LEAGUES).find(([k,l]) => 
      f.match.toLowerCase().includes(l.name.split(' ')[0].toLowerCase()) ||
      f.league === k
    );
    return `
      <div style="padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.05);">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
          <strong style="font-family:'Barlow Condensed';font-size:.95rem">${f.match}</strong>
          <span style="font-family:'Black Ops One';font-size:1.2rem;color:${expColor}">${f.expCards}</span>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;font-family:'Barlow Condensed';font-size:.75rem;">
          <span style="color:var(--white-dim)">👮 ${f.referee}</span>
          <span class="stat-pill ${f.refStrictness==='V.High'?'danger':f.refStrictness==='High'?'warning':'safe'}">${f.refStrictness} Strictness</span>
          <span style="color:var(--yellow-card)">⚠ ${f.highRisk}</span>
        </div>
      </div>`;
  }).join('');
}

function renderReferees() {
  const sorted = [...DEMO.referees].sort((a,b) => b.strictness - a.strictness);
  const strict = sorted.slice(0,9);
  const lenient = sorted.slice(-9).reverse();

  function refRow(r, i) {
    return `<tr>
      <td><span class="rank-num">${i+1}</span></td>
      <td><strong>${r.name}</strong></td>
      <td>${r.country}</td>
      <td class="num">${r.games}</td>
      <td class="num" style="color:var(--yellow-card);font-weight:700">${r.yPerG.toFixed(1)}</td>
      <td class="num" style="color:var(--red-card);font-weight:700">${r.rPerG.toFixed(2)}</td>
      <td class="num">
        <div class="ref-strictness" style="min-width:80px;display:inline-block;vertical-align:middle;margin-right:6px">
          <div class="ref-strictness-bar" style="width:${r.strictness}%"></div>
        </div>
        <span style="font-size:.8rem;color:var(--white-dim)">${r.strictness}</span>
      </td>
    </tr>`;
  }

  document.getElementById('strictestRefs').innerHTML = strict.map(refRow).join('');
  document.getElementById('lenientRefs').innerHTML = lenient.map(refRow).join('');

  // Upcoming referee assignments
  const upcoming = [
    { match:'Liverpool vs Arsenal', ref:'Anthony Taylor', league:'pl', yPG:3.4, strictness:68 },
    { match:'El Clásico', ref:'Ricardo de Burgos', league:'ll', yPG:4.8, strictness:88 },
    { match:'Roma vs Lazio', ref:'Daniele Orsato', league:'sa', yPG:3.9, strictness:72 },
    { match:'Leverkusen vs Dortmund', ref:'Felix Zwayer', league:'bl', yPG:3.4, strictness:66 },
    { match:'PSG vs Marseille', ref:'François Letexier', league:'l1', yPG:3.6, strictness:70 },
    { match:'Chelsea vs Man Utd', ref:'Michael Oliver', league:'pl', yPG:3.1, strictness:62 },
    { match:'Inter vs Napoli', ref:'Gianluca Rocchi', league:'sa', yPG:4.2, strictness:79 },
    { match:'Bayern vs RB Leipzig', ref:'Daniel Siebert', league:'bl', yPG:3.1, strictness:60 },
  ];

  document.getElementById('upcomingRefAssignments').innerHTML = upcoming.map(u => {
    const lg = LEAGUES[u.league];
    const tag = lg.tag;
    const strictColor = u.strictness > 80 ? 'var(--red-card)' : u.strictness > 70 ? 'var(--gold)' : 'var(--accent)';
    return `
      <div class="card fade-in" style="padding:16px">
        <span class="fixture-league-tag ${tag}" style="padding:2px 8px;border-radius:2px;font-size:.68rem;font-weight:700;letter-spacing:1.5px;margin-bottom:8px;display:inline-block">${lg.name}</span>
        <div style="font-family:'Barlow Condensed';font-weight:700;font-size:.95rem;margin-bottom:4px">${u.match}</div>
        <div style="font-family:'Barlow Condensed';color:var(--white-dim);font-size:.82rem;margin-bottom:10px">👮 ${u.ref}</div>
        <div style="display:flex;gap:10px;align-items:center">
          <div class="ref-strictness" style="flex:1">
            <div class="ref-strictness-bar" style="width:${u.strictness}%"></div>
          </div>
          <span style="font-family:'Barlow Condensed';font-weight:700;font-size:.9rem;color:${strictColor}">${u.yPG} 🟨/G</span>
        </div>
      </div>`;
  }).join('');
}

function renderStandings() {
  const grid = document.getElementById('standingsGrid');
  grid.innerHTML = Object.entries(DEMO.standings).map(([leagueKey, table]) => {
    const lg = LEAGUES[leagueKey];
    const rows = table.map((t, i) => {
      const posClass = t.zone === 'cl' ? 'cl' : t.zone === 'el' ? 'el' : t.zone === 'rel' ? 'rel' : '';
      const formDots = (t.form || '').split('').filter(r => 'WDL'.includes(r)).map(r =>
        '<div class="form-dot ' + r + '">' + r + '</div>').join('');
      // Position movement arrow (stored on t.prevPos by live fetch, else neutral)
      let moveHtml = '';
      if (t.prevPos != null) {
        const diff = t.prevPos - t.pos;
        if (diff > 0)      moveHtml = '<span class="form-arrow-up">▲' + diff + '</span>';
        else if (diff < 0) moveHtml = '<span class="form-arrow-down">▼' + Math.abs(diff) + '</span>';
        else               moveHtml = '<span class="form-arrow-same">–</span>';
      }
      return '<tr>' +
        '<td><span class="standings-pos ' + posClass + '">' + t.pos + '</span>' + moveHtml + '</td>' +
        '<td><strong>' + t.team + '</strong></td>' +
        '<td class="num">' + t.P + '</td>' +
        '<td class="num" style="color:var(--accent)">' + t.W + '</td>' +
        '<td class="num" style="color:var(--gold)">' + t.D + '</td>' +
        '<td class="num" style="color:var(--red-card)">' + t.L + '</td>' +
        '<td class="num">' + t.GF + '</td>' +
        '<td class="num">' + t.GA + '</td>' +
        '<td class="num">' + (t.GD > 0 ? '+' : '') + t.GD + '</td>' +
        '<td class="num"><strong style="color:var(--gold)">' + t.pts + '</strong></td>' +
        '<td><div class="form-dots">' + formDots + '</div></td>' +
      '</tr>';
    }).join('');

    return `
      <div class="card fade-in">
        <div class="section-header" style="margin-bottom:14px">
          <span class="section-title" style="font-size:1.1rem">${lg.country} ${lg.name}</span>
        </div>
        <div style="display:flex;gap:12px;font-size:.72rem;font-family:'Barlow Condensed';margin-bottom:10px;">
          <span style="color:var(--accent)">■ Champions League</span>
          <span style="color:var(--gold-dim)">■ Europa League</span>
          <span style="color:var(--red-card)">■ Relegation</span>
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Team</th>
              <th class="num">P</th>
              <th class="num">W</th>
              <th class="num">D</th>
              <th class="num">L</th>
              <th class="num">GF</th>
              <th class="num">GA</th>
              <th class="num">GD</th>
              <th class="num">Pts</th>
              <th>Form</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
  }).join('');
}

// ============================================================
// NAVIGATION
// ============================================================

function switchTab(tab) {
  state.activeTab = tab;
  if (tab === 'suspensions')  renderSuspensions();
  if (tab === 'injuries')     renderInjuries();
  if (tab === 'europe')       renderEurope();
  if (tab === 'wrap')         renderWeekendWrap();
  if (tab === 'favourites')   renderFavourites();
  if (tab === 'live')         initLiveTab();
  state.activeTab = tab;
  document.querySelectorAll('.nav-tab').forEach((el, i) => {
    el.classList.toggle('active', el.textContent.toLowerCase().includes(tab.split('-')[0]));
  });
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  const tabEl = document.getElementById(`tab-${tab}`);
  if (tabEl) {
    tabEl.classList.add('active');
    // Lazy render
    if (tab === 'fixtures') renderFixtures();
    if (tab === 'predictions') renderPredictions();
    if (tab === 'bookings') renderBookings();
    if (tab === 'referees') renderReferees();
    if (tab === 'standings')  renderStandings();
  if (tab === 'worldcup')   renderWorldCup();
  }
}

function toggleLeague(id) {
  const badge = document.querySelector(`.league-badge.${id}`);
  if (state.activeLeagues.has(id) && state.activeLeagues.size > 1) {
    state.activeLeagues.delete(id);
    badge.classList.remove('active');
  } else {
    state.activeLeagues.add(id);
    badge.classList.add('active');
  }
  // Re-render current tab
  if (state.activeTab === 'fixtures') renderFixtures();
  if (state.activeTab === 'standings') renderStandings();
}

function filterFixtures(league, el) {
  el.classList.toggle('active');
  renderFixtures();
}

function changeWeek(dir) {
  state.currentWeek = Math.max(1, Math.min(38, state.currentWeek + dir));
  renderPredictions();
}

// ============================================================
// API DIAGNOSTICS — full end-to-end test of both APIs
// ============================================================

async function runApiDiagnostics() {
  const panel = document.getElementById('apiDiagPanel');
  const log   = document.getElementById('diagLog');
  panel.style.display = 'block';
  log.textContent = '';

  function write(line, color) {
    const el = document.createElement('div');
    el.textContent = line;
    if (color) el.style.color = color;
    log.appendChild(el);
    log.scrollTop = log.scrollHeight;
  }

  // Show refresh + quota info at top of diagnostics
  const quotaUsed = getQuotaUsedToday();
  const lastFetchMs = getLastFetchMs();
  const ageH = lastFetchMs ? (Date.now() - lastFetchMs) / 3600000 : null;
  write('── Auto-Refresh Status ──', '#f5c842');
  write('  Last fetch:    ' + (lastFetchMs ? new Date(lastFetchMs).toLocaleString('en-GB') : 'Never'));
  write('  Data age:      ' + (ageH !== null ? ageH.toFixed(1) + 'h ago' : '—'));
  write('  Quota today:   ' + quotaUsed + '/' + QUOTA_DAILY_LIMIT + ' calls used');
  write('  Quota resets:  Midnight UTC each day');
  write('  Next refresh:  ' + new Date(Date.now() + msUntilNextRefresh()).toLocaleTimeString('en-GB'));
  write('  Per-load cost: ~' + QUOTA_PER_LOAD + ' calls');
  write('');
  write('Testing API-Football — Standings (all 5 leagues)…', '#f5c842');
  const afLeagueNames = { 39:'Premier League', 140:'La Liga', 135:'Serie A', 78:'Bundesliga', 61:'Ligue 1' };
  for (const [id, name] of Object.entries(afLeagueNames)) {
    write(`  ↳ ${name}…`);
    try {
      const t0 = Date.now();
      const r = await fetch(`/.netlify/functions/af-proxy?path=/standings&league=${id}&season=2024`);
      const ms = Date.now() - t0;
      const d = await r.json();
      const table = d.response?.[0]?.league?.standings?.[0];
      if (table && table.length) {
        const top = table[0];
        write(`     ✅ ${ms}ms — P1: ${top.team.name} ${top.points}pts (${top.all.played} played)`, '#4ade80');
      } else {
        const errs = d.errors ? Object.values(d.errors).join(', ') : 'empty response array';
        write(`     ❌ No standings data — ${errs}`, '#e63946');
        if (d.response !== undefined) write(`     Raw response length: ${d.response?.length ?? 'null'}`, '#a8a89a');
      }
    } catch(e) {
      write(`     ❌ ERROR — ${e.message}`, '#e63946');
    }
  }

  write('');
  write('Testing API-Football — Recent PL fixtures…', '#f5c842');
  try {
    const dateFrom = new Date(Date.now() - 7*86400000).toISOString().slice(0,10);
    const dateTo   = new Date(Date.now() + 7*86400000).toISOString().slice(0,10);
    const r = await fetch(`/.netlify/functions/af-proxy?path=/fixtures&league=39&season=2024&from=${dateFrom}&to=${dateTo}`);
    const d = await r.json();
    const matches = d.response || [];
    const finished  = matches.filter(m => m.fixture.status.short === 'FT');
    const upcoming  = matches.filter(m => m.fixture.status.short === 'NS');
    write(`  ✅ ${matches.length} matches — ${finished.length} finished, ${upcoming.length} upcoming`, '#4ade80');
    finished.slice(-3).forEach(m => {
      write(`     ${m.teams.home.name} ${m.goals.home}–${m.goals.away} ${m.teams.away.name}`, '#a8a89a');
    });
    if (matches.length === 0) write(`  ℹ️  No matches in ±7 day window`, '#f5c842');
  } catch(e) {
    write(`  ❌ ERROR — ${e.message}`, '#e63946');
  }

  write('');
  write('Testing Bzzoiro Sports API…', '#f5c842');
  try {
    const bzKey = document.getElementById('bzKey')?.value.trim() || CONFIG.bzKey;
    const bzUrl = `https://sports.bzzoiro.com/api/predictions/?league=1&limit=5`;
    const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(bzUrl);
    const r = await fetch(proxyUrl);
    if (r.ok) {
      const wrapper = await r.json();
      const d = JSON.parse(wrapper.contents || '{}');
      const preds = Array.isArray(d) ? d : (d.results || []);
      if (preds.length > 0) {
        write(`  ✅ ${preds.length} predictions returned`, '#4ade80');
        preds.slice(0,3).forEach(p => {
          write(`     ${p.home_team ?? '?'} vs ${p.away_team ?? '?'} — home: ${Math.round((p.home_win_probability||0)*100)}%`, '#a8a89a');
        });
      } else {
        write(`  ⚠️  Connected but no predictions in response — Bzzoiro endpoint may differ`, '#f5c842');
        write(`  Raw: ${(wrapper.contents||'').slice(0,120)}`, '#a8a89a');
      }
    } else {
      write(`  ❌ Proxy request failed`, '#e63946');
    }
  } catch(e) {
    write(`  ❌ ERROR — ${e.message}`, '#e63946');
  }

  write('');
  write('Testing API-Football via Netlify function…', '#f5c842');
  try {
    const t0 = Date.now();
    const r = await fetch('/.netlify/functions/af-proxy?path=/status');
    const ms = Date.now() - t0;
    if (r.ok) {
      const d = await r.json();
      const sub = d.response?.subscription;
      const req = d.response?.requests;
      const errs = d.errors ? Object.values(d.errors).join(', ') : null;
      if (errs) {
        write(`  ❌ ${ms}ms — API error: ${errs}`, '#e63946');
        write(`     → Check that the API key in af-proxy.js is valid`, '#f5c842');
      } else if (sub) {
        write(`  ✅ ${ms}ms — Plan: ${sub.plan} · Requests today: ${req?.current || 0}/${req?.limit_day || 100} · Remaining: ${(req?.limit_day||100) - (req?.current||0)}`, '#4ade80');
        if ((req?.current || 0) >= (req?.limit_day || 100)) {
          write(`  ⚠️  Daily quota exhausted — data will not load until midnight UTC`, '#f5c842');
        }
      } else if (d.response === null || d.response === undefined) {
        write(`  ⚠️  ${ms}ms — Proxy reachable but API key not recognised (response is null)`, '#f5c842');
        write(`     → Verify key in netlify/functions/af-proxy.js. Raw: ${JSON.stringify(d).slice(0,120)}`, '#a8a89a');
      } else {
        write(`  ✅ ${ms}ms — Connected · Raw: ${JSON.stringify(d.response).slice(0,80)}`, '#4ade80');
      }
    } else {
      write(`  ❌ HTTP ${r.status}`, '#e63946');
    }
  } catch(e) {
    write(`  ❌ ERROR — ${e.message}`, '#e63946');
  }

  write('');
  write('Diagnostics complete. ✅ green = live data via Netlify function. ❌ red = check key or function deploy.', '#4ade80');
}

function saveApiKeys() {
  const fdKey = document.getElementById('fdKey').value.trim();
  const bzKey = document.getElementById('bzKey').value.trim();
  if (fdKey) { localStorage.setItem('fd_key', fdKey); CONFIG.fdKey = fdKey; }
  if (bzKey) { localStorage.setItem('bz_key', bzKey); CONFIG.bzKey = bzKey; }
  document.getElementById('apiModal').classList.add('hidden');
  fetchLiveData();
}

// ============================================================
// LIVE DATA FETCHING — football-data.org v4 + Bzzoiro Sports
// ============================================================

// Normalise a team shortName from the API to match our DEMO keys
function normTeam(name) {
  const MAP = {
    'Man United':'Manchester Utd','Manchester United':'Manchester Utd',
    'Man City':'Manchester City','Newcastle United':'Newcastle',
    'Nottingham Forest':'Nottm Forest','Spurs':'Tottenham',
    'Tottenham Hotspur':'Tottenham','Leeds':'Leeds United',
    'Aston Villa':'Aston Villa','Crystal Palace':'Crystal Palace',
    'West Ham':'West Ham','West Ham United':'West Ham',
    'Wolves':'Wolves','Wolverhampton Wanderers':'Wolves',
    'Brighton':'Brighton','Brighton & Hove Albion':'Brighton',
    "Nott'm Forest":'Nottm Forest',
    // La Liga
    'Real Madrid CF':'Real Madrid','FC Barcelona':'FC Barcelona',
    'Club Atlético de Madrid':'Atletico Madrid','Atlético de Madrid':'Atletico Madrid',
    'Athletic Club':'Athletic Club','Villarreal CF':'Villarreal',
    'RC Celta de Vigo':'Celta Vigo','Sevilla FC':'Sevilla',
    'Real Betis':'Real Betis','Real Sociedad':'Real Sociedad',
    // Serie A
    'FC Internazionale Milano':'Inter Milan','Inter':'Inter Milan',
    'SSC Napoli':'Napoli','Atalanta BC':'Atalanta','Juventus FC':'Juventus',
    'AC Milan':'AC Milan','SS Lazio':'Lazio','AS Roma':'AS Roma',
    'ACF Fiorentina':'Fiorentina','Como 1907':'Como',
    // Bundesliga
    'FC Bayern München':'Bayern Munich','Borussia Dortmund':'Borussia Dortmund',
    'VfB Stuttgart':'VfB Stuttgart','RasenBallsport Leipzig':'RB Leipzig',
    'Bayer 04 Leverkusen':'Bayer Leverkusen','Eintracht Frankfurt':'Eintracht Frankfurt',
    'SC Freiburg':'SC Freiburg','FC Augsburg':'FC Augsburg',
    'Hamburger SV':'Hamburger SV','1. FC Köln':'1. FC Köln',
    '1. FC Union Berlin':'Union Berlin',
    // Ligue 1
    'Paris Saint-Germain FC':'PSG','Paris Saint-Germain':'PSG',
    'RC Lens':'Lens','AS Monaco FC':'Monaco','AS Monaco':'Monaco',
    'Lille OSC':'Lille','Olympique Lyonnais':'Lyon','Olympique de Marseille':'Marseille',
    'Stade Rennais FC 1901':'Rennes','Stade Rennais FC':'Rennes',
    'OGC Nice':'Nice','Stade Brestois 29':'Brest',
  };
  return MAP[name] || name;
}

// football-data.org league codes
const FD_CODES = { pl:'PL', ll:'PD', sa:'SA', bl:'BL1', l1:'FL1' };

// Update status indicator helper
function setStatus(dotId, labelId, text, live) {
  const dot = document.getElementById(dotId);
  const lbl = document.getElementById(labelId);
  if (dot) dot.style.background = live ? 'var(--accent)' : '#f5c842';
  if (lbl) lbl.textContent = text;
}

// Fetch standings for one league from football-data.org
async function fdFetchStandings(leagueKey) {
  // Now uses API-Football as primary source
  const leagueId = AF_LEAGUES[leagueKey];
  if (!leagueId) return null;
  try {
    const data = await afFetch('/standings', { league: leagueId, season: AF_SEASON });
    if (!data || !data.length) return null;
    const table = data[0]?.league?.standings?.[0];
    if (!table) return null;
    storeStandingsSnapshot(leagueKey, table.map(r => ({ pos: r.rank, team: normTeam(r.team.name) })));
    return enrichWithMovement(leagueKey, table.map(row => ({
      pos:  row.rank,
      team: normTeam(row.team.name),
      P:    row.all.played,
      W:    row.all.win, D: row.all.draw, L: row.all.lose,
      GF:   row.all.goals.for, GA: row.all.goals.against,
      GD:   row.goalsDiff,
      pts:  row.points,
      form: (row.form || '').slice(-5),
      zone: row.rank <= 4 ? 'cl' : row.rank <= 6 ? 'el' : (row.rank >= (leagueKey==='bl'?16:18) ? 'rel' : ''),
    })));
  } catch(e) { console.warn('fdFetchStandings error:', e.message); return null; }
}

// Fetch recent + upcoming matches — now via API-Football
async function fdFetchMatches(leagueKey) {
  const leagueId = AF_LEAGUES[leagueKey];
  if (!leagueId) return null;
  try {
    const dateFrom = new Date(Date.now() - 14*86400000).toISOString().slice(0,10);
    const dateTo   = new Date(Date.now() + 14*86400000).toISOString().slice(0,10);
    const data = await afFetch('/fixtures', { league: leagueId, season: AF_SEASON, from: dateFrom, to: dateTo });
    if (!data || !data.length) return null;
    return data.map(m => ({
      home:   normTeam(m.teams.home.name),
      away:   normTeam(m.teams.away.name),
      date:   m.fixture.date.slice(0,10),
      time:   m.fixture.date.slice(11,16),
      week:   m.league.round?.match(/\d+/)?.[0] ? parseInt(m.league.round.match(/\d+/)[0]) : 0,
      result: m.fixture.status.short === 'FT'
                ? { h: m.goals.home, a: m.goals.away }
                : null,
      referee: m.fixture.referee || null,
      note:   '',
    }));
  } catch(e) { console.warn('fdFetchMatches error:', e.message); return null; }
}

// Fetch predictions/odds from Bzzoiro
async function bzFetchPredictions(leagueKey) {
  const bzId = LEAGUES[leagueKey]?.bzId;
  if (!bzId || !CONFIG.bzKey) return null;
  try {
    const r = await fetch(
      `https://sports.bzzoiro.com/api/predictions/?league=${bzId}&limit=5`,
      { headers: { 'Authorization': `Token ${CONFIG.bzKey}` } }
    );
    if (!r.ok) return null;
    const d = await r.json();
    return Array.isArray(d) ? d : (d.results || null);
  } catch(e) { return null; }
}

// Main live-data orchestrator
// ─── NETLIFY FUNCTION PROXY HELPER ───────────────────────────────────────
// Calls /.netlify/functions/football-proxy which runs server-side,
// adds the API key header, and returns JSON directly — no CORS issues.
async function fdFetch(path) {
  try {
    const r = await fetch('/.netlify/functions/football-proxy?path=' + encodeURIComponent(path));
    if (!r.ok) { console.warn('fdFetch: proxy HTTP', r.status); return null; }
    const parsed = await r.json();
    if (parsed.message) { console.warn('fdFetch API error:', parsed.message); return null; }
    return parsed;
  } catch(e) {
    console.warn('fdFetch exception:', e.message);
    return null;
  }
}
// ──────────────────────────────────────────────────────────────────────────

async function fetchLiveData() {
  let fdOk = false, bzOk = false;

  // ── Football-Data.org: standings + fixtures for all leagues ──
  for (const key of ['pl','ll','sa','bl','l1']) {
    const [standings, matches] = await Promise.all([
      fdFetchStandings(key),
      fdFetchMatches(key),
    ]);
    if (standings) {
      DEMO.standings[key] = standings;
      fdOk = true;
    }
    if (matches && matches.length) {
      // Keep our hand-verified results but prepend API matches as authoritative
      const apiResults   = matches.filter(m => m.result);
      const apiUpcoming  = matches.filter(m => !m.result);
      // Replace demo fixtures with live data (keeping any demo notes)
      if (apiResults.length || apiUpcoming.length) {
        DEMO.fixtures[key] = [...apiResults.slice(-8), ...apiUpcoming.slice(0,10)];
      }
      fdOk = true;
    }
  }

  // ── Bzzoiro: predictions enrichment ──
  for (const key of ['pl','ll','sa','bl','l1']) {
    const preds = await bzFetchPredictions(key);
    if (preds && preds.length) {
      bzOk = true;
      // Merge Bzzoiro predictions into the demo predictions list
      // (we keep demo predictions as fallback — just mark as enhanced)
      DEMO.predictions = DEMO.predictions.map(p => {
        const bzMatch = preds.find(bz =>
          bz.home_team && normTeam(bz.home_team) === p.home &&
          bz.away_team && normTeam(bz.away_team) === p.away
        );
        if (bzMatch) {
          return {
            ...p,
            homeWin: Math.round((bzMatch.home_win_probability || p.homeWin/100)*100),
            draw:    Math.round((bzMatch.draw_probability    || p.draw/100)*100),
            awayWin: Math.round((bzMatch.away_win_probability || p.awayWin/100)*100),
            confidence: bzMatch.confidence_level || p.confidence,
            note: (p.note || '') + ' [Bzzoiro enhanced]',
          };
        }
        return p;
      });
    }
  }

  // Update status bar indicators
  if (fdOk) {
    setStatus('fdStatus','fdLabel','Fixtures & Standings ✓ Live', true);
    console.log('%c⚽ Football-Data.org: LIVE DATA ACTIVE', 'color:#4ade80;font-weight:bold');
  } else {
    setStatus('fdStatus','fdLabel','Standings (via API-Football)', false);
    console.warn('⚠️ football-data.org: no data returned. Key may be rate-limited or invalid. Check the ⚙ Configure panel → 🔍 Test APIs Now');
  }
  if (bzOk) {
    setStatus('bzStatus','bzLabel','Bzzoiro Sports API ✓ Live', true);
    console.log('%c🔮 Bzzoiro Sports API: LIVE PREDICTIONS ACTIVE', 'color:#4ade80;font-weight:bold');
  } else {
    setStatus('bzStatus','bzLabel','Bzzoiro Sports API (fallback)', false);
    console.warn('⚠️ Bzzoiro API: predictions using verified data. Run diagnostics from ⚙ Configure to debug.');
  }

  // Re-render whatever tab is active
  if (fdOk || bzOk) {
    const tab = state.activeTab;
    if (tab === 'overview')   renderOverview();
    if (tab === 'fixtures')   renderFixtures();
    if (tab === 'standings')  renderStandings();
    if (tab === 'predictions') renderPredictions();
  }
}

// ============================================================
// THEME TOGGLE
// ============================================================
function toggleTheme() {
  const body = document.body;
  const btn = document.getElementById('themeBtn');
  const isLight = body.classList.toggle('light-mode');
  btn.textContent = isLight ? '🌙 Dark' : '☀️ Light';
  localStorage.setItem('theme', isLight ? 'light' : 'dark');
}

// ============================================================
// TEAM SEARCH
// ============================================================
function filterByTeam(query) {
  const q = query.toLowerCase().trim();
  const cards = document.querySelectorAll('#fixturesGrid .fixture-card');
  cards.forEach(card => {
    const text = card.textContent.toLowerCase();
    card.style.display = (!q || text.includes(q)) ? '' : 'none';
  });
}

// ============================================================
// SUSPENSION TRACKER
// ============================================================
const SUSPENSION_THRESHOLD = 5; // yellows before first ban in most leagues

function getSuspensionStatus(yellows, threshold) {
  const remaining = threshold - yellows;
  if (remaining <= 0)  return { label: 'SUSPENDED', cls: 'suspended' };
  if (remaining === 1) return { label: '1 AWAY',    cls: 'danger'    };
  if (remaining === 2) return { label: '2 AWAY',    cls: 'warning'   };
  return                      { label: 'SAFE',      cls: 'safe'      };
}

function renderSuspensions() {
  const threshold = 5;
  const players = [...DEMO.bookedPlayers].sort((a,b) => b.yellow - a.yellow);

  function makeRow(p) {
    const remaining = threshold - p.yellow;
    const pct = Math.min(100, (p.yellow / threshold) * 100);
    const status = getSuspensionStatus(p.yellow, threshold);
    const leagueName = LEAGUES[p.league]?.name || p.league.toUpperCase();
    return `<div class="suspension-row">
      <div class="sus-player">
        <div class="sus-player-name">${p.player}</div>
        <div class="sus-team">${p.team} · <span style="font-size:.7rem;color:var(--white-dim)">${leagueName}</span></div>
      </div>
      <div class="sus-bar-wrap">
        <div class="sus-bar-track"><div class="sus-bar-fill ${status.cls}" style="width:${pct}%"></div></div>
        <div class="sus-counts">${p.yellow} yellow${p.yellow!==1?'s':''} / ${threshold} threshold</div>
      </div>
      <span class="sus-badge ${status.cls}">${status.label}</span>
    </div>`;
  }

  const danger  = players.filter(p => (threshold - p.yellow) <= 1);
  const warning = players.filter(p => (threshold - p.yellow) === 2);

  const dangerEl = document.getElementById('susDanger');
  const warnEl   = document.getElementById('susWarning');
  if (dangerEl)  dangerEl.innerHTML  = danger.length  ? danger.map(makeRow).join('')  : '<div style="color:var(--white-dim);padding:16px;text-align:center;font-family:Barlow Condensed">No players in immediate danger</div>';
  if (warnEl)    warnEl.innerHTML    = warning.length ? warning.map(makeRow).join('') : '<div style="color:var(--white-dim);padding:16px;text-align:center;font-family:Barlow Condensed">No players at 2-away stage</div>';

  // Full table
  const tbody = document.getElementById('susFullTable');
  if (tbody) {
    tbody.innerHTML = players.map(p => {
      const remaining = Math.max(0, threshold - p.yellow);
      const status = getSuspensionStatus(p.yellow, threshold);
      const lg = LEAGUES[p.league];
      return `<tr>
        <td><strong>${p.player}</strong></td>
        <td>${p.team}</td>
        <td><span class="fixture-league-tag ${lg?.tag||''}" style="padding:1px 6px;border-radius:2px;font-size:.68rem;font-weight:700;">${lg?.name||p.league}</span></td>
        <td class="num" style="color:var(--yellow-card);font-weight:700;">${p.yellow}</td>
        <td class="num">${threshold}</td>
        <td class="num" style="color:${remaining<=1?'var(--red-card)':remaining===2?'var(--gold)':'var(--accent)'};font-weight:700;">${remaining}</td>
        <td class="num"><span class="sus-badge ${status.cls}">${status.label}</span></td>
      </tr>`;
    }).join('');
  }

  // Export card preview
  renderExportCardPreview();
}

function renderExportCardPreview() {
  const preview = document.getElementById('exportCardPreview');
  if (!preview) return;
  const threshold = 5;
  const danger = DEMO.bookedPlayers.filter(p => (threshold - p.yellow) <= 1);
  const now = new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
  preview.innerHTML = `
    <div style="color:var(--gold);font-size:1.1rem;font-weight:700;letter-spacing:2px;margin-bottom:8px;">⚡ SUSPENSION ALERT · ${now}</div>
    <div style="color:rgba(255,255,255,0.5);font-size:.75rem;margin-bottom:12px;">Players one yellow from a ban</div>
    ${danger.map(p => `<div style="padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.08);display:flex;justify-content:space-between;">
      <span style="color:#fff">${p.player} <span style="color:rgba(255,255,255,0.5);font-size:.8rem">(${p.team})</span></span>
      <span style="color:#f5c842;font-weight:700">${p.yellow} 🟨</span>
    </div>`).join('')}
    <div style="margin-top:10px;color:rgba(255,255,255,0.4);font-size:.72rem;">Football Oracle · footballoracle.netlify.app</div>`;
}

function exportSuspensionCard() {
  const threshold = 5;
  const danger = DEMO.bookedPlayers.filter(p => (threshold - p.yellow) <= 1);
  const now = new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
  let lines = ['⚡ SUSPENSION ALERT — ' + now, 'Players one yellow from a ban:', ''];
  danger.forEach(p => { lines.push('• ' + p.player + ' (' + p.team + ') — ' + p.yellow + ' yellows'); });
  lines.push('', 'Football Oracle · footballoracle.netlify.app');
  const text = lines.join('\n');
  navigator.clipboard.writeText(text).then(() => {
    const btn = event.target;
    btn.textContent = '✅ Copied!';
    setTimeout(() => btn.textContent = '📋 Copy Alert Card to Clipboard', 2000);
  }).catch(() => alert(text));
}

function exportPredictionsCard() {
  const now = new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
  let lines2 = ['🎯 FOOTBALL ORACLE PICKS — ' + now, 'Matchweek ' + state.currentWeek, ''];
  DEMO.predictions.forEach(p => {
    lines2.push(p.home + ' vs ' + p.away);
    lines2.push('  Pick: ' + p.pick);
    lines2.push('  Goals: ' + p.expGoals + ' · Yellows: ' + p.expYellow);
    lines2.push('  Booking: ' + p.playerToBook.split(' — ')[0]);
    lines2.push('');
  });
  lines2.push('Football Oracle · footballoracle.netlify.app');
  const text = lines2.join('\n');
  navigator.clipboard.writeText(text).then(() => {
    const btn = event.target;
    btn.textContent = '✅ Copied!';
    setTimeout(() => btn.textContent = '📋 Copy Picks Card', 2000);
  }).catch(() => alert(text));
}

// ============================================================
// API-FOOTBALL PROXY HELPER
// ============================================================
async function afFetch(path, params = {}) {
  const qs = new URLSearchParams({ path, ...params }).toString();
  try {
    const r = await fetch('/.netlify/functions/af-proxy?' + qs);
    if (!r.ok) { console.warn('afFetch HTTP', r.status, path); return null; }
    const d = await r.json();
    if (d.errors && Object.keys(d.errors).length) {
      console.warn('afFetch API error:', JSON.stringify(d.errors));
      return null;
    }
    return d.response || null;
  } catch(e) {
    console.warn('afFetch exception:', e.message, path);
    return null;
  }
}

// ============================================================
// API-FOOTBALL: PLAYER BOOKINGS (yellow/red cards per player)
// ============================================================
async function afFetchPlayerCards(leagueKey) {
  const leagueId = AF_LEAGUES[leagueKey];
  if (!leagueId) return null;
  try {
    // Top players by yellow cards
    const data = await afFetch('/players/topyellowcards', { league: leagueId, season: AF_SEASON });
    if (!data || !data.length) return null;
    return data.slice(0, 15).map(item => ({
      player: item.player.name,
      team:   normTeam(item.statistics?.[0]?.team?.name || ''),
      league: leagueKey,
      yellow: item.statistics?.[0]?.cards?.yellow || 0,
      red:    (item.statistics?.[0]?.cards?.yellowred || 0) + (item.statistics?.[0]?.cards?.red || 0),
      games:  item.statistics?.[0]?.games?.appearences || 0,
      rate:   0,
    }));
  } catch(e) { return null; }
}

// ============================================================
// API-FOOTBALL: PREDICTIONS for a fixture
// ============================================================
async function afFetchPredictions(fixtureId) {
  const data = await afFetch('/predictions', { fixture: fixtureId });
  if (!data || !data.length) return null;
  const p = data[0];
  return {
    winner:    p.predictions?.winner?.name || null,
    winOrDraw: p.predictions?.win_or_draw || false,
    underOver: p.predictions?.under_over || null,
    goals:     p.predictions?.goals || {},
    advice:    p.predictions?.advice || '',
    percent:   p.predictions?.percent || {},
  };
}

// ============================================================
// API-FOOTBALL: HEAD-TO-HEAD
// ============================================================
async function afFetchH2H(team1Id, team2Id) {
  const data = await afFetch('/fixtures/headtohead', { h2h: team1Id + '-' + team2Id, last: 5 });
  if (!data || !data.length) return null;
  return data.map(m => ({
    date:  m.fixture.date.slice(0,10),
    home:  normTeam(m.teams.home.name),
    away:  normTeam(m.teams.away.name),
    score: { h: m.goals.home, a: m.goals.away },
  }));
}

// ============================================================
// API-FOOTBALL: UPCOMING FIXTURES WITH TEAM IDs (for H2H + predictions)
// ============================================================
async function afFetchUpcomingFixtures(leagueKey) {
  const leagueId = AF_LEAGUES[leagueKey];
  if (!leagueId) return null;
  const dateFrom = new Date().toISOString().slice(0,10);
  const dateTo   = new Date(Date.now() + 10*86400000).toISOString().slice(0,10);
  const data = await afFetch('/fixtures', { league: leagueId, season: AF_SEASON, from: dateFrom, to: dateTo });
  if (!data || !data.length) return null;
  return data.map(m => ({
    fixtureId: m.fixture.id,
    home:      normTeam(m.teams.home.name),
    away:      normTeam(m.teams.away.name),
    homeId:    m.teams.home.id,
    awayId:    m.teams.away.id,
    date:      m.fixture.date.slice(0,10),
    referee:   m.fixture.referee || null,
  }));
}

// ============================================================
// API-FOOTBALL: REFEREE STATS
// ============================================================
async function afFetchRefereeStats(leagueKey) {
  // API-Football doesn't have a dedicated referee stats endpoint on free plan
  // but we get referee name per fixture — we aggregate from fixture data
  const leagueId = AF_LEAGUES[leagueKey];
  if (!leagueId) return null;
  const data = await afFetch('/fixtures', { league: leagueId, season: AF_SEASON, last: 50 });
  if (!data || !data.length) return null;
  const refs = {};
  data.forEach(m => {
    const name = m.fixture.referee;
    if (!name) return;
    const cleanName = name.replace(/, [A-Z]+$/, '').trim();
    if (!refs[cleanName]) refs[cleanName] = { name: cleanName, games: 0, yellow: 0, red: 0 };
    refs[cleanName].games++;
    refs[cleanName].yellow += (m.score?.halftime ? 0 : 0); // cards not in fixture list endpoint
  });
  // Return what we have — at minimum referee names with game counts
  return Object.values(refs).filter(r => r.games >= 2).sort((a,b) => b.games - a.games);
}

// ============================================================
// MAIN API-FOOTBALL ENRICHMENT ORCHESTRATOR
// ============================================================
async function fetchAfData() {
  console.log('%c📊 API-Football: starting enrichment fetch…', 'color:#f5c842');
  let afOk = false;

  // ── 1. Player card leaders across all leagues ──
  const allCardPlayers = [];
  for (const key of ['pl','ll','sa','bl','l1']) {
    const players = await afFetchPlayerCards(key);
    if (players && players.length) {
      allCardPlayers.push(...players);
      afOk = true;
    }
  }
  if (allCardPlayers.length) {
    // Sort by yellows, update DEMO
    DEMO.bookedPlayers = allCardPlayers.sort((a,b) => b.yellow - a.yellow).slice(0,20);
    // Rebuild risk players from live data
    DEMO.riskPlayers = DEMO.bookedPlayers.slice(0,8).map(p => {
      const threshold = 5;
      const remaining = threshold - p.yellow;
      const risk = remaining <= 1 ? 94 : remaining === 2 ? 80 : remaining === 3 ? 60 : 40;
      return {
        player: p.player, team: p.team, risk,
        reasons: p.yellow + 'Y this season · ' + (remaining <= 1 ? 'ONE away from ban' : remaining + ' from ban'),
        next: 'Next fixture',
      };
    });
    console.log('%c🟨 Live card data loaded:', 'color:#f5c842', allCardPlayers.length, 'players');
  }

  // ── 2. Upcoming fixtures with predictions + H2H ──
  for (const key of ['pl','ll','sa','bl','l1']) {
    const fixtures = await afFetchUpcomingFixtures(key);
    if (!fixtures || !fixtures.length) continue;
    afOk = true;

    // Attach referee names to DEMO fixtures
    fixtures.forEach(af => {
      const fx = (DEMO.fixtures[key] || []).find(f =>
        f.home === af.home && f.away === af.away
      );
      if (fx && af.referee) fx.referee = af.referee;
    });

    // Fetch predictions for first 3 upcoming fixtures per league
    const upcoming = fixtures.slice(0, 2); // budget: 2 per league = 10 prediction/H2H/odds calls
    for (const af of upcoming) {
      const pred = await afFetchPredictions(af.fixtureId);
      if (!pred) continue;
      // Parse percent strings like "45%"
      const ph = parseInt(pred.percent.home) || 0;
      const pd = parseInt(pred.percent.draw) || 0;
      const pa = parseInt(pred.percent.away) || 0;
      // Update or add to DEMO.predictions
      const existing = DEMO.predictions.find(p => p.home === af.home && p.away === af.away);
      const predData = {
        league: key, leagueTag: LEAGUES[key].tag,
        home: af.home, away: af.away,
        date: af.date, time: '15:00',
        pick: pred.advice || (pred.winner ? 'Back ' + pred.winner : 'Draw likely'),
        probH: ph, probD: pd, probA: pa,
        expGoals: pred.goals?.home != null ? (pred.goals.home + '-' + pred.goals.away) : '2-1',
        expYellow: 3, expRed: 0,
        confidence: ph > 65 || pa > 65 ? 'high' : ph > 50 || pa > 50 ? 'medium' : 'low',
        playerToBook: DEMO.riskPlayers[0]?.player + ' — suspension risk' || 'Booking risk TBC',
        reasoning: pred.advice || 'API-Football prediction',
        note: '',
      };
      if (existing) {
        Object.assign(existing, predData);
      } else {
        DEMO.predictions.unshift(predData);
      }

      // Fetch H2H
      const h2h = await afFetchH2H(af.homeId, af.awayId);
      if (h2h && h2h.length) {
        const h2hKey = af.home + '_' + af.away;
        DEMO.h2h[h2hKey] = h2h.map(m => ({
          d: m.date, h: m.home, a: m.away, r: m.score,
        }));
      }

      // Fetch odds (Bet365 via API-Football /odds)
      const odds = await afFetchOdds(af.fixtureId);
      if (odds) {
        const existing2 = DEMO.predictions.find(p => p.home === af.home && p.away === af.away);
        if (existing2) existing2.odds = odds;
      }
    }
  }

  // ── 3. Fetch injuries from API-Football ──
  for (const key of ['pl','ll','sa','bl','l1']) {
    const leagueId = AF_LEAGUES[key];
    try {
      const dateFrom = new Date().toISOString().slice(0,10);
      const dateTo   = new Date(Date.now() + 7*86400000).toISOString().slice(0,10);
      // Get next round fixtures to find team IDs for injury lookups
      const fxData = await afFetch('/fixtures', { league: leagueId, season: AF_SEASON, from: dateFrom, to: dateTo, status: 'NS' });
      if (!fxData || !fxData.length) continue;
      const teamIds = [...new Set(fxData.slice(0,4).flatMap(m => [m.teams.home.id, m.teams.away.id]))];
      const liveInjuries = [];
      for (const tid of teamIds.slice(0, 2)) { // budget: 2 teams per league = 10 injury calls max
        const injData = await afFetch('/injuries', { league: leagueId, season: AF_SEASON, team: tid });
        if (!injData || !injData.length) continue;
        injData.forEach(i => {
          liveInjuries.push({
            player: i.player.name,
            team:   normTeam(i.team.name),
            status: i.player.reason?.toLowerCase().includes('doubt') ? 'doubt' : 'out',
            injury: i.player.reason || 'Injury',
            return: 'TBC',
            rating: 7,
          });
        });
        afOk = true;
      }
      if (liveInjuries.length) DEMO_INJURIES[key] = liveInjuries.slice(0, 8);
    } catch(e) { console.warn('AF injuries error:', e.message); }
  }
  if (state.activeTab === 'injuries') renderInjuries();

  // ── 4. Status update ──
  if (afOk) {
    setStatus('afStatus', 'afLabel', 'API-Football ✓ Live', true);
    console.log('%c⚽ API-Football: enrichment complete', 'color:#4ade80');
    // Re-render active tab
    const tab = state.activeTab;
    if (tab === 'bookings')     renderBookings();
    if (tab === 'suspensions')  renderSuspensions();
    if (tab === 'predictions')  renderPredictions();
    if (tab === 'fixtures')     renderFixtures();
    if (tab === 'overview')     renderOverview();
    if (tab === 'injuries')     renderInjuries();
    if (tab === 'standings')    renderStandings();
    if (tab === 'europe')       renderEurope();
    if (tab === 'wrap')         renderWeekendWrap();
    if (tab === 'favourites')   { renderFavourites(); renderFavNextFixtures(); }
    // Always re-render overview KPIs
    renderOverview();
  } else {
    setStatus('afStatus', 'afLabel', 'API-Football (check key)', false);
    console.warn('⚠️ API-Football: no data returned');
  }
}

// ============================================================
// LIVE SCORERS — fetch from football-data.org /scorers endpoint
// ============================================================
async function fetchLiveScorers() {
  // Uses API-Football top scorers endpoint
  const allScorers = [];
  for (const [key, leagueId] of Object.entries(AF_LEAGUES)) {
    try {
      const data = await afFetch('/players/topscorers', { league: leagueId, season: AF_SEASON });
      if (data && data.length) {
        data.slice(0,5).forEach(item => {
          allScorers.push({
            player: item.player.name,
            team:   normTeam(item.statistics?.[0]?.team?.name || ''),
            league: key,
            goals:  item.statistics?.[0]?.goals?.total || 0,
            games:  item.statistics?.[0]?.games?.appearences || 0,
          });
        });
      }
    } catch(e) { /* fall back to demo */ }
  }
  if (allScorers.length > 0) {
    DEMO.scorers = allScorers.sort((a,b) => b.goals - a.goals).slice(0,10);
    if (state.activeTab === 'overview' || !state.activeTab) renderOverview();
    console.log('%c⚽ Live scorers loaded:', 'color:#4ade80', allScorers.length, 'players');
  }
}

// ============================================================
// REFEREE ASSIGNMENT — attach referee to fixture cards
// ============================================================
async function fetchRefereeAssignments() {
  // football-data.org includes referee in match data when available
  // We already fetch matches — scan them for referee field
  const codes = { pl:'PL', ll:'PD', sa:'SA', bl:'BL1', l1:'FL1' };
  for (const [key, code] of Object.entries(codes)) {
    try {
      const dateFrom = new Date(Date.now()).toISOString().slice(0,10);
      const dateTo   = new Date(Date.now() + 10*86400000).toISOString().slice(0,10);
      const d = await fdFetch(`/v4/competitions/${code}/matches?dateFrom=${dateFrom}&dateTo=${dateTo}`);
      if (d && d.matches) {
        d.matches.forEach(m => {
          if (m.referees && m.referees.length > 0) {
            const refName = m.referees[0].name;
            const home = normTeam(m.homeTeam.shortName || m.homeTeam.name);
            const away = normTeam(m.awayTeam.shortName || m.awayTeam.name);
            // Store in fixture data
            const fx = (DEMO.fixtures[key] || []).find(f => f.home === home && f.away === away);
            if (fx) fx.referee = refName;
          }
        });
      }
    } catch(e) {}
  }
}

// ============================================================
// HELPER: GET TEAM FORM FROM STANDINGS
// ============================================================
function getTeamForm(teamName, leagueKey) {
  const table = DEMO.standings[leagueKey];
  if (!table) return null;
  const row = table.find(t => t.team.toLowerCase() === teamName.toLowerCase() ||
    teamName.toLowerCase().includes(t.team.toLowerCase()) ||
    t.team.toLowerCase().includes(teamName.toLowerCase()));
  return row ? (row.form || '') : null;
}

// ============================================================
// FEATURE 1: INJURY TRACKER
// ============================================================
const DEMO_INJURIES = {
  // Fallback injury data — overwritten by API-Football on load
  pl: [
    { player:'Rodri',          team:'Manchester City', status:'out',   injury:'Knee ligament', return:'End of season', rating:9 },
    { player:'Reece James',    team:'Chelsea',         status:'doubt', injury:'Hamstring',      return:'~2 weeks',      rating:8 },
    { player:'Diogo Jota',     team:'Liverpool',       status:'out',   injury:'Knee',           return:'March 2026',    rating:8 },
    { player:'Marcus Rashford',team:'Manchester Utd',  status:'knock', injury:'Ankle knock',    return:'Available',     rating:8 },
    { player:'Son Heung-min',  team:'Tottenham',       status:'doubt', injury:'Hamstring',      return:'~1 week',       rating:9 },
    { player:'Sandro Tonali',  team:'Newcastle',       status:'out',   injury:'Knee',           return:'April 2026',    rating:8 },
  ],
  ll: [
    { player:'Dani Carvajal',  team:'Real Madrid',     status:'out',   injury:'Knee ligament', return:'End of season', rating:8 },
    { player:'Eder Militao',   team:'Real Madrid',     status:'out',   injury:'Knee',          return:'March 2026',    rating:8 },
    { player:'Gavi',           team:'FC Barcelona',    status:'out',   injury:'Knee',          return:'March 2026',    rating:9 },
    { player:'Frenkie de Jong',team:'FC Barcelona',    status:'doubt', injury:'Ankle',         return:'~2 weeks',      rating:8 },
  ],
  sa: [
    { player:'Gleison Bremer', team:'Juventus',        status:'out',   injury:'Knee ligament', return:'End of season', rating:8 },
    { player:'Francesco Acerbi',team:'Inter Milan',    status:'out',   injury:'Muscle',        return:'March 2026',    rating:7 },
    { player:'Dusan Vlahovic', team:'Juventus',        status:'doubt', injury:'Thigh',         return:'~1 week',       rating:8 },
  ],
  bl: [
    { player:'Manuel Neuer',   team:'Bayern Munich',   status:'doubt', injury:'Rib',           return:'Available',     rating:8 },
    { player:'Florian Wirtz',  team:'Bayer Leverkusen',status:'knock', injury:'Knock',         return:'Available',     rating:9 },
    { player:'Marco Reus',     team:'Borussia Dortmund',status:'out',  injury:'Hamstring',     return:'March 2026',    rating:7 },
  ],
  l1: [
    { player:'Ousmane Dembele', team:'PSG',            status:'doubt', injury:'Hamstring',     return:'~1 week',       rating:9 },
    { player:'Nuno Mendes',     team:'PSG',            status:'out',   injury:'Knee',          return:'April 2026',    rating:8 },
    { player:'Dimitri Payet',   team:'Marseille',      status:'knock', injury:'Knock',         return:'Available',     rating:7 },
  ],
};

function makeInjuryCard(p) {
  const statusCls = p.status === 'out' ? 'out' : p.status === 'doubt' ? 'doubt' : 'knock';
  const statusLabel = p.status === 'out' ? 'OUT' : p.status === 'doubt' ? 'DOUBT' : 'KNOCK';
  return '<div class="injury-card">' +
    '<div class="injury-avatar">' + p.player.charAt(0) + '</div>' +
    '<div style="flex:1">' +
      '<div class="injury-name">' + p.player + '</div>' +
      '<div class="injury-meta">' + p.team + ' · ' + p.injury + '</div>' +
      '<div class="injury-return">↩ ' + p.return + '</div>' +
    '</div>' +
    '<span class="injury-badge ' + statusCls + '">' + statusLabel + '</span>' +
  '</div>';
}

function renderInjuries() {
  ['pl','ll','sa','bl','l1'].forEach(key => {
    const el = document.getElementById('injuries-' + key);
    if (!el) return;
    const list = DEMO_INJURIES[key] || [];
    if (!list.length) {
      el.innerHTML = '<div style="color:var(--white-dim);padding:16px;text-align:center;font-family:Barlow Condensed">No injury data available</div>';
      return;
    }
    el.innerHTML = list.map(makeInjuryCard).join('');
  });
  // Key absentees — top rated players who are OUT
  const keyEl = document.getElementById('injuries-key');
  if (keyEl) {
    const all = Object.values(DEMO_INJURIES).flat();
    const key = all.filter(p => p.status === 'out' && p.rating >= 8)
      .sort((a,b) => b.rating - a.rating).slice(0,6);
    keyEl.innerHTML = key.map(makeInjuryCard).join('') ||
      '<div style="color:var(--white-dim);padding:16px;text-align:center;font-family:Barlow Condensed">No major absentees</div>';
  }
}

// ============================================================
// FEATURE 2: FORM GUIDE — already handled by getTeamForm() + CSS
// Position movement stored in standings as prevPos
// ============================================================

// ============================================================
// FEATURE 3: ODDS COMPARISON — fetched from API-Football /odds
// ============================================================
async function afFetchOdds(fixtureId) {
  const data = await afFetch('/odds', { fixture: fixtureId, bookmaker: 8 }); // bookmaker 8 = Bet365
  if (!data || !data.length) return null;
  try {
    const bets = data[0]?.bookmakers?.[0]?.bets;
    const mwr = bets?.find(b => b.name === 'Match Winner');
    if (!mwr) return null;
    const vals = {};
    mwr.values.forEach(v => {
      if (v.value === 'Home') vals.home = v.odd;
      else if (v.value === 'Draw') vals.draw = v.odd;
      else if (v.value === 'Away') vals.away = v.odd;
    });
    return (vals.home && vals.draw && vals.away) ? vals : null;
  } catch(e) { return null; }
}

// ============================================================
// FEATURE 4: POSITION MOVEMENT — stored per team on prev standings load
// We compare current pos to previously cached pos
// ============================================================
const PREV_STANDINGS = {};

function storeStandingsSnapshot(leagueKey, table) {
  if (!PREV_STANDINGS[leagueKey]) {
    PREV_STANDINGS[leagueKey] = {};
    table.forEach(t => { PREV_STANDINGS[leagueKey][t.team] = t.pos; });
  }
}

function enrichWithMovement(leagueKey, table) {
  const prev = PREV_STANDINGS[leagueKey] || {};
  return table.map(t => ({
    ...t,
    prevPos: prev[t.team] != null ? prev[t.team] : null,
  }));
}

// ============================================================
// FEATURE 5: PLAYER SEARCH
// ============================================================
let playerSearchOpen = false;

function buildPlayerIndex() {
  const players = [];
  // From scorers
  (DEMO.scorers || []).forEach(p => {
    players.push({ name: p.player, team: p.team, league: p.league, type:'scorer',
      goals: p.goals, games: p.games, yellow: null, red: null, suspended: false });
  });
  // From booked players — merge with scorers
  (DEMO.bookedPlayers || []).forEach(p => {
    const existing = players.find(x => x.name.toLowerCase() === p.player.toLowerCase());
    if (existing) { existing.yellow = p.yellow; existing.red = p.red; }
    else players.push({ name: p.player, team: p.team, league: p.league, type:'booked',
      goals: null, games: p.games, yellow: p.yellow, red: p.red, suspended: false });
  });
  // From injuries
  Object.entries(DEMO_INJURIES).forEach(([key, list]) => {
    list.forEach(p => {
      const existing = players.find(x => x.name.toLowerCase() === p.player.toLowerCase());
      if (existing) { existing.injured = true; existing.injuryStatus = p.status; existing.injuryDetail = p.injury; existing.injuryReturn = p.return; }
      else players.push({ name: p.player, team: p.team, league: key, type:'injury',
        goals: null, games: null, yellow: null, red: null,
        injured: true, injuryStatus: p.status, injuryDetail: p.injury, injuryReturn: p.return });
    });
  });
  return players;
}

function openPlayerSearch() {
  document.getElementById('playerSearchOverlay').classList.remove('hidden');
  document.getElementById('playerSearchBig').focus();
  playerSearchOpen = true;
}

function closePlayerSearch() {
  document.getElementById('playerSearchOverlay').classList.add('hidden');
  document.getElementById('playerSearchBig').value = '';
  document.getElementById('playerSearchResults').innerHTML =
    '<div class="player-search-empty">Start typing to search across all leagues</div>';
  playerSearchOpen = false;
}

function runPlayerSearch(query) {
  const q = query.toLowerCase().trim();
  const resultsEl = document.getElementById('playerSearchResults');
  if (!q) {
    resultsEl.innerHTML = '<div class="player-search-empty">Start typing to search across all leagues</div>';
    return;
  }
  const index = buildPlayerIndex();
  const matches = index.filter(p => p.name.toLowerCase().includes(q) || p.team.toLowerCase().includes(q));
  if (!matches.length) {
    resultsEl.innerHTML = '<div class="player-search-empty">No players found for "' + query + '"</div>';
    return;
  }
  const threshold = 5;
  resultsEl.innerHTML = matches.slice(0,12).map(p => {
    const lg = LEAGUES[p.league];
    const susStatus = p.yellow != null ? (p.yellow >= threshold ? 'SUSPENDED' : p.yellow === threshold - 1 ? '1 FROM BAN' : p.yellow === threshold - 2 ? '2 FROM BAN' : null) : null;
    const nextFx = Object.values(DEMO.fixtures).flat().find(f =>
      !f.result && (normTeam(f.home) === normTeam(p.team) || normTeam(f.away) === normTeam(p.team))
    );
    const nextGame = nextFx ? nextFx.home + ' vs ' + nextFx.away + ' (' + nextFx.date.slice(5) + ')' : 'No upcoming fixture';
    const stats = [
      p.goals != null ? '<span class="player-result-stat">⚽ <strong>' + p.goals + '</strong> goals</span>' : '',
      p.yellow != null ? '<span class="player-result-stat">🟨 <strong>' + p.yellow + '</strong> yellows</span>' : '',
      p.red ? '<span class="player-result-stat">🟥 <strong>' + p.red + '</strong> reds</span>' : '',
      p.games != null ? '<span class="player-result-stat">📊 <strong>' + p.games + '</strong> games</span>' : '',
      susStatus ? '<span class="player-result-stat" style="color:var(--red-card)">⚠️ <strong>' + susStatus + '</strong></span>' : '',
      p.injured ? '<span class="player-result-stat" style="color:var(--red-card)">🏥 <strong>' + (p.injuryStatus || 'injured').toUpperCase() + '</strong> – ' + (p.injuryDetail || '') + '</span>' : '',
    ].filter(Boolean).join('');
    return '<div class="player-result-item">' +
      '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px;">' +
        '<div class="player-result-name">' + p.name + '</div>' +
        '<span class="fixture-league-tag ' + (lg?.tag||'') + '" style="padding:1px 6px;border-radius:2px;font-size:.65rem;font-weight:700;flex-shrink:0;margin-left:8px;">' + (lg?.name||p.league) + '</span>' +
      '</div>' +
      '<div style="font-size:.78rem;color:var(--white-dim);margin-bottom:6px;">' + p.team + '</div>' +
      '<div class="player-result-stats">' + (stats || '<span style="color:var(--white-dim)">No stats available</span>') + '</div>' +
      '<div style="font-size:.72rem;color:var(--white-dim);margin-top:6px;font-family:Barlow Condensed;">📅 Next: ' + nextGame + '</div>' +
    '</div>';
  }).join('');
}

// Keyboard shortcut: Ctrl+K or / to open search
document.addEventListener('keydown', e => {
  if ((e.ctrlKey && e.key === 'k') || (e.key === '/' && !playerSearchOpen && document.activeElement.tagName !== 'INPUT')) {
    e.preventDefault();
    openPlayerSearch();
  }
  if (e.key === 'Escape' && playerSearchOpen) closePlayerSearch();
});

// ============================================================
// FEATURE 6: TOP ASSISTS — API-Football fetch
// ============================================================
async function fetchLiveAssists() {
  const allAssists = [];
  for (const [key, leagueId] of Object.entries(AF_LEAGUES)) {
    try {
      const data = await afFetch('/players/topassists', { league: leagueId, season: AF_SEASON });
      if (data && data.length) {
        data.slice(0,5).forEach(item => {
          allAssists.push({
            player:  item.player.name,
            team:    normTeam(item.statistics?.[0]?.team?.name || ''),
            league:  key,
            assists: item.statistics?.[0]?.goals?.assists || 0,
            games:   item.statistics?.[0]?.games?.appearences || 0,
          });
        });
      }
    } catch(e) { /* fall back to demo */ }
  }
  if (allAssists.length > 0) {
    DEMO.assists = allAssists.sort((a,b) => b.assists - a.assists).slice(0,10);
    if (state.activeTab === 'overview') renderOverview();
    console.log('%c🎯 Live assists loaded:', 'color:#4da6ff', allAssists.length, 'players');
  }
}

// ============================================================
// FEATURE 7: EUROPEAN TRACKER
// ============================================================
let euroFilter = 'all';

function filterEurope(comp, el) {
  euroFilter = comp;
  document.querySelectorAll('[id^=euroFilter]').forEach(b => b.classList.remove('active'));
  if (el) el.classList.add('active');
  renderEurope();
}

function renderEurope() {
  const el = document.getElementById('euroFixturesGrid');
  if (!el) return;
  const fixtures = DEMO.euroFixtures || [];
  const filtered = euroFilter === 'all' ? fixtures : fixtures.filter(f => f.comp.toLowerCase() === euroFilter);

  if (!filtered.length) {
    el.innerHTML = '<div class="wrap-no-data">No European fixtures found. Live data will load shortly.</div>';
    return;
  }

  // Group by round
  const byRound = {};
  filtered.forEach(f => {
    const k = f.comp + ' · ' + f.round;
    if (!byRound[k]) byRound[k] = { comp: f.comp, compCls: f.compCls, round: f.round, fixtures: [] };
    byRound[k].fixtures.push(f);
  });

  el.innerHTML = Object.values(byRound).map(group => {
    const cards = group.fixtures.map(f => {
      const dateStr = new Date(f.date).toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short'});
      const isResult = !!f.result;
      const scoreContent = isResult
        ? '<div class="euro-score-box" style="color:var(--gold)">' + f.result.h + ' – ' + f.result.a + '</div>'
        : '<div class="euro-score-box" style="color:var(--white-dim)">' + f.time + '</div>';

      const homeLeagueName = f.homeLeague ? (LEAGUES[f.homeLeague]?.name || '') : '';
      const awayLeagueName = f.awayLeague ? (LEAGUES[f.awayLeague]?.name || '') : '';
      const tvBadge = getTvBadge(f.home, f.away);

      return '<div class="euro-fixture-card">' +
        '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">' +
          '<span class="euro-round-badge ' + f.compCls + '">' + f.comp + '</span>' +
          '<span style="font-size:.72rem;color:var(--white-dim)">' + dateStr + '</span>' +
          (tvBadge ? tvBadge : '') +
        '</div>' +
        '<div class="euro-teams-row">' +
          '<div style="flex:1;text-align:right;">' +
            '<div class="euro-team-name">' + f.home + '</div>' +
            '<div style="font-size:.68rem;color:var(--white-dim)">' + homeLeagueName + '</div>' +
          '</div>' +
          scoreContent +
          '<div style="flex:1;text-align:left;">' +
            '<div class="euro-team-name">' + f.away + '</div>' +
            '<div style="font-size:.68rem;color:var(--white-dim)">' + awayLeagueName + '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }).join('');
    return '<div class="wrap-section"><div class="wrap-section-title">' + group.round + '</div>' + cards + '</div>';
  }).join('');
}

// API-Football: fetch european fixtures for Big 5 clubs
async function afFetchEuropeanFixtures() {
  const euroLeagues = { ucl: 2, uel: 3, uecl: 848 }; // API-Football league IDs
  const big5Teams = new Set(Object.values(DEMO.fixtures).flat().map(f => [f.home,f.away]).flat().map(t => t.toLowerCase()));

  const newFixtures = [];
  for (const [comp, leagueId] of Object.entries(euroLeagues)) {
    try {
      const dateFrom = new Date(Date.now() - 14*86400000).toISOString().slice(0,10);
      const dateTo   = new Date(Date.now() + 35*86400000).toISOString().slice(0,10);
      const data = await afFetch('/fixtures', { league: leagueId, season: AF_SEASON, from: dateFrom, to: dateTo });
      if (!data || !data.length) continue;

      data.forEach(m => {
        const home = normTeam(m.teams.home.name);
        const away = normTeam(m.teams.away.name);
        // Only include if at least one team is from Big 5
        const homeBig5 = big5Teams.has(home.toLowerCase());
        const awayBig5 = big5Teams.has(away.toLowerCase());
        if (!homeBig5 && !awayBig5) return;

        const compMap = { 2:'UCL', 3:'UEL', 848:'UECL' };
        const clsMap  = { 2:'euro-comp-ucl', 3:'euro-comp-uel', 848:'euro-comp-uecl' };
        newFixtures.push({
          comp:    compMap[leagueId],
          compCls: clsMap[leagueId],
          round:   m.league.round || 'Knockout',
          home, away,
          date:   m.fixture.date.slice(0,10),
          time:   m.fixture.date.slice(11,16),
          result: m.fixture.status.short === 'FT' ? { h: m.goals.home, a: m.goals.away } : null,
          homeLeague: homeBig5 ? Object.entries(AF_LEAGUES).find(([,id]) => id === m.teams.home.id)?.[0] || null : null,
          awayLeague: awayBig5 ? Object.entries(AF_LEAGUES).find(([,id]) => id === m.teams.away.id)?.[0] || null : null,
        });
      });
    } catch(e) { console.warn('Euro fixtures error:', e.message); }
  }
  if (newFixtures.length) {
    DEMO.euroFixtures = newFixtures;
    if (state.activeTab === 'europe') renderEurope();
    console.log('%c🏆 European fixtures loaded:', 'color:#6699ff', newFixtures.length);
  }
}

// ============================================================
// FEATURE 8: WEEKEND WRAP — auto-generated matchweek summary
// ============================================================
function renderWeekendWrap() {
  const el = document.getElementById('wrapContent');
  if (!el) return;

  // Gather all recent results across leagues
  const allResults = [];
  Object.entries(DEMO.fixtures).forEach(([leagueKey, fxs]) => {
    fxs.filter(f => f.result).forEach(f => {
      const diff = Math.abs(f.result.h - f.result.a);
      const totalGoals = f.result.h + f.result.a;
      allResults.push({ ...f, leagueKey, diff, totalGoals,
        winner: f.result.h > f.result.a ? f.home : f.result.a > f.result.h ? f.away : null,
        loser:  f.result.h > f.result.a ? f.away : f.result.a > f.result.h ? f.home : null,
      });
    });
  });

  if (!allResults.length) {
    el.innerHTML = '<div class="wrap-no-data">⏳ No results yet for the latest matchweek.<br><span style="font-size:.82rem">Results will appear here after games are played.</span></div>';
    return;
  }

  // Stats
  const totalGoals  = allResults.reduce((a,r) => a + r.totalGoals, 0);
  const totalGames  = allResults.length;
  const avgGoals    = (totalGoals / totalGames).toFixed(1);
  const biggestWin  = [...allResults].sort((a,b) => b.diff - a.diff)[0];
  const highScorer  = [...allResults].sort((a,b) => b.totalGoals - a.totalGoals)[0];
  const draws       = allResults.filter(r => !r.winner).length;

  // Shocks: lower-mid team beats top team (crude: bigger away win)
  const shocks      = allResults.filter(r => r.result.a > r.result.h + 1);

  // Most recent results by date
  const recent = [...allResults].sort((a,b) => b.date.localeCompare(a.date)).slice(0,10);

  const leagueNames = { pl:'🏴󠁧󠁢󠁥󠁮󠁧󠁿 PL', ll:'🇪🇸 LL', sa:'🇮🇹 SA', bl:'🇩🇪 BL', l1:'🇫🇷 L1' };

  el.innerHTML =
    // ── Headline Stats ──
    '<div class="wrap-stat-grid mb-24" style="grid-template-columns:repeat(4,1fr);margin-bottom:20px;">' +
      '<div class="wrap-stat-box"><div class="wrap-stat-val">' + totalGames + '</div><div class="wrap-stat-label">Games</div></div>' +
      '<div class="wrap-stat-box"><div class="wrap-stat-val">' + totalGoals + '</div><div class="wrap-stat-label">Goals</div></div>' +
      '<div class="wrap-stat-box"><div class="wrap-stat-val">' + avgGoals + '</div><div class="wrap-stat-label">Per Game</div></div>' +
      '<div class="wrap-stat-box"><div class="wrap-stat-val">' + draws + '</div><div class="wrap-stat-label">Draws</div></div>' +
    '</div>' +

    // ── Highlights ──
    '<div class="wrap-section">' +
      '<div class="wrap-section-title">🌟 Highlights</div>' +
      (biggestWin ? '<div class="wrap-highlight"><span class="wrap-highlight-icon">💥</span><div><strong>' + biggestWin.winner + '</strong> biggest win: ' + biggestWin.home + ' ' + biggestWin.result.h + '–' + biggestWin.result.a + ' ' + biggestWin.away + ' <span style="color:var(--white-dim);font-size:.72rem">' + leagueNames[biggestWin.leagueKey] + '</span></div></div>' : '') +
      (highScorer && highScorer.totalGoals >= 4 ? '<div class="wrap-highlight"><span class="wrap-highlight-icon">⚽</span><div>Goal fest: <strong>' + highScorer.home + ' ' + highScorer.result.h + '–' + highScorer.result.a + ' ' + highScorer.away + '</strong> (' + highScorer.totalGoals + ' goals) <span style="color:var(--white-dim);font-size:.72rem">' + leagueNames[highScorer.leagueKey] + '</span></div></div>' : '') +
      (shocks.length ? shocks.slice(0,2).map(s => '<div class="wrap-highlight"><span class="wrap-highlight-icon">😱</span><div>Shock result: <strong>' + s.home + ' ' + s.result.h + '–' + s.result.a + ' ' + s.away + '</strong><span class="wrap-shock">UPSET</span> <span style="color:var(--white-dim);font-size:.72rem">' + leagueNames[s.leagueKey] + '</span></div></div>').join('') : '') +
    '</div>' +

    // ── Recent Results ──
    '<div class="wrap-section">' +
      '<div class="wrap-section-title">📋 Recent Results</div>' +
      recent.map(r => {
        const lg = leagueNames[r.leagueKey] || r.leagueKey;
        return '<div class="wrap-result-row">' +
          '<span style="flex:1;text-align:right;font-family:Barlow Condensed;font-weight:' + (r.result.h > r.result.a ? '700' : '400') + '">' + r.home + '</span>' +
          '<span class="wrap-score">' + r.result.h + '–' + r.result.a + '</span>' +
          '<span style="flex:1;font-family:Barlow Condensed;font-weight:' + (r.result.a > r.result.h ? '700' : '400') + '">' + r.away + '</span>' +
          '<span style="font-size:.65rem;color:var(--white-dim);width:42px;text-align:right;font-family:Barlow Condensed">' + lg + '</span>' +
        '</div>';
      }).join('') +
    '</div>';
}

// ============================================================
// FEATURE 9: FAVOURITES SYSTEM
// ============================================================
let FAV_TEAMS = JSON.parse(localStorage.getItem('favTeams') || '[]');
const MAX_FAVS = 5;

function isFavTeam(team) {
  return FAV_TEAMS.some(f => f.toLowerCase() === team.toLowerCase());
}

function removeFavIdx(idx) {
  FAV_TEAMS.splice(idx, 1);
  saveFavs();
}

function toggleFavTeam(el) {
  const team = el.dataset.team;
  if (!team) return;
  if (isFavTeam(team)) { removeFav(team); }
  else { addFav(team); }
  renderFavourites();
  renderFavNextFixtures();
}

function saveFavs() {
  localStorage.setItem('favTeams', JSON.stringify(FAV_TEAMS));
}

function addFav(team) {
  if (isFavTeam(team)) return;
  if (FAV_TEAMS.length >= MAX_FAVS) {
    alert('You can only follow up to 5 teams. Remove one first.');
    return;
  }
  FAV_TEAMS.push(team);
  saveFavs();
}

function removeFav(team) {
  FAV_TEAMS = FAV_TEAMS.filter(f => f.toLowerCase() !== team.toLowerCase());
  saveFavs();
}

function toggleFavFromFixture(home, away, e) {
  e.stopPropagation();
  // Toggle the relevant team(s) — if one is already faved, remove it; else add home
  if (isFavTeam(home)) { removeFav(home); }
  else if (isFavTeam(away)) { removeFav(away); }
  else { addFav(home); }
  // Re-render fixtures to update stars
  if (state.activeTab === 'fixtures') renderFixtures();
  if (state.activeTab === 'favourites') renderFavourites();
  renderFavNextFixtures();
}

function clearFavourites() {
  if (!confirm('Clear all followed teams?')) return;
  FAV_TEAMS = [];
  saveFavs();
  renderFavourites();
  renderFavNextFixtures();
}

function renderFavNextFixtures() {
  const el = document.getElementById('favNextFixtures');
  if (!el) return;
  if (!FAV_TEAMS.length) {
    el.innerHTML = '<div style="color:var(--white-dim);padding:20px;text-align:center;font-family:Barlow Condensed;font-size:.82rem;">Star a team in Fixtures to track them here</div>';
    return;
  }
  const upcoming = Object.values(DEMO.fixtures).flat()
    .filter(f => !f.result && (isFavTeam(f.home) || isFavTeam(f.away)))
    .sort((a,b) => a.date.localeCompare(b.date))
    .slice(0, 5);

  if (!upcoming.length) {
    el.innerHTML = '<div style="color:var(--white-dim);padding:20px;text-align:center;font-family:Barlow Condensed;font-size:.82rem;">No upcoming fixtures found for your teams</div>';
    return;
  }
  el.innerHTML = upcoming.map(f => {
    const dateStr = new Date(f.date).toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short'});
    const favHome = isFavTeam(f.home);
    return '<div class="wrap-result-row" style="padding:8px 0;">' +
      '<span style="flex:1;text-align:right;font-family:Barlow Condensed;font-weight:' + (favHome ? '700;color:var(--gold)' : '400') + '">' + f.home + '</span>' +
      '<span style="font-size:.72rem;color:var(--white-dim);padding:0 8px;font-family:Barlow Condensed;">' + dateStr + '</span>' +
      '<span style="flex:1;font-family:Barlow Condensed;font-weight:' + (!favHome ? '700;color:var(--gold)' : '400') + '">' + f.away + '</span>' +
    '</div>';
  }).join('');
}

function renderFavourites() {
  // Update banner chips
  const banner  = document.getElementById('favBanner');
  const hint    = document.getElementById('favEmptyHint');
  const chipsEl = document.getElementById('favChips');
  if (banner && hint && chipsEl) {
    if (FAV_TEAMS.length) {
      banner.style.display = 'flex';
      hint.style.display   = 'none';
      chipsEl.innerHTML = FAV_TEAMS.map((t, i) =>
        '<span class="fav-team-chip">' + t + '<span class="fav-chip-remove" onclick="removeFavIdx(' + i + ');renderFavourites();renderFavNextFixtures();">✕</span></span>'
      ).join('');
    } else {
      banner.style.display = 'none';
      hint.style.display   = 'flex';
      chipsEl.innerHTML    = '';
    }
  }

  // Upcoming fixtures
  const upcomingEl = document.getElementById('favUpcomingFixtures');
  const allFx = Object.values(DEMO.fixtures).flat();
  if (upcomingEl) {
    if (!FAV_TEAMS.length) {
      upcomingEl.innerHTML = '<div style="color:var(--white-dim);padding:20px;text-align:center;font-family:Barlow Condensed">Follow some teams to see their fixtures here</div>';
    } else {
      const upcoming = allFx.filter(f => !f.result && (isFavTeam(f.home) || isFavTeam(f.away)))
        .sort((a,b) => a.date.localeCompare(b.date)).slice(0,8);
      if (!upcoming.length) {
        upcomingEl.innerHTML = '<div style="color:var(--white-dim);padding:20px;text-align:center;font-family:Barlow Condensed">No upcoming fixtures in the current window</div>';
      } else {
        upcomingEl.innerHTML = upcoming.map(f => {
          const dateStr = new Date(f.date).toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short'});
          const favH = isFavTeam(f.home);
          const tvBadge = getTvBadge(f.home, f.away);
          return '<div style="padding:8px 0;border-bottom:1px solid var(--border);">' +
            '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:3px;">' +
              '<span style="font-family:Barlow Condensed;font-weight:' + (favH?'700;color:var(--gold)':'400') + '">' + f.home + '</span>' +
              '<span style="font-family:Barlow Condensed;font-size:.82rem;color:var(--white-dim)">' + dateStr + ' ' + f.time + '</span>' +
              '<span style="font-family:Barlow Condensed;font-weight:' + (!favH?'700;color:var(--gold)':'400') + '">' + f.away + '</span>' +
            '</div>' +
            (tvBadge ? '<div>' + tvBadge + '</div>' : '') +
          '</div>';
        }).join('');
      }
    }
  }

  // Recent results
  const resultsEl = document.getElementById('favRecentResults');
  if (resultsEl) {
    if (!FAV_TEAMS.length) {
      resultsEl.innerHTML = '<div style="color:var(--white-dim);padding:20px;text-align:center;font-family:Barlow Condensed">Follow some teams to see their results here</div>';
    } else {
      const recent = allFx.filter(f => f.result && (isFavTeam(f.home) || isFavTeam(f.away)))
        .sort((a,b) => b.date.localeCompare(a.date)).slice(0,8);
      if (!recent.length) {
        resultsEl.innerHTML = '<div style="color:var(--white-dim);padding:20px;text-align:center;font-family:Barlow Condensed">No recent results found</div>';
      } else {
        resultsEl.innerHTML = recent.map(f => {
          const favH = isFavTeam(f.home);
          const won = favH ? f.result.h > f.result.a : f.result.a > f.result.h;
          const drew = f.result.h === f.result.a;
          const outcomeColor = drew ? 'var(--gold)' : won ? 'var(--accent)' : 'var(--red-card)';
          return '<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-family:Barlow Condensed;">' +
            '<span style="width:8px;height:8px;border-radius:50%;background:' + outcomeColor + ';flex-shrink:0"></span>' +
            '<span style="flex:1;font-weight:' + (favH?'700':'400') + '">' + f.home + '</span>' +
            '<span style="font-weight:700;padding:1px 8px;background:rgba(255,255,255,0.07);border-radius:3px">' + f.result.h + '–' + f.result.a + '</span>' +
            '<span style="flex:1;text-align:right;font-weight:' + (!favH?'700':'400') + '">' + f.away + '</span>' +
          '</div>';
        }).join('');
      }
    }
  }

  // Suspension watch for fav teams
  const susEl = document.getElementById('favSuspensionWatch');
  if (susEl) {
    if (!FAV_TEAMS.length) {
      susEl.innerHTML = '<div style="color:var(--white-dim);padding:20px;text-align:center;font-family:Barlow Condensed">Follow some teams to see suspension risks</div>';
    } else {
      const threshold = 5;
      const risks = DEMO.bookedPlayers.filter(p =>
        isFavTeam(p.team) && p.yellow >= threshold - 2
      ).sort((a,b) => b.yellow - a.yellow);
      if (!risks.length) {
        susEl.innerHTML = '<div style="color:var(--accent);padding:16px;text-align:center;font-family:Barlow Condensed;font-weight:700">✅ No immediate suspension risks for your teams</div>';
      } else {
        susEl.innerHTML = risks.map(p => {
          const remaining = threshold - p.yellow;
          const danger = remaining <= 1;
          return '<div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);font-family:Barlow Condensed;">' +
            '<div style="width:36px;height:36px;border-radius:50%;background:' + (danger?'rgba(230,57,70,0.3)':'rgba(245,200,66,0.2)') + ';display:flex;align-items:center;justify-content:center;font-weight:700;">' + p.player.charAt(0) + '</div>' +
            '<div style="flex:1;">' +
              '<div style="font-weight:700">' + p.player + '</div>' +
              '<div style="font-size:.72rem;color:var(--white-dim)">' + p.team + ' · ' + p.yellow + ' yellows this season</div>' +
            '</div>' +
            '<span style="font-weight:700;font-size:.78rem;padding:3px 8px;border-radius:3px;background:' + (danger?'rgba(230,57,70,0.2)':'rgba(245,200,66,0.15)') + ';color:' + (danger?'var(--red-card)':'var(--gold)') + '">' +
              (remaining <= 0 ? 'SUSPENDED' : remaining === 1 ? '1 FROM BAN' : '2 FROM BAN') +
            '</span>' +
          '</div>';
        }).join('');
      }
    }
  }

  // All teams picker
  const pickerEl = document.getElementById('allTeamsPicker');
  if (pickerEl) {
    const allTeams = [...new Set(Object.values(DEMO.fixtures).flat().flatMap(f => [f.home, f.away]))].sort();
    pickerEl.innerHTML = allTeams.map((t, ti) => {
      const isFav = isFavTeam(t);
      const safe = t.replace(/&/g,'&amp;').replace(/"/g,'&quot;');
      return '<div style="display:inline-flex;align-items:center;gap:5px;padding:5px 10px;border:1px solid ' + (isFav?'rgba(255,200,50,0.4)':'var(--border)') + ';border-radius:16px;cursor:pointer;font-family:Barlow Condensed;font-size:.82rem;background:' + (isFav?'rgba(255,200,50,0.1)':'transparent') + ';transition:all .15s;" onclick="toggleFavTeam(this)" data-team="' + safe + '">' +
        '<span>' + (isFav ? '⭐' : '☆') + '</span>' + t +
      '</div>';
    }).join('');
  }
}

// ============================================================
// FEATURE 10: PWA — Progressive Web App (iOS + Android)
// ============================================================

// ── Device / context detection ───────────────────────────────
function isIos() {
  return /iphone|ipad|ipod/i.test(navigator.userAgent) ||
    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
}

function isInStandaloneMode() {
  return ('standalone' in navigator && navigator.standalone) ||
    window.matchMedia('(display-mode: standalone)').matches;
}

function iosVersion() {
  const match = navigator.userAgent.match(/OS (\d+)_(\d+)/);
  return match ? parseInt(match[1]) : 0;
}

// ── Android / Chrome install prompt ─────────────────────────
let deferredPwaPrompt = null;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPwaPrompt = e;
  if (!localStorage.getItem('pwaDismissed')) {
    setTimeout(() => {
      const el = document.getElementById('pwaPrompt');
      if (el) el.classList.remove('hidden');
    }, 30000);
  }
});

async function installPwa() {
  if (!deferredPwaPrompt) return;
  deferredPwaPrompt.prompt();
  const result = await deferredPwaPrompt.userChoice;
  deferredPwaPrompt = null;
  const el = document.getElementById('pwaPrompt');
  if (el) el.classList.add('hidden');
  if (result.outcome === 'accepted') console.log('%c📱 PWA installed!', 'color:#4ade80;font-weight:bold');
}

function dismissPwa() {
  const el = document.getElementById('pwaPrompt');
  if (el) el.classList.add('hidden');
  localStorage.setItem('pwaDismissed', '1');
}

window.addEventListener('appinstalled', () => {
  document.getElementById('pwaPrompt')?.classList.add('hidden');
  hideIosHint();
  console.log('%c📱 Football Oracle installed as PWA', 'color:#4ade80');
});

// ── iOS Add-to-Home-Screen hint ──────────────────────────────
const IOS_HINT_KEY      = 'iosHintDismissed';
const IOS_HINT_DELAY_MS = 25000; // show after 25s

function shouldShowIosHint() {
  if (!isIos()) return false;               // not iOS
  if (isInStandaloneMode()) return false;   // already installed
  if (localStorage.getItem(IOS_HINT_KEY)) return false; // permanently dismissed
  if (iosVersion() < 14) return false;      // too old, Share sheet works differently
  return true;
}

function showIosHint() {
  const sheet    = document.getElementById('iosHintSheet');
  const backdrop = document.getElementById('iosHintBackdrop');
  const arrow    = document.getElementById('iosHintArrow');
  if (!sheet) return;

  sheet.classList.add('visible');
  if (backdrop) backdrop.classList.add('visible');

  // Pulse arrow pointing to Safari Share button
  if (arrow) {
    arrow.style.display = 'block';
    // Position just above the Safari toolbar (~83px from bottom on iPhone 16 Pro Max)
    arrow.style.bottom = '78px';
  }

  // Lock body scroll while sheet is open
  document.body.style.overflow = 'hidden';
  console.log('%c📱 iOS install hint shown', 'color:#4da6ff');
}

function hideIosHint() {
  const sheet    = document.getElementById('iosHintSheet');
  const backdrop = document.getElementById('iosHintBackdrop');
  const arrow    = document.getElementById('iosHintArrow');

  sheet?.classList.remove('visible');
  backdrop?.classList.remove('visible');
  if (arrow) arrow.style.display = 'none';
  document.body.style.overflow = '';
}

function dismissIosHint() {
  hideIosHint();
  const dontShow = document.getElementById('iosDontShow');
  if (dontShow?.checked) {
    localStorage.setItem(IOS_HINT_KEY, '1');
    console.log('iOS hint: permanently dismissed');
  } else {
    // Show again next session (session-only dismiss)
    sessionStorage.setItem('iosHintThisSession', '1');
    console.log('iOS hint: dismissed for this session');
  }
}

function initPwa() {
  // Android/Chrome: handled by beforeinstallprompt above
  // iOS: show hint after delay if eligible
  if (shouldShowIosHint() && !sessionStorage.getItem('iosHintThisSession')) {
    setTimeout(showIosHint, IOS_HINT_DELAY_MS);
    console.log('%c📱 iOS detected — install hint scheduled in 25s', 'color:#4da6ff');
  } else if (isInStandaloneMode()) {
    console.log('%c📱 Running as installed PWA', 'color:#4ade80');
  } else if (isIos()) {
    console.log('ℹ️ iOS hint suppressed (already dismissed or installed)');
  }
}

// ============================================================
// WORLD CUP DATA & RENDER ENGINE
// ============================================================

const WC_HISTORY = [
  { year:1930, host:'Uruguay',           winner:'Uruguay',       runnerUp:'Argentina',     third:'United States', fourth:'Yugoslavia',   finalScore:'4–2',              goals:70,  matches:18, teams:13, goalsPerMatch:3.89, attendance:590549,   topScorer:'Guillermo Stábile (ARG)',  scorerGoals:8,  era:'early' },
  { year:1934, host:'Italy',             winner:'Italy',         runnerUp:'Czechoslovakia',third:'Germany',       fourth:'Austria',      finalScore:'2–1 (aet)',        goals:70,  matches:17, teams:16, goalsPerMatch:4.12, attendance:363000,   topScorer:'Oldřich Nejedlý (CZE)',   scorerGoals:5,  era:'early' },
  { year:1938, host:'France',            winner:'Italy',         runnerUp:'Hungary',       third:'Brazil',        fourth:'Sweden',       finalScore:'4–2',              goals:84,  matches:18, teams:15, goalsPerMatch:4.67, attendance:375700,   topScorer:'Leônidas (BRA)',           scorerGoals:7,  era:'early' },
  { year:1950, host:'Brazil',            winner:'Uruguay',       runnerUp:'Brazil',        third:'Sweden',        fourth:'Spain',        finalScore:'2–1',              goals:88,  matches:22, teams:13, goalsPerMatch:4.0,  attendance:1045246,  topScorer:'Ademir (BRA)',             scorerGoals:8,  era:'early' },
  { year:1954, host:'Switzerland',       winner:'West Germany',  runnerUp:'Hungary',       third:'Austria',       fourth:'Uruguay',      finalScore:'3–2',              goals:140, matches:26, teams:16, goalsPerMatch:5.38, attendance:768607,   topScorer:'Sándor Kocsis (HUN)',      scorerGoals:11, era:'classic' },
  { year:1958, host:'Sweden',            winner:'Brazil',        runnerUp:'Sweden',        third:'France',        fourth:'West Germany', finalScore:'5–2',              goals:126, matches:35, teams:16, goalsPerMatch:3.60, attendance:819810,   topScorer:'Just Fontaine (FRA)',      scorerGoals:13, era:'classic' },
  { year:1962, host:'Chile',             winner:'Brazil',        runnerUp:'Czechoslovakia',third:'Chile',         fourth:'Yugoslavia',   finalScore:'3–1',              goals:89,  matches:32, teams:16, goalsPerMatch:2.78, attendance:893172,   topScorer:'Garrincha / Vavá (4 each)',scorerGoals:4,  era:'classic' },
  { year:1966, host:'England',           winner:'England',       runnerUp:'West Germany',  third:'Portugal',      fourth:'Soviet Union', finalScore:'4–2 (aet)',        goals:89,  matches:32, teams:16, goalsPerMatch:2.78, attendance:1563135,  topScorer:'Eusébio (POR)',            scorerGoals:9,  era:'classic' },
  { year:1970, host:'Mexico',            winner:'Brazil',        runnerUp:'Italy',         third:'West Germany',  fourth:'Uruguay',      finalScore:'4–1',              goals:95,  matches:32, teams:16, goalsPerMatch:2.97, attendance:1603975,  topScorer:'Gerd Müller (WGR)',        scorerGoals:10, era:'classic' },
  { year:1974, host:'West Germany',      winner:'West Germany',  runnerUp:'Netherlands',   third:'Poland',        fourth:'Brazil',       finalScore:'2–1',              goals:97,  matches:38, teams:16, goalsPerMatch:2.55, attendance:1865753,  topScorer:'Grzegorz Lato (POL)',      scorerGoals:7,  era:'classic' },
  { year:1978, host:'Argentina',         winner:'Argentina',     runnerUp:'Netherlands',   third:'Brazil',        fourth:'Italy',        finalScore:'3–1 (aet)',        goals:102, matches:38, teams:16, goalsPerMatch:2.68, attendance:1545791,  topScorer:'Mario Kempes (ARG)',       scorerGoals:6,  era:'modern' },
  { year:1982, host:'Spain',             winner:'Italy',         runnerUp:'West Germany',  third:'Poland',        fourth:'France',       finalScore:'3–1',              goals:146, matches:52, teams:24, goalsPerMatch:2.81, attendance:2109723,  topScorer:'Paolo Rossi (ITA)',        scorerGoals:6,  era:'modern' },
  { year:1986, host:'Mexico',            winner:'Argentina',     runnerUp:'West Germany',  third:'France',        fourth:'Belgium',      finalScore:'3–2',              goals:132, matches:52, teams:24, goalsPerMatch:2.54, attendance:2394031,  topScorer:'Gary Lineker (ENG)',       scorerGoals:6,  era:'modern' },
  { year:1990, host:'Italy',             winner:'West Germany',  runnerUp:'Argentina',     third:'Italy',         fourth:'England',      finalScore:'1–0',              goals:115, matches:52, teams:24, goalsPerMatch:2.21, attendance:2516215,  topScorer:'Salvatore Schillaci (ITA)',scorerGoals:6,  era:'modern' },
  { year:1994, host:'United States',     winner:'Brazil',        runnerUp:'Italy',         third:'Sweden',        fourth:'Bulgaria',     finalScore:'0–0 (3–2 pen.)',   goals:141, matches:52, teams:24, goalsPerMatch:2.71, attendance:3587538,  topScorer:'Salenko / Stoichkov (6)',  scorerGoals:6,  era:'modern' },
  { year:1998, host:'France',            winner:'France',        runnerUp:'Brazil',        third:'Croatia',       fourth:'Netherlands',  finalScore:'3–0',              goals:171, matches:64, teams:32, goalsPerMatch:2.67, attendance:2785100,  topScorer:'Davor Šuker (CRO)',        scorerGoals:6,  era:'recent' },
  { year:2002, host:'South Korea/Japan', winner:'Brazil',        runnerUp:'Germany',       third:'Turkey',        fourth:'South Korea',  finalScore:'2–0',              goals:161, matches:64, teams:32, goalsPerMatch:2.52, attendance:2705197,  topScorer:'Ronaldo (BRA)',            scorerGoals:8,  era:'recent' },
  { year:2006, host:'Germany',           winner:'Italy',         runnerUp:'France',        third:'Germany',       fourth:'Portugal',     finalScore:'1–1 (5–3 pen.)',   goals:147, matches:64, teams:32, goalsPerMatch:2.30, attendance:3359439,  topScorer:'Miroslav Klose (GER)',     scorerGoals:5,  era:'recent' },
  { year:2010, host:'South Africa',      winner:'Spain',         runnerUp:'Netherlands',   third:'Germany',       fourth:'Uruguay',      finalScore:'1–0 (aet)',        goals:145, matches:64, teams:32, goalsPerMatch:2.27, attendance:3178856,  topScorer:'Thomas Müller (GER)',      scorerGoals:5,  era:'recent' },
  { year:2014, host:'Brazil',            winner:'Germany',       runnerUp:'Argentina',     third:'Netherlands',   fourth:'Brazil',       finalScore:'1–0 (aet)',        goals:171, matches:64, teams:32, goalsPerMatch:2.67, attendance:3429873,  topScorer:'James Rodríguez (COL)',    scorerGoals:6,  era:'recent' },
  { year:2018, host:'Russia',            winner:'France',        runnerUp:'Croatia',       third:'Belgium',       fourth:'England',      finalScore:'4–2',              goals:169, matches:64, teams:32, goalsPerMatch:2.64, attendance:3031768,  topScorer:'Harry Kane (ENG)',         scorerGoals:6,  era:'recent' },
  { year:2022, host:'Qatar',             winner:'Argentina',     runnerUp:'France',        third:'Croatia',       fourth:'Morocco',      finalScore:'3–3 (4–2 pen.)',   goals:172, matches:64, teams:32, goalsPerMatch:2.69, attendance:3404252,  topScorer:'Kylian Mbappé (FRA)',      scorerGoals:8,  era:'recent' },
];

const WC_CHAMPIONS = [
  { country:'Brazil',       flag:'🇧🇷', titles:5, years:'1958, 1962, 1970, 1994, 2002' },
  { country:'Germany',      flag:'🇩🇪', titles:4, years:'1954, 1974, 1990, 2014', note:'incl. 3 as West Germany' },
  { country:'Italy',        flag:'🇮🇹', titles:4, years:'1934, 1938, 1982, 2006' },
  { country:'Argentina',    flag:'🇦🇷', titles:3, years:'1978, 1986, 2022' },
  { country:'France',       flag:'🇫🇷', titles:2, years:'1998, 2018' },
  { country:'Uruguay',      flag:'🇺🇾', titles:2, years:'1930, 1950' },
  { country:'England',      flag:'🏴󠁧󠁢󠁥󠁮󠁧󠁿', titles:1, years:'1966' },
  { country:'Spain',        flag:'🇪🇸', titles:1, years:'2010' },
];

const WC_SCORERS = [
  { year:1930, player:'Guillermo Stábile',   country:'Argentina',  flag:'🇦🇷', goals:8  },
  { year:1934, player:'Oldřich Nejedlý',     country:'Czechoslovakia', flag:'🇨🇿', goals:5 },
  { year:1938, player:'Leônidas',            country:'Brazil',     flag:'🇧🇷', goals:7  },
  { year:1950, player:'Ademir',              country:'Brazil',     flag:'🇧🇷', goals:8  },
  { year:1954, player:'Sándor Kocsis',       country:'Hungary',    flag:'🇭🇺', goals:11 },
  { year:1958, player:'Just Fontaine',       country:'France',     flag:'🇫🇷', goals:13 },
  { year:1962, player:'Garrincha / Vavá',    country:'Brazil',     flag:'🇧🇷', goals:4  },
  { year:1966, player:'Eusébio',             country:'Portugal',   flag:'🇵🇹', goals:9  },
  { year:1970, player:'Gerd Müller',         country:'West Germany', flag:'🇩🇪', goals:10 },
  { year:1974, player:'Grzegorz Lato',       country:'Poland',     flag:'🇵🇱', goals:7  },
  { year:1978, player:'Mario Kempes',        country:'Argentina',  flag:'🇦🇷', goals:6  },
  { year:1982, player:'Paolo Rossi',         country:'Italy',      flag:'🇮🇹', goals:6  },
  { year:1986, player:'Gary Lineker',        country:'England',    flag:'🏴󠁧󠁢󠁥󠁮󠁧󠁿', goals:6 },
  { year:1990, player:'Salvatore Schillaci', country:'Italy',      flag:'🇮🇹', goals:6  },
  { year:1994, player:'Oleg Salenko / Hristo Stoichkov', country:'Russia / Bulgaria', flag:'🇷🇺', goals:6 },
  { year:1998, player:'Davor Šuker',         country:'Croatia',    flag:'🇭🇷', goals:6  },
  { year:2002, player:'Ronaldo',             country:'Brazil',     flag:'🇧🇷', goals:8  },
  { year:2006, player:'Miroslav Klose',      country:'Germany',    flag:'🇩🇪', goals:5  },
  { year:2010, player:'Thomas Müller',       country:'Germany',    flag:'🇩🇪', goals:5  },
  { year:2014, player:'James Rodríguez',     country:'Colombia',   flag:'🇨🇴', goals:6  },
  { year:2018, player:'Harry Kane',          country:'England',    flag:'🏴󠁧󠁢󠁥󠁮󠁧󠁿', goals:6 },
  { year:2022, player:'Kylian Mbappé',       country:'France',     flag:'🇫🇷', goals:8  },
];

const WC_HOSTS = [
  { country:'Brazil',           flag:'🇧🇷', times:2, years:'1950, 2014',  wonAsHost:false },
  { country:'France',           flag:'🇫🇷', times:2, years:'1938, 1998',  wonAsHost:true  },
  { country:'Mexico',           flag:'🇲🇽', times:2, years:'1970, 1986',  wonAsHost:false },
  { country:'Italy',            flag:'🇮🇹', times:2, years:'1934, 1990',  wonAsHost:true  },
  { country:'Uruguay',          flag:'🇺🇾', times:1, years:'1930',        wonAsHost:true  },
  { country:'Switzerland',      flag:'🇨🇭', times:1, years:'1954',        wonAsHost:false },
  { country:'Sweden',           flag:'🇸🇪', times:1, years:'1958',        wonAsHost:false },
  { country:'Chile',            flag:'🇨🇱', times:1, years:'1962',        wonAsHost:false },
  { country:'England',          flag:'🏴󠁧󠁢󠁥󠁮󠁧󠁿', times:1, years:'1966',       wonAsHost:true  },
  { country:'West Germany',     flag:'🇩🇪', times:1, years:'1974',        wonAsHost:true  },
  { country:'Argentina',        flag:'🇦🇷', times:1, years:'1978',        wonAsHost:true  },
  { country:'Spain',            flag:'🇪🇸', times:1, years:'1982',        wonAsHost:false },
  { country:'United States',    flag:'🇺🇸', times:1, years:'1994',        wonAsHost:false },
  { country:'South Korea/Japan',flag:'🇰🇷', times:1, years:'2002',        wonAsHost:false },
  { country:'Germany',          flag:'🇩🇪', times:1, years:'2006',        wonAsHost:false },
  { country:'South Africa',     flag:'🇿🇦', times:1, years:'2010',        wonAsHost:false },
  { country:'Russia',           flag:'🇷🇺', times:1, years:'2018',        wonAsHost:false },
  { country:'Qatar',            flag:'🇶🇦', times:1, years:'2022',        wonAsHost:false },
];

const WC_RANKINGS = [
  { rank:1,  country:'Spain',          flag:'🇪🇸', conf:'UEFA',     pts:'1877.18', titles:1, best:'Champions (2010)'   },
  { rank:2,  country:'Argentina',      flag:'🇦🇷', conf:'CONMEBOL', pts:'1873.33', titles:3, best:'Champions (2022)'   },
  { rank:3,  country:'France',         flag:'🇫🇷', conf:'UEFA',     pts:'1870.00', titles:2, best:'Champions (2018)'   },
  { rank:4,  country:'England',        flag:'🏴󠁧󠁢󠁥󠁮󠁧󠁿', conf:'UEFA',    pts:'1834.12', titles:1, best:'Champions (1966)'  },
  { rank:5,  country:'Brazil',         flag:'🇧🇷', conf:'CONMEBOL', pts:'1760.46', titles:5, best:'Champions (2002)'   },
  { rank:6,  country:'Portugal',       flag:'🇵🇹', conf:'UEFA',     pts:'1760.38', titles:0, best:'3rd Place (1966)'   },
  { rank:7,  country:'Netherlands',    flag:'🇳🇱', conf:'UEFA',     pts:'1756.27', titles:0, best:'Runner-Up (2010)'   },
  { rank:8,  country:'Morocco',        flag:'🇲🇦', conf:'CAF',      pts:'1736.57', titles:0, best:'4th Place (2022)'   },
  { rank:9,  country:'Belgium',        flag:'🇧🇪', conf:'UEFA',     pts:'1730.71', titles:0, best:'3rd Place (2018)'   },
  { rank:10, country:'Germany',        flag:'🇩🇪', conf:'UEFA',     pts:'1724.15', titles:4, best:'Champions (2014)'   },
  { rank:11, country:'Croatia',        flag:'🇭🇷', conf:'UEFA',     pts:'1716.88', titles:0, best:'Runner-Up (2018)'   },
  { rank:12, country:'Senegal',        flag:'🇸🇳', conf:'CAF',      pts:'1706.83', titles:0, best:'QF (2002)'          },
  { rank:13, country:'Italy',          flag:'🇮🇹', conf:'UEFA',     pts:'1702.06', titles:4, best:'Champions (2006)'   },
  { rank:14, country:'Colombia',       flag:'🇨🇴', conf:'CONMEBOL', pts:'1701.30', titles:0, best:'QF (2014)'          },
  { rank:15, country:'United States',  flag:'🇺🇸', conf:'CONCACAF', pts:'1681.88', titles:0, best:'3rd Place (1930)'   },
  { rank:16, country:'Mexico',         flag:'🇲🇽', conf:'CONCACAF', pts:'1675.75', titles:0, best:'QF (1970, 1986)'    },
  { rank:17, country:'Uruguay',        flag:'🇺🇾', conf:'CONMEBOL', pts:'1672.62', titles:2, best:'Champions (1950)'   },
  { rank:18, country:'Switzerland',    flag:'🇨🇭', conf:'UEFA',     pts:'1654.69', titles:0, best:'QF (1934–54)'       },
  { rank:19, country:'Japan',          flag:'🇯🇵', conf:'AFC',      pts:'1650.12', titles:0, best:'R16 (2002–2022)'    },
  { rank:20, country:'Iran',           flag:'🇮🇷', conf:'AFC',      pts:'1617.02', titles:0, best:'Group Stage'        },
  { rank:21, country:'United States',  flag:'🇺🇸', conf:'CONCACAF', pts:'1600.00', titles:0, best:'3rd (1930)'         },
  { rank:22, country:'Australia',      flag:'🇦🇺', conf:'AFC',      pts:'1595.40', titles:0, best:'R16 (2006, 2022)'   },
  { rank:23, country:'Ecuador',        flag:'🇪🇨', conf:'CONMEBOL', pts:'1581.20', titles:0, best:'R16 (2002)'         },
  { rank:24, country:'Ukraine',        flag:'🇺🇦', conf:'UEFA',     pts:'1577.10', titles:0, best:'QF (2006)'          },
  { rank:25, country:'Poland',         flag:'🇵🇱', conf:'UEFA',     pts:'1571.80', titles:0, best:'3rd Place (1974)'   },
  { rank:26, country:'Hungary',        flag:'🇭🇺', conf:'UEFA',     pts:'1566.50', titles:0, best:'Runner-Up (1954)'   },
  { rank:27, country:'Turkey',         flag:'🇹🇷', conf:'UEFA',     pts:'1554.30', titles:0, best:'3rd Place (2002)'   },
  { rank:28, country:'South Korea',    flag:'🇰🇷', conf:'AFC',      pts:'1541.60', titles:0, best:'4th Place (2002)'   },
  { rank:29, country:'Saudi Arabia',   flag:'🇸🇦', conf:'AFC',      pts:'1529.80', titles:0, best:'R16 (1994)'         },
  { rank:30, country:'Tunisia',        flag:'🇹🇳', conf:'CAF',      pts:'1518.40', titles:0, best:'Group Stage'        },
];

const WC_RECORDS = [
  { icon:'⚽', val:'13', label:'Most Goals in a Tournament', detail:'Just Fontaine (France) — 1958 World Cup in Sweden. An all-time record unlikely to ever be broken.' },
  { icon:'🏆', val:'5', label:'Most World Cup Titles', detail:'Brazil — won in 1958, 1962, 1970, 1994 and 2002. The only nation to have competed in every World Cup.' },
  { icon:'🎯', val:'16', label:'Most Goals in One Match', detail:'Austria 7–5 Switzerland (1954). The highest-scoring game in World Cup history.' },
  { icon:'📺', val:'3,587,538', label:'Highest Total Attendance', detail:'USA 1994 — still the most attended World Cup, drawing over 3.5 million fans across 52 matches.' },
  { icon:'📉', val:'2.21', label:'Lowest Goals Per Game', detail:'Italy 1990 — the most defensively dominated tournament with just 2.21 goals per match.' },
  { icon:'📈', val:'5.38', label:'Highest Goals Per Game', detail:'Switzerland 1954 — the most prolific tournament ever with 5.38 goals per match and 140 total goals.' },
  { icon:'🥇', val:'4', label:'Most Final Appearances', detail:'Germany / West Germany have appeared in 8 finals (1954, 1966, 1974, 1982, 1986, 1990, 2002, 2014).' },
  { icon:'👑', val:'2022', label:'Most Recent Winner', detail:'Argentina beat France 3–3 (4–2 pens) in Lusail Stadium, Qatar. Lionel Messi&#39;s crowning glory.' },
  { icon:'🌍', val:'8', label:'Nations to Win the World Cup', detail:'Brazil, Germany, Italy, Argentina, France, Uruguay, England and Spain are the only champions.' },
  { icon:'📅', val:'1930', label:'First World Cup', detail:'Uruguay hosted and won the inaugural tournament in Montevideo. 13 teams, 70 goals, 590,549 fans.' },
  { icon:'🥅', val:'172', label:'Most Goals in One Tournament', detail:'Qatar 2022 — 172 goals in 64 matches, breaking the previous record shared with 1998 and 2014.' },
  { icon:'🌟', val:'1966', label:'Host Nation Victory (Last)', detail:'England are the last host nation to win the World Cup, beating West Germany 4–2 at Wembley.' },
];

// ── Active filter state ──
let wcActiveFilter = 'all';

function wcFilter(filter, btn) {
  wcActiveFilter = filter;
  document.querySelectorAll('.wc-filter-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');

  const sections = ['history','champions','scorers','hosts','records','rankings'];
  sections.forEach(s => {
    const el = document.getElementById('wc-section-' + s);
    if (!el) return;
    if (filter === 'all' || filter === s) {
      el.style.display = '';
    } else {
      el.style.display = 'none';
    }
  });
}

// ── Era label ──
function wcEraTag(era) {
  const map = {
    early:   ['EARLY ERA',    'wc-era-early'],
    classic: ['CLASSIC ERA',  'wc-era-classic'],
    modern:  ['MODERN ERA',   'wc-era-modern'],
    recent:  ['RECENT ERA',   'wc-era-recent'],
  };
  const [label, cls] = map[era] || ['', ''];
  return `<span class="wc-era-tag ${cls}">${label}</span>`;
}

// ── Format score for display ──
function wcFormatScore(score) {
  if (score.includes('pen')) {
    const base = score.split('(')[0].trim();
    const pen  = score.match(/\(([^)]+)\)/)?.[1] || '';
    return `${base} <span class="wc-pen-tag">PEN</span>`;
  }
  if (score.includes('aet')) {
    const base = score.replace('(aet)','').trim();
    return `${base} <span class="wc-aet-tag">AET</span>`;
  }
  return score;
}

// ── Render history table ──
function renderWcHistory() {
  const tbody = document.getElementById('wcHistoryBody');
  if (!tbody) return;
  tbody.innerHTML = WC_HISTORY.slice().reverse().map(t => `
    <tr>
      <td><span class="wc-year-badge">${t.year}</span></td>
      <td>${t.host}</td>
      <td><span class="wc-winner-chip">🏆 ${t.winner}</span></td>
      <td>${t.runnerUp}</td>
      <td><span class="wc-score-pill">${wcFormatScore(t.finalScore)}</span></td>
      <td style="color:var(--white-dim)">${t.third}</td>
      <td style="color:var(--white-dim);font-size:.8rem">${t.fourth}</td>
      <td style="text-align:center">${t.teams}</td>
      <td style="text-align:center">${t.matches}</td>
      <td style="text-align:center"><span class="wc-goals-num">${t.goals}</span></td>
      <td style="text-align:center;color:var(--white-dim)">${t.goalsPerMatch.toFixed(2)}</td>
      <td style="font-size:.78rem;color:var(--white-dim)">${(t.attendance/1000000).toFixed(2)}M</td>
      <td style="font-size:.8rem;color:var(--accent)">${t.topScorer}</td>
      <td>${wcEraTag(t.era)}</td>
    </tr>
  `).join('');
}

// ── Render champions ──
function renderWcChampions() {
  const el = document.getElementById('wcChampionsGrid');
  if (!el) return;
  el.innerHTML = WC_CHAMPIONS.map(c => `
    <div class="wc-champion-card">
      <div class="wc-champion-flag">${c.flag}</div>
      <div class="wc-champion-country">${c.country}</div>
      <div class="wc-champion-titles">${'⭐'.repeat(c.titles)} ${c.titles} TITLE${c.titles > 1 ? 'S' : ''}</div>
      <div class="wc-champion-years">${c.years}${c.note ? '<br><span style="font-size:.65rem;opacity:.6">' + c.note + '</span>' : ''}</div>
    </div>
  `).join('');
}

// ── Render scorers ──
function renderWcScorers() {
  const el = document.getElementById('wcScorersGrid');
  if (!el) return;
  el.innerHTML = WC_SCORERS.slice().reverse().map((s, i) => `
    <div class="wc-scorer-card">
      <div class="wc-scorer-rank">${WC_SCORERS.length - i}</div>
      <div style="flex:1">
        <div class="wc-scorer-name">${s.flag} ${s.player}</div>
        <div class="wc-scorer-meta">${s.country} · ${s.year}</div>
        <span class="wc-scorer-goals">⚽ ${s.goals} goals</span>
      </div>
    </div>
  `).join('');
}

// ── Render hosts ──
function renderWcHosts() {
  const el = document.getElementById('wcHostsGrid');
  if (!el) return;
  // Sort: multi-host first, then alpha
  const sorted = [...WC_HOSTS].sort((a,b) => b.times - a.times || a.country.localeCompare(b.country));
  el.innerHTML = sorted.map(h => `
    <div class="wc-host-card">
      <div class="wc-host-country">${h.flag} ${h.country}</div>
      <div class="wc-host-years">${h.years}</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <span class="wc-host-badge ${h.times > 1 ? 'wc-host-multi' : 'wc-host-once'}">${h.times}× Hosted</span>
        ${h.wonAsHost ? '<span class="wc-host-badge" style="background:rgba(245,200,66,.12);color:var(--gold)">🏆 Won as Host</span>' : ''}
      </div>
    </div>
  `).join('');
}

// ── Render records ──
function renderWcRecords() {
  const el = document.getElementById('wcRecordsGrid');
  if (!el) return;
  el.innerHTML = WC_RECORDS.map(r => `
    <div class="wc-record-card">
      <div class="wc-record-icon">${r.icon}</div>
      <div class="wc-record-val">${r.val}</div>
      <div class="wc-record-label">${r.label}</div>
      <div class="wc-record-detail">${r.detail}</div>
    </div>
  `).join('');
}

// ── Render rankings ──
function renderWcRankings() {
  const tbody = document.getElementById('wcRankingsBody');
  if (!tbody) return;
  tbody.innerHTML = WC_RANKINGS.map(r => `
    <tr>
      <td><span class="wc-rank-pos${r.rank <= 3 ? ' top3' : ''}">${r.rank}</span></td>
      <td style="font-family:'Barlow Condensed';font-weight:700">${r.flag} ${r.country}</td>
      <td><span class="wc-conf-badge wc-conf-${r.conf}">${r.conf}</span></td>
      <td style="color:var(--gold);font-family:'Barlow Condensed';font-weight:700">${r.pts}</td>
      <td style="text-align:center">${r.titles > 0 ? `<span style="color:var(--gold)">🏆 ${r.titles}</span>` : '<span style="color:var(--white-dim)">—</span>'}</td>
      <td style="font-size:.8rem;color:var(--white-dim)">${r.best}</td>
    </tr>
  `).join('');
}

// ── Master render for World Cup tab ──
function renderWorldCup() {
  renderWcHistory();
  renderWcChampions();
  renderWcScorers();
  renderWcHosts();
  renderWcRecords();
  renderWcRankings();
  wcFilter(wcActiveFilter, null);
}

// ============================================================
// AUTO-REFRESH ENGINE
// ============================================================
// Strategy:
//   • Full refresh on page load (always)
//   • 24-hour scheduled refresh thereafter, using localStorage
//     to track last fetch time and quota usage
//   • Smart scheduling: next refresh is midnight UTC + 1 min
//     (when API-Football resets its daily quota), OR 24h from
//     last fetch if that comes sooner
//   • Quota guard: tracks calls made today, refuses to fire a
//     full refresh if already ≥90 calls used
//   • Visibility API: if user returns to tab after being away
//     ≥ 1 hour and data is stale, refresh immediately
//   • Manual refresh button: always allowed, resets the clock
//   • Countdown display in header: shows "Next refresh in X h Ym"
//   • Stale indicator: turns the LIVE dot amber if data is >6h old

const REFRESH_INTERVAL_MS  = 24 * 60 * 60 * 1000; // 24 hours
const STALE_THRESHOLD_MS   =  6 * 60 * 60 * 1000; // 6 hours → amber pulse
const AWAY_THRESHOLD_MS    =  1 * 60 * 60 * 1000; // 1 hour away → refresh on return
const QUOTA_PER_LOAD       = 78;   // requests per full refresh (from our audit)
const QUOTA_DAILY_LIMIT    = 100;  // API-Football free tier
const QUOTA_SAFETY_MARGIN  = 90;   // refuse refresh if this many used today
const LS_LAST_FETCH        = 'fo_last_fetch';      // epoch ms
const LS_QUOTA_DATE        = 'fo_quota_date';      // YYYY-MM-DD
const LS_QUOTA_USED        = 'fo_quota_used';      // number
const LS_FETCH_COUNT       = 'fo_fetch_count';     // page-lifetime fetches

let refreshTimerId     = null;  // setInterval handle for countdown updater
let scheduledTimerId   = null;  // setTimeout handle for next auto-refresh
let isFetching         = false; // prevent concurrent full fetches
let tabHiddenAt        = null;  // timestamp when tab went hidden

// ── Quota tracking ──────────────────────────────────────────
function getTodayStr() {
  return new Date().toISOString().slice(0, 10); // YYYY-MM-DD UTC
}

function getQuotaUsedToday() {
  const date = localStorage.getItem(LS_QUOTA_DATE);
  if (date !== getTodayStr()) {
    // New UTC day — reset counter
    localStorage.setItem(LS_QUOTA_DATE, getTodayStr());
    localStorage.setItem(LS_QUOTA_USED, '0');
    return 0;
  }
  return parseInt(localStorage.getItem(LS_QUOTA_USED) || '0');
}

function recordQuotaUsed(count) {
  const today = getTodayStr();
  const existing = localStorage.getItem(LS_QUOTA_DATE) === today
    ? parseInt(localStorage.getItem(LS_QUOTA_USED) || '0')
    : 0;
  localStorage.setItem(LS_QUOTA_DATE, today);
  localStorage.setItem(LS_QUOTA_USED, String(existing + count));
}

function quotaAvailable() {
  return getQuotaUsedToday() + QUOTA_PER_LOAD <= QUOTA_SAFETY_MARGIN;
}

// ── Scheduling helpers ───────────────────────────────────────
function getLastFetchMs() {
  return parseInt(localStorage.getItem(LS_LAST_FETCH) || '0');
}

function setLastFetchMs(ts) {
  localStorage.setItem(LS_LAST_FETCH, String(ts));
}

function getDataAgeMs() {
  const last = getLastFetchMs();
  return last ? Date.now() - last : Infinity;
}

// Next midnight UTC + 60s (when AF quota resets)
function msTillMidnightUtc() {
  const now   = new Date();
  const midnight = new Date(Date.UTC(
    now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + 1,
    0, 1, 0  // 00:01 UTC
  ));
  return Math.max(midnight - now, 5 * 60 * 1000); // at least 5 min from now
}

// When should the next auto-refresh fire?
// • Prefer midnight UTC (fresh quota)
// • But cap at 24h from last fetch
function msUntilNextRefresh() {
  const sinceLastFetch = Date.now() - getLastFetchMs();
  const remainingIn24h = Math.max(0, REFRESH_INTERVAL_MS - sinceLastFetch);
  const tillMidnight   = msTillMidnightUtc();
  // Fire at whichever comes first: 24h mark or midnight UTC
  return Math.min(remainingIn24h, tillMidnight);
}

// ── UI helpers ───────────────────────────────────────────────
function setRefreshBtn(busy) {
  const btn = document.getElementById('refreshBtn');
  if (!btn) return;
  btn.disabled = busy;
  btn.textContent = busy ? '⏳ Updating…' : '🔄 Refresh';
  btn.style.opacity = busy ? '0.5' : '1';
}

function updateLastUpdatedLabel(ts) {
  const el = document.getElementById('lastUpdated');
  if (!el || !ts) return;
  const date = new Date(ts);
  const dateStr = date.toLocaleDateString('en-GB', { weekday:'short', day:'numeric', month:'short' });
  const timeStr = date.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit' });
  el.textContent = 'Updated ' + dateStr + ' ' + timeStr;
}

function updateCountdownLabel() {
  const el = document.getElementById('nextRefreshLabel');
  if (!el) return;

  const last = getLastFetchMs();
  if (!last) { el.textContent = ''; return; }

  const age = Date.now() - last;
  const msUntil = msUntilNextRefresh();

  // Stale indicator
  const dot  = document.getElementById('livePulseDot');
  const label = document.getElementById('liveLabel');
  if (age > STALE_THRESHOLD_MS) {
    if (dot)   dot.style.background = '#f5c842'; // amber — stale
    if (label) label.textContent = 'STALE';
  } else {
    if (dot)   dot.style.background = '';         // CSS var handles it
    if (label) label.textContent = 'LIVE';
  }

  // Format countdown
  const totalSec = Math.round(msUntil / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const quotaUsed = getQuotaUsedToday();
  const quotaStr = ` · ${quotaUsed}/${QUOTA_DAILY_LIMIT} calls`;

  if (msUntil < 60000) {
    el.textContent = 'Refreshing soon…' + quotaStr;
  } else if (h > 0) {
    el.textContent = `Next refresh in ${h}h ${m}m${quotaStr}`;
  } else {
    el.textContent = `Next refresh in ${m}m${quotaStr}`;
  }
}

function startCountdownTicker() {
  if (refreshTimerId) clearInterval(refreshTimerId);
  updateCountdownLabel();
  refreshTimerId = setInterval(updateCountdownLabel, 30000); // update every 30s
}

// ── Core full-fetch sequence ─────────────────────────────────
async function runFullFetch(isManual = false) {
  if (isFetching) {
    console.log('⏭ Fetch already in progress — skipping');
    return;
  }

  if (!isManual && !quotaAvailable()) {
    const used = getQuotaUsedToday();
    console.warn(`⚠️ Quota guard: ${used} calls used today, refusing auto-refresh (would reach ${used + QUOTA_PER_LOAD}/${QUOTA_DAILY_LIMIT})`);
    const el = document.getElementById('nextRefreshLabel');
    if (el) el.textContent = `Quota full today (${used}/${QUOTA_DAILY_LIMIT}) · Resets at midnight UTC`;
    // Schedule for midnight when quota resets
    scheduleNextRefresh(msTillMidnightUtc());
    return;
  }

  isFetching = true;
  setRefreshBtn(true);
  console.log('%c🔄 Football Oracle: starting full data refresh' + (isManual ? ' (manual)' : ' (scheduled)'), 'color:#f5c842;font-weight:bold');

  // Status indicators
  setStatus('fdStatus','fdLabel','Football-Data.org — Refreshing…', false);
  setStatus('afStatus','afLabel','API-Football — Refreshing…', false);

  try {
    await fetchLiveData();
    await Promise.all([fetchLiveScorers(), fetchLiveAssists()]);
    await fetchRefereeAssignments();
    await fetchAfData();
    await afFetchEuropeanFixtures();

    // Record successful fetch
    const now = Date.now();
    setLastFetchMs(now);
    recordQuotaUsed(QUOTA_PER_LOAD);
    updateLastUpdatedLabel(now);

    // Re-render any tab that needs refreshing
    const tab = state.activeTab;
    renderOverview();
    if (tab === 'fixtures')    renderFixtures();
    if (tab === 'standings')   renderStandings();
    if (tab === 'predictions') renderPredictions();
    if (tab === 'bookings')    renderBookings();
    if (tab === 'suspensions') renderSuspensions();
    if (tab === 'injuries')    renderInjuries();
    if (tab === 'europe')      renderEurope();
    if (tab === 'wrap')        renderWeekendWrap();
    if (tab === 'favourites')  { renderFavourites(); renderFavNextFixtures(); }
    renderTicker();

    console.log('%c✅ Full refresh complete', 'color:#4ade80;font-weight:bold');
  } catch(e) {
    console.error('❌ Full refresh error:', e);
  } finally {
    isFetching = false;
    setRefreshBtn(false);
    startCountdownTicker();
    scheduleNextRefresh(msUntilNextRefresh());
  }
}

// ── Scheduler ────────────────────────────────────────────────
function scheduleNextRefresh(delayMs) {
  if (scheduledTimerId) clearTimeout(scheduledTimerId);

  const fireAt = new Date(Date.now() + delayMs);
  console.log(`%c⏰ Next auto-refresh scheduled: ${fireAt.toLocaleTimeString('en-GB')} (in ${Math.round(delayMs/60000)}m)`, 'color:#a8a89a');

  scheduledTimerId = setTimeout(async () => {
    await runFullFetch(false);
  }, delayMs);
}

// ── Manual refresh ───────────────────────────────────────────
async function manualRefresh() {
  if (scheduledTimerId) clearTimeout(scheduledTimerId);
  await runFullFetch(true);
}

// ── Visibility API: refresh if returning after long absence ──
document.addEventListener('visibilitychange', async () => {
  if (document.hidden) {
    tabHiddenAt = Date.now();
    return;
  }
  // Tab became visible
  const awayFor = tabHiddenAt ? Date.now() - tabHiddenAt : 0;
  const age     = getDataAgeMs();
  tabHiddenAt = null;

  if (awayFor >= AWAY_THRESHOLD_MS && age >= AWAY_THRESHOLD_MS) {
    console.log(`%c👁 Tab visible after ${Math.round(awayFor/60000)}m away — data is ${Math.round(age/3600000*10)/10}h old → refreshing`, 'color:#f5c842');
    if (scheduledTimerId) clearTimeout(scheduledTimerId);
    await runFullFetch(false);
  } else {
    // Just resume the countdown ticker
    startCountdownTicker();
  }
});

// ── Entry point ──────────────────────────────────────────────
async function initAutoRefresh() {
  const lastFetch = getLastFetchMs();
  const age       = getDataAgeMs();

  // Always do the initial full fetch
  await runFullFetch(false);
}

// ============================================================
// ⚡ LIVE SCORES — FlashScore via Apify
// ============================================================

const liveState = {
  data: null,
  timer: null,
  countdown: null,
  refreshInterval: 5 * 60, // 5 minutes in seconds
  secondsLeft: 5 * 60,
  fetching: false,
  formData: {}, // keyed by team name
};

async function fetchLiveScores(force = false) {
  if (liveState.fetching) return;

  // Check cache
  if (!force) {
    try {
      const cached = JSON.parse(localStorage.getItem('fo_flashscore_cache') || 'null');
      if (cached && Date.now() - cached.ts < 5 * 60 * 1000) {
        liveState.data = cached.items;
        renderLiveMatches();
        return;
      }
    } catch(_) {}
  }

  liveState.fetching = true;
  document.getElementById('liveMatchesWrap').innerHTML = '<div class="live-empty"><div class="pulse-dot" style="margin:0 auto 10px;"></div>Fetching live data from FlashScore…</div>';

  try {
    const res = await fetch('/.netlify/functions/flashscore', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ leagues: [
        'england_premier-league', 'spain_laliga', 'italy_serie-a',
        'germany_bundesliga', 'france_ligue-1'
      ]})
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();

    if (json.ok && json.items) {
      liveState.data = json.items;
      localStorage.setItem('fo_flashscore_cache', JSON.stringify({ ts: Date.now(), items: json.items }));
      const el = document.getElementById('liveLastFetch');
      if (el) el.textContent = `· Last fetched ${new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'})}`;
      // DEBUG: log first item to console so we can see actual field names
      if (json.items.length) {
        console.log('[FlashScore DEBUG] First item keys:', Object.keys(json.items[0]));
        console.log('[FlashScore DEBUG] First item raw:', JSON.stringify(json.items[0], null, 2));
      }
    } else {
      throw new Error(json.error || 'No data returned');
    }
  } catch (err) {
    console.warn('Live fetch error:', err.message);
    // Fall back to cache if available even if stale
    try {
      const stale = JSON.parse(localStorage.getItem('fo_flashscore_cache') || 'null');
      if (stale) { liveState.data = stale.items; }
    } catch(_) {}
    if (!liveState.data) {
      document.getElementById('liveMatchesWrap').innerHTML =
        `<div class="live-empty">⚠️ Could not fetch live data.<br><small style="color:var(--white-dim)">${err.message}</small><br><br><button class="live-refresh-btn" onclick="fetchLiveScores(true)">Retry</button></div>`;
      liveState.fetching = false;
      return;
    }
  }

  liveState.fetching = false;
  renderLiveMatches();
}

function renderLiveMatches() {
  const wrap = document.getElementById('liveMatchesWrap');
  if (!wrap) return;

  const items = liveState.data || [];
  if (!items.length) {
    wrap.innerHTML = '<div class="live-empty">No matches found in the top 5 leagues right now.</div>';
    return;
  }

  // DEBUG: show raw first item so we can map field names
  wrap.innerHTML = `<details style="margin-bottom:16px;color:var(--white-dim);font-size:.75rem;font-family:monospace;">
    <summary style="cursor:pointer;color:var(--gold);">🔍 DEBUG: Raw first item (${items.length} total) — click to expand</summary>
    <pre style="overflow:auto;max-height:300px;background:rgba(0,0,0,.4);padding:12px;border-radius:4px;margin-top:8px;">${JSON.stringify(items[0], null, 2)}</pre>
  </details>`;

  // Apify actor confirmed field names: home_team, away_team, home_score, away_score,
  // status ("Live"), status_time ("2nd Half - 58'"), start_time, league,
  // history[] with {kind, time, score, side, player, action}
  const statusStr = m => String(m.status || '').toLowerCase();
  const live  = items.filter(m => statusStr(m) === 'live' || statusStr(m) === 'ht' || /^\d+$/.test(statusStr(m)));
  const ft    = items.filter(m => { const s = statusStr(m); return s === 'ft' || s === 'aet' || s === 'pen' || s === 'finished'; });
  const sched = items.filter(m => !live.includes(m) && !ft.includes(m));

  function matchCard(m) {
    const isLive = live.includes(m);
    const isFT   = ft.includes(m);
    const cls    = isLive ? 'live-now' : isFT ? 'finished' : 'upcoming';
    const statusCls = isLive ? 'live' : isFT ? 'ft' : 'sched';

    // status_time holds "2nd Half - 58'" for live matches
    const statusLabel = isLive
      ? (m.status_time || m.status || 'Live')
      : isFT ? 'FT' : (m.status || '—');

    // Confirmed field names
    const homeScore = m.home_score ?? '';
    const awayScore = m.away_score ?? '';
    const hasScore  = homeScore !== '' && awayScore !== '' && homeScore !== null && awayScore !== null;

    // history[] events: {kind:"event", action, player, time, side, score}
    let eventsHtml = '';
    const history = Array.isArray(m.history) ? m.history : [];
    const events  = history.filter(e => e.kind === 'event').slice(0, 8);
    if (events.length) {
      eventsHtml = '<div class="live-events">' + events.map(ev => {
        const action = String(ev.action || '').toLowerCase();
        const ecls = action.includes('goal') ? 'goal' : action.includes('red') ? 'red' : action.includes('yellow') ? 'yellow' : '';
        const icon = action.includes('goal') ? '⚽' : action.includes('red') ? '🟥' : action.includes('yellow') ? '🟨' : action.includes('subst') ? '🔄' : '📋';
        const side = ev.side === 'home' ? ' 🏠' : ev.side === 'away' ? ' ✈️' : '';
        return `<span class="live-event-pill ${ecls}">${icon}${side} ${ev.player || ''} ${ev.time ? ev.time + "'" : ''}</span>`;
      }).join('') + '</div>';
    }

    return `<div class="live-match-card ${cls}">
      <div class="live-match-header">
        <span class="live-league-tag">${m.league || '—'}</span>
        <span class="live-status-badge ${statusCls}">${statusLabel}</span>
      </div>
      <div class="live-teams">
        <div class="live-team-name home">${m.home_team || '—'}</div>
        ${hasScore
          ? `<div class="live-score">${homeScore} – ${awayScore}</div>`
          : `<div class="live-score sched">${m.start_time || '--:--'}</div>`}
        <div class="live-team-name away">${m.away_team || '—'}</div>
      </div>
      ${eventsHtml}
    </div>`;
  }

  let html = '';
  if (live.length) {
    html += `<div class="live-section-title">🔴 LIVE NOW — ${live.length} match${live.length > 1 ? 'es' : ''}</div>`;
    html += live.map(matchCard).join('');
  }
  if (sched.length) {
    html += `<div class="live-section-title">📅 UPCOMING</div>`;
    html += sched.map(matchCard).join('');
  }
  if (ft.length) {
    html += `<div class="live-section-title">✅ FULL TIME</div>`;
    html += ft.map(matchCard).join('');
  }

  wrap.innerHTML = html;
}

function startLiveCountdown() {
  clearInterval(liveState.countdown);
  liveState.secondsLeft = liveState.refreshInterval;

  liveState.countdown = setInterval(() => {
    liveState.secondsLeft--;
    const m = Math.floor(liveState.secondsLeft / 60);
    const s = liveState.secondsLeft % 60;
    const el = document.getElementById('liveCountdown');
    if (el) el.textContent = `${m}:${String(s).padStart(2, '0')}`;

    if (liveState.secondsLeft <= 0) {
      liveState.secondsLeft = liveState.refreshInterval;
      if (state.activeTab === 'live') fetchLiveScores();
    }
  }, 1000);
}

function initLiveTab() {
  fetchLiveScores();
  startLiveCountdown();
}

// ============================================================
// 🎯 ORACLE TIPS WIDGET (Overview)
// ============================================================

function renderOracleTips() {
  const el = document.getElementById('oracleTipsList');
  if (!el) return;

  const tips = (DEMO.predictions || [])
    .filter(p => p.confidence === 'high')
    .slice(0, 6);

  if (!tips.length) {
    el.innerHTML = '<div style="color:var(--white-dim);font-family:Barlow Condensed;padding:16px;">No high-confidence picks for current matchweek.</div>';
    return;
  }

  el.innerHTML = tips.map(p => `
    <div class="oracle-tip-card">
      <div class="oracle-tip-match">${p.home} <span style="color:var(--white-dim);font-weight:400;">vs</span> ${p.away}</div>
      <div class="oracle-tip-pick">🎯 ${p.pick}</div>
      <div style="display:flex;gap:8px;margin-top:4px;align-items:center;">
        <span class="oracle-tip-conf">${(LEAGUES[p.league] || {}).name || p.league}</span>
        <span style="font-size:.72rem;background:rgba(74,222,128,0.15);color:var(--accent);padding:1px 6px;border-radius:3px;font-family:'Barlow Condensed';font-weight:700;letter-spacing:1px;">HIGH</span>
        <span class="oracle-tip-conf">⚽ ${p.expGoals} xG · 🟨 ${p.expYellow}</span>
      </div>
    </div>
  `).join('');
}

// ============================================================
// 📊 FLASHSCORE FORM ENRICHMENT (Predictions)
// ============================================================

let fsFormData = {};
let fsFormLoaded = false;

async function toggleFSForm(enabled) {
  const statusEl = document.getElementById('fsFormStatus');
  if (!enabled) {
    fsFormData = {};
    fsFormLoaded = false;
    if (statusEl) statusEl.textContent = '';
    renderPredictions();
    return;
  }

  if (statusEl) statusEl.textContent = '⏳ Loading form data…';

  try {
    // Use the live cache if available, else fetch fresh
    let items = liveState.data;
    if (!items) {
      const cached = JSON.parse(localStorage.getItem('fo_flashscore_cache') || 'null');
      if (cached && Date.now() - cached.ts < 10 * 60 * 1000) {
        items = cached.items;
      }
    }

    if (!items) {
      // Fetch fresh
      const res = await fetch('/.netlify/functions/flashscore', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      });
      const json = await res.json();
      if (json.ok) {
        items = json.items;
        localStorage.setItem('fo_flashscore_cache', JSON.stringify({ ts: Date.now(), items }));
      }
    }

    // Build form map: team name → last 5 results array
    if (items) {
      fsFormData = {};
      items.forEach(m => {
        const hName  = normTeam(m.home_team || '');
        const aName  = normTeam(m.away_team || '');
        const hScore = parseInt(m.home_score ?? '');
        const aScore = parseInt(m.away_score ?? '');

        if (hName && !isNaN(hScore) && !isNaN(aScore)) {
          const hResult = hScore > aScore ? 'W' : hScore === aScore ? 'D' : 'L';
          const aResult = aScore > hScore ? 'W' : aScore === hScore ? 'D' : 'L';
          if (!fsFormData[hName]) fsFormData[hName] = [];
          if (!fsFormData[aName]) fsFormData[aName] = [];
          if (fsFormData[hName].length < 5) fsFormData[hName].unshift(hResult);
          if (fsFormData[aName].length < 5) fsFormData[aName].unshift(aResult);
        }
      });
      fsFormLoaded = true;
      if (statusEl) statusEl.textContent = `✅ Form loaded for ${Object.keys(fsFormData).length} teams`;
    } else {
      if (statusEl) statusEl.textContent = '⚠️ No data available';
    }
  } catch (err) {
    if (statusEl) statusEl.textContent = `⚠️ ${err.message}`;
    console.warn('FS form fetch error:', err);
  }

  renderPredictions();
}

function getFormBadgesHtml(teamName) {
  if (!fsFormLoaded) return '';
  const key = normTeam(teamName);
  if (!fsFormData[key]) return '';
  const results = fsFormData[key].slice(-5);
  const badges = results.map(r => `<span class="fs-form-badge ${r}">${r}</span>`).join('');
  return `<div class="fs-form-row">${badges}</div>`;
}

// ============================================================
// INIT
// ============================================================

document.addEventListener('DOMContentLoaded', () => {
  // Restore theme
  if (localStorage.getItem('theme') === 'light') {
    document.body.classList.add('light-mode');
    document.getElementById('themeBtn').textContent = '🌙 Dark';
  }

  renderTicker();
  renderOverview();
  renderInjuries();
  renderFavNextFixtures();
  
  // Fix nav tab click listeners
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
    });
  });

  // Start auto-refresh system
  setTimeout(() => initAutoRefresh(), 500);
  
  // Pre-fill API key fields from embedded keys
  document.getElementById('fdKey').value = CONFIG.fdKey;
  document.getElementById('bzKey').value = CONFIG.bzKey;

  // Status indicators — runFullFetch will update these
  setStatus('fdStatus','fdLabel','Football-Data.org — Connecting…', false);
  setStatus('bzStatus','bzLabel','Bzzoiro Sports API — Connecting…', false);
  setStatus('afStatus','afLabel','API-Football — Connecting…', false);
  updateCountdownLabel(); // show last-fetch info immediately if available
  updateLastUpdatedLabel(getLastFetchMs());

  // Register service worker for PWA offline support
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => {
        console.log('%c📱 Service Worker registered (v3)', 'color:#4ade80');
        // Listen for background sync trigger from SW
        navigator.serviceWorker.addEventListener('message', async event => {
          if (event.data?.type === 'BACKGROUND_SYNC') {
            console.log('%c🔄 Background sync triggered by SW', 'color:#f5c842');
            if (!isFetching) await runFullFetch(false);
          }
        });
        // Register periodic background sync if available (Chrome Android)
        if ('periodicSync' in reg) {
          reg.periodicSync.register('background-refresh', {
            minInterval: 24 * 60 * 60 * 1000 // once per day minimum
          }).then(() => {
            console.log('%c⏰ Periodic background sync registered (24h)', 'color:#4ade80');
          }).catch(e => {
            console.log('ℹ️ Periodic sync not available:', e.message);
          });
        }
      })
      .catch(e => console.warn('SW registration skipped:', e.message));
  }

  console.log('%c⚽ Football Oracle — 2024-25 Season Analytics', 'color:#f5c842;font-size:1.1em;font-weight:bold');
  console.log('🔑 football-data.org key:', CONFIG.fdKey ? '✓ set' : '✗ missing');
  console.log('🔑 API-Football key: ✓ embedded');
  console.log('⏰ Auto-refresh: 24h schedule with midnight UTC preference');
  console.log('🛡 Quota guard: max', QUOTA_SAFETY_MARGIN, 'calls/day (limit:', QUOTA_DAILY_LIMIT, ')');
  const lastFetch = getLastFetchMs();
  if (lastFetch) console.log('📅 Last fetch:', new Date(lastFetch).toLocaleString('en-GB'));

  // Initialise PWA install prompts (iOS hint or Android beforeinstallprompt)
  initPwa();
});
</script>
  <!-- PWA INSTALL PROMPT -->
  <div class="pwa-prompt hidden" id="pwaPrompt">
    <div class="pwa-prompt-text">
      <div class="pwa-prompt-title">⚽ Add to Home Screen</div>
      Install Football Oracle as an app — works offline too
    </div>
    <button class="pwa-install-btn" onclick="installPwa()">Install</button>
    <button class="pwa-dismiss" onclick="dismissPwa()" title="Dismiss">✕</button>
  </div>

  <!-- iOS ADD-TO-HOME-SCREEN HINT SHEET -->
  <div class="ios-hint-backdrop" id="iosHintBackdrop" onclick="dismissIosHint()"></div>
  <div class="ios-hint-sheet" id="iosHintSheet">
    <div class="ios-hint-handle"></div>
    <div class="ios-hint-title">⚽ Add Football Oracle to your Home Screen</div>
    <div class="ios-hint-sub">Get instant access — works like a native app, no App Store needed</div>
    <div class="ios-hint-steps">
      <div class="ios-hint-step">
        <div class="ios-hint-step-num">1</div>
        <div class="ios-hint-step-text">
          Tap the <span class="ios-hint-share-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#88bbff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
              <polyline points="16 6 12 2 8 6"/>
              <line x1="12" y1="2" x2="12" y2="15"/>
            </svg>
          </span> <strong>Share button</strong> at the bottom of your Safari screen
        </div>
      </div>
      <div class="ios-hint-step">
        <div class="ios-hint-step-num">2</div>
        <div class="ios-hint-step-text">
          Scroll down in the share sheet and tap <strong>"Add to Home Screen"</strong>
        </div>
      </div>
      <div class="ios-hint-step">
        <div class="ios-hint-step-num">3</div>
        <div class="ios-hint-step-text">
          Tap <strong>"Add"</strong> in the top right — Football Oracle will appear on your home screen like any app
        </div>
      </div>
    </div>
    <div class="ios-hint-footer">
      <button class="ios-hint-dismiss" onclick="dismissIosHint()">Maybe later</button>
      <label class="ios-hint-dont-show">
        <input type="checkbox" id="iosDontShow"> Don't show again
      </label>
    </div>
  </div>
  <div class="ios-hint-arrow" id="iosHintArrow"></div>

  <!-- PLAYER SEARCH OVERLAY -->
  <div class="player-search-overlay hidden" id="playerSearchOverlay" onclick="if(event.target===this)closePlayerSearch()">
    <div class="player-search-box">
      <div class="player-search-header">
        <span style="font-size:1.2rem;">🔍</span>
        <div class="player-search-input-wrap">
          <input class="player-search-big" id="playerSearchBig" placeholder="Search player name…" oninput="runPlayerSearch(this.value)" autocomplete="off">
        </div>
        <button class="player-search-close" onclick="closePlayerSearch()">✕</button>
      </div>
      <div class="player-search-results" id="playerSearchResults">
        <div class="player-search-empty">Start typing to search across all leagues</div>
      </div>
    </div>
  </div>

</body>
</html>
